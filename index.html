<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phần mềm bán hàng máy tính</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.js"></script>
</head>
<body class="bg-gray-100 font-sans text-base">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-gray-500 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded shadow-lg w-96">
            <h2 class="text-2xl font-bold mb-4 text-center">Đăng nhập</h2>
            <input id="loginUsername" class="border p-2 w-full mb-2" type="text" placeholder="Tài khoản" autofocus>
            <input id="loginPassword" class="border p-2 w-full mb-4" type="password" placeholder="Mật khẩu">
            <button class="bg-blue-500 text-white p-2 w-full rounded" onclick="login()">Đăng nhập</button>
        </div>
    </div>
    <!-- Font Size Selector, User Info, and Logout -->
    <div class="fixed top-4 right-4 z-50 flex gap-2 items-center">
        <select id="fontSizeSelect" class="border p-2 rounded bg-white" onchange="changeFontSize(this.value)">
            <option value="base">Size chữ mặc định</option>
            <option value="sm">Nhỏ</option>
            <option value="lg">Lớn</option>
        </select>
        <span id="currentUserName" class="text-gray-800 font-semibold" style="display: none;"></span>
        <button class="bg-red-500 text-white p-2 rounded" onclick="logout()">Đăng xuất</button>
    </div>
    <!-- Loading Spinner -->
    <div id="loading" class="hidden fixed inset-0 bg-gray-500 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-4 rounded shadow-lg">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto"></div>
            <p class="text-center mt-2">Đang xử lý...</p>
        </div>
    </div>
    <div class="container mx-auto p-4" id="mainContent" style="display: none;">
        <h1 class="text-3xl font-bold text-center mb-6">Phần mềm bán hàng máy tính</h1>
        <!-- Tabs -->
        <div class="flex border-b mb-4 flex-wrap" id="tabContainer">
            <button class="tab-button px-4 py-2 bg-blue-500 text-white rounded-t-md" onclick="showTab('categories')">Danh mục</button>
            <button class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('newProducts')">Sản phẩm mới</button>
            <button class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('products')">Sản phẩm</button>
            <button class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('barcode')">Mã vạch</button>
            <button class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('suppliers')">Nhà cung cấp</button>
            <button class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('customers')">Khách hàng</button>
            <button id="employeesTabButton" class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('employees')">Quản lý nhân viên</button>
            <button id="inventoryTabButton" class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('inventory')">Quản lý kho</button>
            <button class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('sales')">Bán hàng</button>
            <button class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('warranty')">Bảo hành</button>
            <button class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('reports')">Báo cáo</button>
            <button class="tab-button px-4 py-2 bg-gray-300 text-gray-800 rounded-t-md" onclick="showTab('config')">Cấu hình</button>
        </div>
        <!-- Tab Danh mục -->
        <div id="categories" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Quản lý danh mục</h2>
            <div class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Thêm/Sửa danh mục cha</h3>
                <div class="flex flex-wrap mb-2">
                    <input id="parentCategoryName" class="border p-2 mr-2 mb-2" type="text" placeholder="Tên danh mục cha">
                    <input id="parentCategoryId" type="hidden">
                    <div id="parentCustomFields" class="mb-2 w-full">
                        <div class="flex mb-2">
                            <input class="parentCustomFieldKey border p-2 mr-2" type="text" placeholder="Tên thuộc tính (VD: CPU)">
                            <button class="bg-green-500 text-white p-2 rounded" onclick="addParentCustomField()">Thêm thuộc tính</button>
                        </div>
                    </div>
                    <button id="addParentCategoryButton" class="bg-blue-500 text-white p-2 rounded" onclick="addOrUpdateParentCategory()">Thêm danh mục cha</button>
                    <button class="bg-red-500 text-white p-2 rounded ml-2" onclick="resetParentCategoryForm()">Reset</button>
                </div>
            </div>
            <div class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Danh sách danh mục cha</h3>
                <div class="text-gray-600 mb-2">Tổng danh mục cha: <span id="parentCategorySummary">0</span></div>
                <input id="searchParentCategory" class="border p-2 mb-2 w-full" type="text" placeholder="Tìm kiếm danh mục cha..." oninput="filterTable('parentCategoryTable', this.value)">
                <div class="flex items-center mb-2">
                    <label class="mr-2 text-sm font-medium">Số dòng mỗi trang:</label>
                    <select class="rowsPerPageSelect border p-1 rounded" data-table="parentCategoryTable" onchange="changeRowsPerPage(this, this.value)">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                    <label class="ml-4 mr-2 text-sm font-medium">Sắp xếp:</label>
                    <select class="sortSelect border p-1 rounded" data-table="parentCategoryTable" onchange="sortTable(this.dataset.table, this.value)">
                        <option value="none">Mặc định</option>
                        <option value="newest">Mới nhất</option>
                        <option value="oldest">Cũ nhất</option>
                    </select>
                </div>
                <table class="w-full border-collapse border">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="border p-2">Tên danh mục cha</th>
                            <th class="border p-2">Thuộc tính</th>
                            <th class="border p-2">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="parentCategoryTable"></tbody>
                </table>
                <div class="flex justify-between mt-2">
                    <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="prevPage('parentCategoryTable')" id="prevParentCategoryTable">Trang trước</button>
                    <span id="pageInfoParentCategoryTable"></span>
                    <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="nextPage('parentCategoryTable')" id="nextParentCategoryTable">Trang sau</button>
                </div>
            </div>
        </div>
        <!-- Tab Sản phẩm mới -->
        <div id="newProducts" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Quản lý sản phẩm mới</h2>
            <div class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Thêm sản phẩm mới</h3>
                <div class="flex flex-wrap gap-2 mb-3">
                    <div class="w-48">
                        <label class="block text-sm font-medium">Tên sản phẩm:</label>
                        <input id="newProductName" class="border p-2 w-full" type="text" placeholder="Tên sản phẩm mới">
                    </div>
                    <div class="w-48">
                        <label class="block text-sm font-medium">Danh mục cha:</label>
                        <select id="parentCategory" class="border p-2 w-full" onchange="loadParentCategoryAttributes()">
                            <option value="">Không có danh mục cha</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">Thuộc tính sản phẩm:</label>
                    <div id="attributesContainer" class="space-y-2"></div>
                </div>
                <div class="flex gap-2">
                    <button class="bg-blue-500 text-white p-2 rounded" onclick="addNewProduct()">Thêm sản phẩm mới</button>
                    <button class="bg-red-500 text-white p-2 rounded" onclick="resetNewProductForm()">Reset</button>
                </div>
            </div>
            <div class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Danh sách sản phẩm mới</h3>
                <div class="text-gray-600 mb-2">Tổng sản phẩm mới: <span id="newProductSummary">0</span></div>
                <input id="searchNewProduct" class="border p-2 mb-2 w-full" type="text" placeholder="Tìm kiếm sản phẩm theo tên hoặc thuộc tính..." oninput="filterNewProductsTable(this.value)">
                <div class="flex items-center mb-2">
                    <label class="mr-2 text-sm font-medium">Số dòng mỗi trang:</label>
                    <select class="rowsPerPageSelect border p-1 rounded" data-table="newProductTable" onchange="changeRowsPerPage(this, this.value)">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                    <label class="ml-4 mr-2 text-sm font-medium">Sắp xếp:</label>
                    <select class="sortSelect border p-1 rounded" data-table="newProductTable" onchange="sortTable(this.dataset.table, this.value)">
                        <option value="none">Mặc định</option>
                        <option value="newest">Mới nhất</option>
                        <option value="oldest">Cũ nhất</option>
                    </select>
                </div>
                <table class="w-full border-collapse border">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="border p-2">Tên sản phẩm</th>
                            <th class="border p-2">Danh mục cha</th>
                            <th class="border p-2">Thuộc tính</th>
                            <th class="border p-2">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="newProductTable"></tbody>
                </table>
                <div class="flex justify-between mt-2">
                    <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="prevPage('newProductTable')" id="prevNewProductTable">Trang trước</button>
                    <span id="pageInfoNewProductTable"></span>
                    <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="nextPage('newProductTable')" id="nextNewProductTable">Trang sau</button>
                </div>
            </div>
        </div>
        <!-- Tab Sản phẩm -->
        <div id="products" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Quản lý sản phẩm</h2>
            <div class="bg-white p-3 rounded shadow">
                <!-- Hàng đầu tiên: Tỷ giá, Số thứ tự, Giá gốc, Giá bán, Mã vạch -->
                <div class="flex flex-wrap gap-2 mb-3">
                    <div class="w-[120px]">
                        <label class="block text-sm font-medium">Tỷ giá USD:</label>
                        <input id="usdExchangeRate" class="border p-1 w-full rounded" type="number" step="0.01" oninput="calculateCostPrice()">
                    </div>
                    <div class="w-[120px]">
                        <label class="block text-sm font-medium">Số thứ tự:</label>
                        <input id="productSerialNumber" class="border p-1 w-full rounded bg-gray-100" type="number" readonly>
                    </div>
                    <div class="w-[120px]" id="costPriceDiv">
                        <label class="block text-sm font-medium">Giá gốc (VNĐ):</label>
                        <input id="productCostPrice" class="border p-1 w-full rounded bg-gray-100" type="number" readonly>
                    </div>
                    <div class="w-[120px]">
                        <label class="block text-sm font-medium">Giá bán (VNĐ):</label>
                        <input id="productSellingPrice" class="border p-1 w-full rounded bg-gray-100" type="number" readonly>
                    </div>
                    <div class="w-[120px]">
                        <label class="block text-sm font-medium">Mã vạch:</label>
                        <input id="productBarcode" class="border p-1 w-full rounded bg-gray-100" type="text" readonly style="width: 5cm;">
                    </div>
                </div>
                <!-- Hàng thứ hai: Tên sản phẩm, Mã tracking, Giá web (với select VND/USD), Nhà cung cấp, Bảo hành, Số lượng, Loại nhập, Thời hạn sử dụng, Ảnh -->
                <div class="flex flex-wrap gap-2 mb-3 items-end">
                    <div class="w-48">
                        <label class="block text-sm font-medium">Tên sản phẩm:</label>
                        <select id="productName" class="border p-1 w-full rounded" onchange="updateBarcode(); loadProductAttributes(this.value)"></select>
                    </div>
                    <div class="w-48">
                        <label class="block text-sm font-medium">Mã tracking:</label>
                        <input id="productTrackingCode" class="border p-1 w-full rounded" type="text" oninput="updateBarcode()" value="00000">
                    </div>
                    <div class="w-48">
                        <label class="block text-sm font-medium">Giá web:</label>
                        <div class="flex gap-2">
                            <select id="currencyType" class="border p-1 rounded" onchange="updateWebPriceLabel(); calculateCostPrice()">
                                <option value="USD" selected>USD</option>
                                <option value="VND">VND</option>
                            </select>
                            <input id="productWebPrice" class="border p-1 flex-1 rounded" type="number" step="0.01" oninput="calculateCostPrice()">
                        </div>
                    </div>
                    <div class="w-48">
                        <label class="block text-sm font-medium">Nhà cung cấp:</label>
                        <select id="productSupplier" class="border p-1 w-full rounded"></select>
                    </div>
                    <div style="width: 1.5cm">
                        <label class="block text-sm font-medium">Bảo hành:</label>
                        <input id="productWarranty" class="border p-1 w-full rounded" type="number" value="6">
                    </div>
                    <div class="flex items-end gap-2">
                        <div style="width: 1.5cm">
                            <label class="block text-sm font-medium">Số lượng:</label>
                            <input id="productInitialStock" class="border p-1 w-full rounded" type="number" min="1" value="1">
                        </div>
                        <div class="w-48">
                            <label class="block text-sm font-medium">Loại nhập:</label>
                            <select id="entryType" class="border p-1 w-full rounded">
                                <option value="batch">Theo lô</option>
                                <option value="individual" selected>Theo từng sản phẩm</option>
                            </select>
                        </div>
                    </div>
                    <div class="w-48">
                        <label class="block text-sm font-medium">Thời hạn sử dụng:</label>
                        <input id="productExpiration" class="border p-1 w-full rounded" type="date">
                    </div>
                    <div class="w-48">
                        <label class="block text-sm font-medium">Ảnh sản phẩm:</label>
                        <input id="productImage" class="border p-1 w-full rounded" type="file" accept="image/*">
                        <img id="productImagePreview" class="mt-2 w-20 h-20 object-cover" src="" alt="Preview" style="display: none;">
                    </div>
                    <div class="w-48">
                        <label class="block text-sm font-medium">Trạng thái:</label>
                        <div class="flex gap-4">
                            <label><input type="radio" name="productCondition" value="Mới" checked> Mới</label>
                            <label><input type="radio" name="productCondition" value="Cũ"> Cũ</label>
                        </div>
                    </div>
                    <input id="productId" type="hidden">
                </div>
                <!-- Thuộc tính sản phẩm: Văn bản chìm dưới nền, không sửa -->
                <div class="flex flex-wrap gap-2 mb-3">
                    <label class="block text-sm font-medium mb-1 w-full">Thuộc tính sản phẩm:</label>
                    <div id="productAttributes" class="border p-1 rounded bg-gray-100 text-gray-600" style="width: 10cm; min-width: 400px; height: 4rem; overflow-y: auto;"></div>
                </div>
                <!-- Chi phí phát sinh -->
                <div class="mt-3">
                    <h3 class="text-sm font-medium mb-1">Chi phí phát sinh</h3>
                    <div class="flex flex-wrap gap-2">
                        <div style="width: 3cm">
                            <label class="block text-sm font-medium">Phí ship:</label>
                            <input id="productShippingCost" class="border p-1 w-full rounded" type="number" step="0.01" oninput="calculateCostPrice()">
                        </div>
                    </div>
                    <div id="costFields" class="flex flex-wrap gap-2 mt-2">
                        <div class="flex gap-2">
                            <input class="costDescription border p-1 w-[120px] rounded" type="text" placeholder="Mô tả chi phí 1">
                            <input class="costValue border p-1 w-[120px] rounded" type="number" placeholder="VNĐ" step="0.01" oninput="calculateCostPrice()">
                        </div>
                        <div class="flex gap-2">
                            <input class="costDescription border p-1 w-[120px] rounded" type="text" placeholder="Mô tả chi phí 2">
                            <input class="costValue border p-1 w-[120px] rounded" type="number" placeholder="VNĐ" step="0.01" oninput="calculateCostPrice()">
                        </div>
                        <div class="flex gap-2">
                            <input class="costDescription border p-1 w-[120px] rounded" type="text" placeholder="Mô tả chi phí 3">
                            <input class="costValue border p-1 w-[120px] rounded" type="number" placeholder="VNĐ" step="0.01" oninput="calculateCostPrice()">
                        </div>
                        <div class="flex gap-2">
                            <input class="costDescription border p-1 w-[120px] rounded" type="text" placeholder="Mô tả chi phí 4">
                            <input class="costValue border p-1 w-[120px] rounded" type="number" placeholder="VNĐ" step="0.01" oninput="calculateCostPrice()">
                        </div>
                    </div>
                </div>
                <!-- Nút hành động -->
                <div class="mt-3 flex gap-2">
                    <button id="addProductButton" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600" onclick="addOrUpdateProduct()">Thêm sản phẩm</button>
                    <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" onclick="resetProductForm()">Reset</button>
                </div>
            </div>
            <!-- Tìm kiếm và lựa chọn số dòng mỗi trang -->
            <input id="searchProduct" class="border p-2 mb-2 w-full" type="text" placeholder="Tìm kiếm sản phẩm (e.g., CPU:i7 or name)" oninput="filterProductTable(this.value)">
            <div class="flex items-center mb-2">
                <input type="checkbox" id="showInStockOnly" onchange="filterProductTable(document.getElementById('searchProduct').value)">
                <label class="ml-2 text-sm font-medium">Chỉ hiển thị sản phẩm còn hàng</label>
                <label class="mr-2 ml-4 text-sm font-medium">Số dòng mỗi trang:</label>
                <select class="rowsPerPageSelect border p-1 rounded" data-table="productTable" onchange="changeRowsPerPage(this, this.value)">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <label class="ml-4 mr-2 text-sm font-medium">Sắp xếp:</label>
                <select class="sortSelect border p-1 rounded" data-table="productTable" onchange="sortTable(this.dataset.table, this.value)">
                    <option value="none">Mặc định</option>
                    <option value="newest">Mới nhất</option>
                    <option value="oldest">Cũ nhất</option>
                </select>
            </div>
            <div class="text-gray-600 mb-2">Tổng sản phẩm: <span id="productSummary">0</span> | Tổng giá trị tồn kho: <span id="productValueSummary">0 VNĐ</span></div>
            <!-- Nút tác vụ cho nhiều dòng -->
            <div class="flex gap-2 mb-2">
                <button class="bg-purple-500 text-white p-2 rounded" onclick="prepareBarcodeTab()">In mã vạch</button>
                <button class="bg-red-500 text-white p-2 rounded" onclick="deleteSelectedProducts()">Xóa</button>
                <button class="bg-green-500 text-white p-2 rounded" onclick="sellSelectedProducts()">Bán</button>
            </div>
            <!-- Bảng sản phẩm -->
            <table class="w-full border-collapse border mt-3 text-sm">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border p-1"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                        <th class="border p-1">Ảnh</th>
                        <th class="border p-1">Số thứ tự</th>
                        <th class="border p-1">Tên</th>
                        <th class="border p-1">Thuộc tính</th>
                        <th class="border p-1">Trạng thái</th>
                        <th class="border p-1">Mã vạch</th>
                        <th class="border p-1">Mã tracking</th>
                        <th class="border p-1">Giá web (USD)</th>
                        <th class="border p-1">Chi phí vận chuyển</th>
                        <th class="border p-1">Chi phí phát sinh</th>
                        <th class="border p-1" id="costPriceHeader">Giá gốc</th>
                        <th class="border p-1">Giá bán</th>
                        <th class="border p-1">Nhà cung cấp</th>
                        <th class="border p-1">Bảo hành</th>
                        <th class="border p-1">Tồn kho</th>
                        <th class="border p-1">Hành động</th>
                    </tr>
                </thead>
                <tbody id="productTable"></tbody>
            </table>
            <div class="flex justify-between mt-2">
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="prevPage('productTable')" id="prevProductTable">Trang trước</button>
                <span id="pageInfoProductTable"></span>
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="nextPage('productTable')" id="nextProductTable">Trang sau</button>
            </div>
        </div>
        <!-- Tab Mã vạch -->
        <div id="barcode" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Quản lý mã vạch</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- 2/3 bên trái: Config and Selected Products -->
                <div class="md:col-span-2 bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-2">Sản phẩm được chọn để in</h3>
                    <!-- Nút thêm sản phẩm -->
                    <div class="mb-4">
                        <button class="bg-blue-500 text-white p-2 rounded" onclick="addProductToBarcodeList()">Thêm sản phẩm</button>
                    </div>
                    <table class="w-full border-collapse border mb-4">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border p-2">Tên sản phẩm</th>
                                <th class="border p-2">Mã vạch</th>
                                <th class="border p-2">Số lượng in</th>
                                <th class="border p-2">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="selectedBarcodeTable"></tbody>
                    </table>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Khổ giấy:</label>
                            <select id="barcodePaperSize" class="border p-2 w-full rounded">
                                <option value="46x34">46x34mm</option>
                                <option value="50x30">50x30mm</option>
                                <option value="35x22">35x22mm</option>
                                <option value="50x50">50x50mm</option>
                                <option value="50x70">50x70mm</option>
                                <option value="70x22">70x22mm</option>
                                <option value="custom">Tùy chỉnh</option>
                            </select>
                        </div>
                        <div id="customSizeDiv" class="hidden">
                            <label class="block text-sm font-medium mb-1">Kích thước tùy chỉnh (mm):</label>
                            <div class="flex gap-2">
                                <input id="customWidth" class="border p-2 flex-1" type="number" placeholder="Chiều rộng">
                                <input id="customHeight" class="border p-2 flex-1" type="number" placeholder="Chiều cao">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Số mã vạch trên trang:</label>
                            <select id="barcodesPerPage" class="border p-2 w-full rounded">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="6">6</option>
                                <option value="8">8</option>
                                <option value="custom">Tùy chỉnh</option>
                            </select>
                        </div>
                        <div id="customLayoutDiv" class="hidden">
                            <label class="block text-sm font-medium mb-1">Số cột x hàng:</label>
                            <div class="flex gap-2">
                                <input id="customColumns" class="border p-2 flex-1" type="number" min="1" placeholder="Số cột">
                                <input id="customRows" class="border p-2 flex-1" type="number" min="1" placeholder="Số hàng">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Khoảng cách (mm):</label>
                            <div class="flex gap-2">
                                <input id="marginTop" class="border p-2 flex-1" type="number" placeholder="Trên" value="5">
                                <input id="marginBottom" class="border p-2 flex-1" type="number" placeholder="Dưới" value="5">
                                <input id="marginLeft" class="border p-2 flex-1" type="number" placeholder="Trái" value="5">
                                <input id="marginRight" class="border p-2 flex-1" type="number" placeholder="Phải" value="5">
                            </div>
                        </div>
                    </div>
                    <!-- Bảng tùy chọn hiển thị chuyên nghiệp -->
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2">Tùy chỉnh hiển thị (mỗi thông tin)</h3>
                        <table class="w-full border-collapse border">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="border p-2">Thông tin</th>
                                    <th class="border p-2">Hiển thị</th>
                                    <th class="border p-2">Size chữ</th>
                                    <th class="border p-2">Đậm</th>
                                    <th class="border p-2">Nghiêng</th>
                                    <th class="border p-2">Khoảng cách dưới (mm)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="border p-2">Tên cửa hàng</td>
                                    <td class="border p-2"><input type="checkbox" id="showStoreName" checked></td>
                                    <td class="border p-2">
                                        <select id="storeNameSize">
                                            <option value="10">Small (10px)</option>
                                            <option value="12" selected>Medium (12px)</option>
                                            <option value="14">Large (14px)</option>
                                        </select>
                                    </td>
                                    <td class="border p-2"><input type="checkbox" id="storeNameBold"></td>
                                    <td class="border p-2"><input type="checkbox" id="storeNameItalic"></td>
                                    <td class="border p-2"><input type="number" id="storeNameMargin" value="1" class="border p-1 w-16 rounded"></td>
                                </tr>
                                <tr>
                                    <td class="border p-2">Tên sản phẩm</td>
                                    <td class="border p-2"><input type="checkbox" id="showProductName" checked></td>
                                    <td class="border p-2">
                                        <select id="productNameSize">
                                            <option value="10">Small (10px)</option>
                                            <option value="12" selected>Medium (12px)</option>
                                            <option value="14">Large (14px)</option>
                                        </select>
                                    </td>
                                    <td class="border p-2"><input type="checkbox" id="productNameBold"></td>
                                    <td class="border p-2"><input type="checkbox" id="productNameItalic"></td>
                                    <td class="border p-2"><input type="number" id="productNameMargin" value="1" class="border p-1 w-16 rounded"></td>
                                </tr>
                                <tr>
                                    <td class="border p-2">Mã vạch</td>
                                    <td class="border p-2"><input type="checkbox" id="showBarcode" checked></td>
                                    <td class="border p-2">
                                        <select id="barcodeSize">
                                            <option value="10">Small (10px)</option>
                                            <option value="12" selected>Medium (12px)</option>
                                            <option value="14">Large (14px)</option>
                                        </select>
                                    </td>
                                    <td class="border p-2"><input type="checkbox" id="barcodeBold"></td>
                                    <td class="border p-2"><input type="checkbox" id="barcodeItalic"></td>
                                    <td class="border p-2"><input type="number" id="barcodeMargin" value="1" class="border p-1 w-16 rounded"></td>
                                </tr>
                                <tr>
                                    <td class="border p-2">Số mã vạch</td>
                                    <td class="border p-2"><input type="checkbox" id="showBarcodeNumber" checked></td>
                                    <td class="border p-2">
                                        <select id="barcodeNumberSize">
                                            <option value="10" selected>Small (10px)</option>
                                            <option value="12">Medium (12px)</option>
                                            <option value="14">Large (14px)</option>
                                        </select>
                                    </td>
                                    <td class="border p-2"><input type="checkbox" id="barcodeNumberBold"></td>
                                    <td class="border p-2"><input type="checkbox" id="barcodeNumberItalic"></td>
                                    <td class="border p-2"><input type="number" id="barcodeNumberMargin" value="1" class="border p-1 w-16 rounded"></td>
                                </tr>
                                <tr>
                                    <td class="border p-2">Giá bán</td>
                                    <td class="border p-2"><input type="checkbox" id="showSellingPrice"></td>
                                    <td class="border p-2">
                                        <select id="sellingPriceSize">
                                            <option value="10">Small (10px)</option>
                                            <option value="12" selected>Medium (12px)</option>
                                            <option value="14">Large (14px)</option>
                                        </select>
                                    </td>
                                    <td class="border p-2"><input type="checkbox" id="sellingPriceBold"></td>
                                    <td class="border p-2"><input type="checkbox" id="sellingPriceItalic"></td>
                                    <td class="border p-2"><input type="number" id="sellingPriceMargin" value="1" class="border p-1 w-16 rounded"></td>
                                </tr>
                            </tbody>
                        </table>
                        <button class="bg-red-500 text-white p-2 rounded mt-2" onclick="resetBarcodeOptions()">Reset tùy chọn</button>
                    </div>
                    <div class="mb-4">
                        <button class="bg-blue-500 text-white p-2 rounded mr-2" onclick="generateBarcodePreview()">Xem trước</button>
                        <button class="bg-green-500 text-white p-2 rounded" onclick="printBarcodes()">In</button>
                    </div>
                </div>
                <!-- 1/3 bên phải: Xem trước mã vạch -->
                <div class="md:col-span-1 bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-2">Xem trước mã vạch</h3>
                    <div id="barcodePreviewContainer" class="border p-4 bg-gray-100 overflow-auto max-h-96"></div>
                </div>
            </div>
        </div>
        <!-- Tab Nhà cung cấp -->
        <div id="suppliers" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Quản lý nhà cung cấp</h2>
            <div class="mb-4">
                <input id="supplierName" class="border p-2 mr-2" type="text" placeholder="Tên nhà cung cấp">
                <input id="supplierAddress" class="border p-2 mr-2" type="text" placeholder="Địa chỉ">
                <input id="supplierPhone" class="border p-2 mr-2" type="text" placeholder="Số điện thoại">
                <input id="supplierEmail" class="border p-2 mr-2" type="text" placeholder="Email">
                <button class="bg-blue-500 text-white p-2 rounded" onclick="addOrUpdateSupplier()">Thêm/Cập nhật nhà cung cấp</button>
                <button class="bg-red-500 text-white p-2 rounded ml-2" onclick="resetSupplierForm()">Reset</button>
                <input id="supplierId" type="hidden">
            </div>
            <input id="searchSupplier" class="border p-2 mb-2 w-full" type="text" placeholder="Tìm kiếm nhà cung cấp..." oninput="filterTable('supplierTable', this.value)">
            <div class="text-gray-600 mb-2">Tổng nhà cung cấp: <span id="supplierSummary">0</span></div>
            <div class="flex items-center mb-2">
                <label class="mr-2 text-sm font-medium">Số dòng mỗi trang:</label>
                <select class="rowsPerPageSelect border p-1 rounded" data-table="supplierTable" onchange="changeRowsPerPage(this, this.value)">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <label class="ml-4 mr-2 text-sm font-medium">Sắp xếp:</label>
                <select class="sortSelect border p-1 rounded" data-table="supplierTable" onchange="sortTable(this.dataset.table, this.value)">
                    <option value="none">Mặc định</option>
                    <option value="newest">Mới nhất</option>
                    <option value="oldest">Cũ nhất</option>
                </select>
            </div>
            <table class="w-full border-collapse border">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border p-2">Tên</th>
                        <th class="border p-2">Địa chỉ</th>
                        <th class="border p-2">Số điện thoại</th>
                        <th class="border p-2">Email</th>
                        <th class="border p-2">Hành động</th>
                    </tr>
                </thead>
                <tbody id="supplierTable"></tbody>
            </table>
            <div class="flex justify-between mt-2">
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="prevPage('supplierTable')" id="prevSupplierTable">Trang trước</button>
                <span id="pageInfoSupplierTable"></span>
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="nextPage('supplierTable')" id="nextSupplierTable">Trang sau</button>
            </div>
        </div>
        <!-- Tab Khách hàng -->
        <div id="customers" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Quản lý khách hàng</h2>
            <div class="mb-4">
                <input id="customerName" class="border p-2 mr-2" type="text" placeholder="Tên khách hàng">
                <input id="customerPhone" class="border p-2 mr-2" type="text" placeholder="Số điện thoại">
                <input id="customerAddress" class="border p-2 mr-2" type="text" placeholder="Địa chỉ">
                <input id="customerFacebook" class="border p-2 mr-2" type="text" placeholder="Facebook">
                <input id="customerNote" class="border p-2 mr-2" type="text" placeholder="Ghi chú">
                <button class="bg-blue-500 text-white p-2 rounded" onclick="addOrUpdateCustomer()">Thêm/Cập nhật khách hàng</button>
                <button class="bg-red-500 text-white p-2 rounded ml-2" onclick="resetCustomerForm()">Reset</button>
                <input id="customerId" type="hidden">
            </div>
            <input id="searchCustomer" class="border p-2 mb-2 w-full" type="text" placeholder="Tìm kiếm khách hàng..." oninput="filterTable('customerTable', this.value)">
            <div class="text-gray-600 mb-2">Tổng khách hàng: <span id="customerSummary">0</span> | Tổng sản phẩm mua: <span id="customerPurchaseSummary">0</span></div>
            <div class="flex items-center mb-2">
                <label class="mr-2 text-sm font-medium">Số dòng mỗi trang:</label>
                <select class="rowsPerPageSelect border p-1 rounded" data-table="customerTable" onchange="changeRowsPerPage(this, this.value)">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <label class="ml-4 mr-2 text-sm font-medium">Sắp xếp:</label>
                <select class="sortSelect border p-1 rounded" data-table="customerTable" onchange="sortTable(this.dataset.table, this.value)">
                    <option value="none">Mặc định</option>
                    <option value="newest">Mới nhất</option>
                    <option value="oldest">Cũ nhất</option>
                </select>
            </div>
            <table class="w-full border-collapse border">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border p-2">Tên</th>
                        <th class="border p-2">Số điện thoại</th>
                        <th class="border p-2">Địa chỉ</th>
                        <th class="border p-2">Facebook</th>
                        <th class="border p-2">Ghi chú</th>
                        <th class="border p-2">Số lượng sản phẩm mua</th>
                        <th class="border p-2">Hành động</th>
                    </tr>
                </thead>
                <tbody id="customerTable"></tbody>
            </table>
            <div class="flex justify-between mt-2">
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="prevPage('customerTable')" id="prevCustomerTable">Trang trước</button>
                <span id="pageInfoCustomerTable"></span>
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="nextPage('customerTable')" id="nextCustomerTable">Trang sau</button>
            </div>
        </div>
        <!-- Tab Quản lý nhân viên -->
        <div id="employees" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Quản lý nhân viên</h2>
            <div class="mb-4">
                <input id="employeeName" class="border p-2 mr-2" type="text" placeholder="Tên nhân viên">
                <select id="employeePosition" class="border p-2 mr-2">
                    <option value="admin">Admin</option>
                    <option value="phụ trách">Phụ trách</option>
                    <option value="nhân viên">Nhân viên</option>
                </select>
                <input id="employeePhone" class="border p-2 mr-2" type="text" placeholder="Số điện thoại">
                <input id="employeeUsername" class="border p-2 mr-2" type="text" placeholder="Tài khoản đăng nhập">
                <input id="employeePassword" class="border p-2 mr-2" type="password" placeholder="Mật khẩu">
                <div class="flex flex-wrap gap-2 mt-2" id="employeeRights">
                    <div class="flex items-center">
                        <input type="checkbox" id="readOnly" onchange="toggleRights()">
                        <label class="ml-2">Chỉ xem</label>
                    </div>
                    <div class="rights-group flex items-center">
                        <input type="checkbox" id="manageProducts">
                        <label class="ml-2">Sửa/Xóa sản phẩm</label>
                    </div>
                    <div class="rights-group flex items-center">
                        <input type="checkbox" id="manageInvoices">
                        <label class="ml-2">Sửa/Xóa hóa đơn</label>
                    </div>
                    <div class="rights-group flex items-center">
                        <input type="checkbox" id="manageEmployees">
                        <label class="ml-2">Thêm/Sửa nhân viên</label>
                    </div>
                    <div class="rights-group flex items-center">
                        <input type="checkbox" id="manageCustomers">
                        <label class="ml-2">Thêm/Sửa khách hàng</label>
                    </div>
                    <div class="rights-group flex items-center">
                        <input type="checkbox" id="manageSales">
                        <label class="ml-2">Bán hàng</label>
                    </div>
                    <div class="rights-group flex items-center">
                        <input type="checkbox" id="viewCostPrice">
                        <label class="ml-2">Xem giá gốc</label>
                    </div>
                    <div class="rights-group flex items-center">
                        <input type="checkbox" id="viewAdminInvoices">
                        <label class="ml-2">Xem hóa đơn của admin</label>
                    </div>
                </div>
                <button class="bg-blue-500 text-white p-2 rounded" onclick="addOrUpdateEmployee()">Thêm/Cập nhật nhân viên</button>
                <button class="bg-red-500 text-white p-2 rounded ml-2" onclick="resetEmployeeForm()">Reset</button>
                <input id="employeeId" type="hidden">
            </div>
            <input id="searchEmployee" class="border p-2 mb-2 w-full" type="text" placeholder="Tìm kiếm nhân viên..." oninput="filterTable('employeeTable', this.value)">
            <div class="text-gray-600 mb-2">Tổng nhân viên: <span id="employeeSummary">0</span></div>
            <div class="flex items-center mb-2">
                <label class="mr-2 text-sm font-medium">Số dòng mỗi trang:</label>
                <select class="rowsPerPageSelect border p-1 rounded" data-table="employeeTable" onchange="changeRowsPerPage(this, this.value)">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <label class="ml-4 mr-2 text-sm font-medium">Sắp xếp:</label>
                <select class="sortSelect border p-1 rounded" data-table="employeeTable" onchange="sortTable(this.dataset.table, this.value)">
                    <option value="none">Mặc định</option>
                    <option value="newest">Mới nhất</option>
                    <option value="oldest">Cũ nhất</option>
                </select>
            </div>
            <table class="w-full border-collapse border">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border p-2">Tên</th>
                        <th class="border p-2">Chức vụ</th>
                        <th class="border p-2">Số điện thoại</th>
                        <th class="border p-2">Tài khoản</th>
                        <th class="border p-2">Mật khẩu</th>
                        <th class="border p-2">Quyền</th>
                        <th class="border p-2">Hành động</th>
                    </tr>
                </thead>
                <tbody id="employeeTable"></tbody>
            </table>
            <div class="flex justify-between mt-2">
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="prevPage('employeeTable')" id="prevEmployeeTable">Trang trước</button>
                <span id="pageInfoEmployeeTable"></span>
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="nextPage('employeeTable')" id="nextEmployeeTable">Trang sau</button>
            </div>
        </div>
        <!-- Tab Quản lý kho -->
        <div id="inventory" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Quản lý kho</h2>
            <div class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Nhập kho</h3>
                <select id="inventoryProduct" class="border p-2 mr-2"></select>
                <input id="inventoryQuantity" class="border p-2 mr-2" type="number" placeholder="Số lượng nhập">
                <input id="inventoryReason" class="border p-2 mr-2" type="text" placeholder="Lý do (tùy chọn)">
                <button class="bg-blue-500 text-white p-2 rounded" onclick="addInventoryEntry()">Nhập kho</button>
                <button class="bg-red-500 text-white p-2 rounded ml-2" onclick="resetInventoryForm()">Reset</button>
            </div>
            <h3 class="text-lg font-semibold mb-2">Lịch sử tồn kho</h3>
            <div class="text-gray-600 mb-2">Tổng lịch sử: <span id="inventorySummary">0</span></div>
            <input id="searchInventory" class="border p-2 mb-2 w-full" type="text" placeholder="Tìm kiếm lịch sử kho..." oninput="filterTable('inventoryTable', this.value)">
            <div class="flex items-center mb-2">
                <label class="mr-2 text-sm font-medium">Số dòng mỗi trang:</label>
                <select class="rowsPerPageSelect border p-1 rounded" data-table="inventoryTable" onchange="changeRowsPerPage(this, this.value)">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <label class="ml-4 mr-2 text-sm font-medium">Sắp xếp:</label>
                <select class="sortSelect border p-1 rounded" data-table="inventoryTable" onchange="sortTable(this.dataset.table, this.value)">
                    <option value="none">Mặc định</option>
                    <option value="newest">Mới nhất</option>
                    <option value="oldest">Cũ nhất</option>
                </select>
            </div>
            <table class="w-full border-collapse border">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border p-2">Ngày</th>
                        <th class="border p-2">Sản phẩm</th>
                        <th class="border p-2">Thay đổi số lượng</th>
                        <th class="border p-2">Lý do</th>
                    </tr>
                </thead>
                <tbody id="inventoryTable"></tbody>
            </table>
            <div class="flex justify-between mt-2">
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="prevPage('inventoryTable')" id="prevInventoryTable">Trang trước</button>
                <span id="pageInfoInventoryTable"></span>
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="nextPage('inventoryTable')" id="nextInventoryTable">Trang sau</button>
            </div>
        </div>
        <!-- Tab Bán hàng -->
        <div id="sales" class="tab-content hidden flex flex-col md:flex-row gap-4">
            <div class="w-full md:w-1/2">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Quản lý bán hàng</h2>
                    <div class="flex gap-2 mb-4">
                        <button class="bg-green-500 text-white p-2 rounded" onclick="resetSaleForm()">Thêm đơn hàng</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Khách hàng:</label>
                            <div class="flex">
                                <select id="saleCustomer" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200"></select>
                                <button class="bg-green-500 text-white p-2 rounded ml-2" onclick="openAddCustomerModal()">+</button>
                            </div>
                            <p id="customerPhoneDisplay" class="text-sm text-gray-600 mt-1"></p>
                            <p id="customerAddressDisplay" class="text-sm text-gray-600 mt-1"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Nhân viên:</label>
                            <select id="saleEmployee" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200">
                                <option value="1">Nhân viên mặc định</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Tìm kiếm sản phẩm:</label>
                        <div class="relative">
                            <select id="productSearch" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200"></select>
                            <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2">Giỏ hàng</h3>
                        <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                            <thead class="bg-blue-100 text-blue-800">
                                <tr>
                                    <th class="border p-2 text-left">Ảnh</th>
                                    <th class="border p-2 text-left">Sản phẩm</th>
                                    <th class="border p-2 text-left">Thuộc tính</th>
                                    <th class="border p-2 text-left">Bảo hành (tháng)</th>
                                    <th class="border p-2 text-left">Số lượng</th>
                                    <th class="border p-2 text-left">Giảm giá (%)</th>
                                    <th class="border p-2 text-left">Thành tiền</th>
                                    <th class="border p-2 text-left">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="cartTableBody"></tbody>
                        </table>
                        <p class="mt-2 text-right font-bold text-lg text-blue-600" id="cartTotal">Tổng: 0 VNĐ</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Hình thức thanh toán:</label>
                            <select id="paymentMethod" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" onchange="togglePaidInput()">
                                <option value="tiền mặt">Tiền mặt 💰</option>
                                <option value="chuyển khoản">Chuyển khoản 🏦</option>
                                <option value="trả góp">Trả góp 💳</option>
                                <option value="trả nợ">Trả nợ một phần 📝</option>
                            </select>
                        </div>
                        <div id="paidAmountDiv" class="hidden">
                            <label class="block text-sm font-medium mb-1">Số tiền trả:</label>
                            <input id="paidAmount" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" type="number" step="0.01" value="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Giảm giá toàn hóa đơn (%):</label>
                            <input id="globalDiscount" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" type="number" min="0" max="100" value="0" oninput="updateCartTable()">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Khuyến mãi kèm theo:</label>
                        <input id="promotion" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" type="text">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Ghi chú hóa đơn:</label>
                        <textarea id="saleNote" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" rows="3"></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button id="createSaleButton" class="bg-blue-600 text-white p-2 rounded flex-1 hover:bg-blue-700 transition" onclick="createSale()">Tạo hóa đơn</button>
                        <button class="bg-yellow-600 text-white p-2 rounded flex-1 hover:bg-yellow-700 transition" onclick="printQuote()">In báo giá</button>
                        <button class="bg-red-600 text-white p-2 rounded flex-1 hover:bg-red-700 transition" onclick="resetSaleForm()">Reset</button>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/2">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4">Báo cáo hóa đơn bán hàng</h3>
                    <div class="text-gray-600 mb-2">Tổng hóa đơn: <span id="saleSummary">0</span> | Tổng doanh thu: <span id="saleRevenueSummary">0 VNĐ</span></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Khoảng thời gian:</label>
                            <select id="saleReportPeriod" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" onchange="updateSaleDateFilters()">
                                <option value="today">Ngày hôm nay</option>
                                <option value="thisWeek">Tuần này</option>
                                <option value="thisMonth">Tháng này</option>
                                <option value="thisYear">Năm này</option>
                                <option value="custom">Tùy chọn</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Từ ngày:</label>
                            <input id="filterFromDate" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" type="date" oninput="filterSalesTable()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Đến ngày:</label>
                            <input id="filterToDate" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" type="date" oninput="filterSalesTable()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Phương thức thanh toán:</label>
                            <select id="filterPayment" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" oninput="filterSalesTable()">
                                <option value="">Tất cả</option>
                                <option value="tiền mặt">Tiền mặt</option>
                                <option value="chuyển khoản">Chuyển khoản</option>
                                <option value="trả góp">Trả góp</option>
                                <option value="trả nợ">Trả nợ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Trạng thái:</label>
                            <select id="filterDebtStatus" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" oninput="filterSalesTable()">
                                <option value="">Tất cả</option>
                                <option value="paid">Đã thanh toán</option>
                                <option value="debt">Nợ</option>
                            </select>
                        </div>
                    </div>
                    <input id="searchSale" class="border p-2 mb-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" type="text" placeholder="Tìm kiếm hóa đơn..." oninput="filterSalesTable()">
                    <div class="flex items-center mb-2">
                        <label class="mr-2 text-sm font-medium">Số dòng mỗi trang:</label>
                        <select class="rowsPerPageSelect border p-1 rounded focus:border-blue-500 focus:ring focus:ring-blue-200" data-table="saleTable" onchange="changeRowsPerPage(this, this.value)">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                        <label class="ml-4 mr-2 text-sm font-medium">Sắp xếp:</label>
                        <select class="sortSelect border p-1 rounded" data-table="saleTable" onchange="sortTable(this.dataset.table, this.value)">
                            <option value="none">Mặc định</option>
                            <option value="newest">Mới nhất</option>
                            <option value="oldest">Cũ nhất</option>
                        </select>
                    </div>
                    <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                        <thead class="bg-blue-100 text-blue-800">
                            <tr>
                                <th class="border p-2">Ngày bán</th>
                                <th class="border p-2">Khách hàng</th>
                                <th class="border p-2">Địa chỉ</th>
                                <th class="border p-2">Nhân viên</th>
                                <th class="border p-2">Số SP</th>
                                <th class="border p-2">Thuộc tính SP</th>
                                <th class="border p-2">Tổng tiền</th>
                                <th class="border p-2">Trạng thái</th>
                                <th class="border p-2">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="saleTable"></tbody>
                    </table>
                    <div class="flex justify-between mt-2">
                        <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-600 transition" onclick="prevPage('saleTable')" id="prevSaleTable">Trang trước</button>
                        <span id="pageInfoSaleTable" class="text-sm font-medium"></span>
                        <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-600 transition" onclick="nextPage('saleTable')" id="nextSaleTable">Trang sau</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Tab Bảo hành -->
        <div id="warranty" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Quản lý bảo hành</h2>
            <div id="unfinishedWarrantyAlert" class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4" role="alert" style="display: none;">
                <span class="block sm:inline">Có <span id="unfinishedCount">0</span> trường hợp bảo hành chưa xong. <button class="underline" onclick="filterUnfinishedWarranties()">Xem chi tiết</button></span>
            </div>
            <div class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Thêm tác vụ bảo hành</h3>
                <select id="warrantySaleDetail" class="border p-2 mr-2 w-48" onchange="loadWarrantyProductDetails()"></select>
                <input id="warrantyDate" class="border p-2 mr-2" type="date" placeholder="Ngày bảo hành">
                <input id="warrantyIssue" class="border p-2 mr-2" type="text" placeholder="Vấn đề">
                <input id="warrantyAction" class="border p-2 mr-2" type="text" placeholder="Tác vụ bảo hành">
                <input id="warrantyCost" class="border p-2 mr-2" type="number" placeholder="Chi phí (VNĐ)">
                <select id="warrantyEmployee" class="border p-2 mr-2 w-48"></select>
                <input id="warrantyNote" class="border p-2 mr-2" type="text" placeholder="Ghi chú">
                <input id="machineCondition" class="border p-2 mr-2" type="text" placeholder="Tình trạng máy">
                <input id="repairPlan" class="border p-2 mr-2" type="text" placeholder="Phương án sửa chữa">
                <input id="estimatedTime" class="border p-2 mr-2" type="date" placeholder="Thời gian hẹn">
                <input id="delivererPhone" class="border p-2 mr-2" type="text" placeholder="Số điện thoại người giao">
                <input id="delivererName" class="border p-2 mr-2" type="text" placeholder="Người giao máy">
                <select id="warrantyStatus" class="border p-2 mr-2 w-48">
                    <option value="received">Nhận máy</option>
                    <option value="completed">Hoàn thành</option>
                </select>
                <button class="bg-blue-500 text-white p-2 rounded" onclick="addWarrantyRecord()">Cập nhật Bảo hành</button>
                <button class="bg-red-500 text-white p-2 rounded ml-2" onclick="resetWarrantyForm()">Reset</button>
                <input id="warrantyRecordId" type="hidden">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Từ ngày:</label>
                    <input id="filterWarrantyFromDate" class="border p-2 w-full rounded" type="date" oninput="filterWarrantyTable()">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Đến ngày:</label>
                    <input id="filterWarrantyToDate" class="border p-2 w-full rounded" type="date" oninput="filterWarrantyTable()">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Tình trạng bảo hành:</label>
                    <select id="filterWarrantyStatus" class="border p-2 w-full rounded" oninput="filterWarrantyTable()">
                        <option value="">Tất cả</option>
                        <option value="active">Còn bảo hành</option>
                        <option value="expired">Hết bảo hành</option>
                        <option value="inProgress">Đang bảo hành</option>
                        <option value="unfinished">Chưa xong</option>
                    </select>
                </div>
            </div>
            <input id="searchWarranty" class="border p-2 mb-2 w-full" type="text" placeholder="Tìm kiếm bảo hành..." oninput="filterWarrantyTable()">
            <div class="text-gray-600 mb-2">Tổng trường hợp bảo hành: <span id="warrantySummary">0</span></div>
            <div class="flex items-center mb-2">
                <label class="mr-2 text-sm font-medium">Số dòng mỗi trang:</label>
                <select class="rowsPerPageSelect border p-1 rounded" data-table="warrantyTable" onchange="changeRowsPerPage(this, this.value)">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
                <label class="ml-4 mr-2 text-sm font-medium">Sắp xếp:</label>
                <select class="sortSelect border p-1 rounded" data-table="warrantyTable" onchange="sortTable(this.dataset.table, this.value)">
                    <option value="none">Mặc định</option>
                    <option value="newest">Mới nhất</option>
                    <option value="oldest">Cũ nhất</option>
                </select>
            </div>
            <table class="w-full border-collapse border">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border p-2">Sản phẩm</th>
                        <th class="border p-2">Thuộc tính</th>
                        <th class="border p-2">Mã vạch</th>
                        <th class="border p-2">Khách hàng</th>
                        <th class="border p-2">Ngày bán</th>
                        <th class="border p-2">Thời gian BH</th>
                        <th class="border p-2">Hết hạn</th>
                        <th class="border p-2">Tình trạng</th>
                        <th class="border p-2">Lịch sử BH</th>
                        <th class="border p-2">Hành động</th>
                    </tr>
                </thead>
                <tbody id="warrantyTable"></tbody>
            </table>
            <div class="flex justify-between mt-2">
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="prevPage('warrantyTable')" id="prevWarrantyTable">Trang trước</button>
                <span id="pageInfoWarrantyTable"></span>
                <button class="bg-blue-500 text-white p-2 rounded disabled:opacity-50 disabled:cursor-not-allowed" onclick="nextPage('warrantyTable')" id="nextWarrantyTable">Trang sau</button>
            </div>
        </div>
        <!-- Tab Báo cáo -->
        <div id="reports" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Báo cáo</h2>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <section class="mb-6 border-b pb-4">
                    <h3 class="text-lg font-bold mb-2">Lọc báo cáo</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Khoảng thời gian:</label>
                            <select id="reportPeriod" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" onchange="updateDateFilters()">
                                <option value="today">Ngày hôm nay</option>
                                <option value="thisWeek">Tuần này</option>
                                <option value="thisMonth">Tháng này</option>
                                <option value="thisYear">Năm này</option>
                                <option value="custom">Tùy chọn</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Từ ngày:</label>
                            <input id="reportFromDate" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" type="date">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Đến ngày:</label>
                            <input id="reportToDate" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200" type="date">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Theo nhân viên:</label>
                            <select id="reportEmployee" class="border p-2 w-full rounded focus:border-blue-500 focus:ring focus:ring-blue-200">
                                <option value="">Tất cả</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end mb-4">
                        <button class="bg-blue-500 text-white p-2 rounded" onclick="generateReports()">Báo cáo</button>
                    </div>
                </section>
                <section class="mb-6 border-b pb-4">
                    <h3 class="text-lg font-bold mb-2">Biểu đồ doanh thu</h3>
                    <p id="revenueChartsNote" class="text-sm text-gray-600 mb-2"></p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <h4 class="text-md font-semibold mb-2">Doanh thu theo ngày</h4>
                            <canvas id="dailyRevenueChart" height="80"></canvas>
                        </div>
                        <div>
                            <h4 class="text-md font-semibold mb-2">Doanh thu theo tháng</h4>
                            <canvas id="monthlyRevenueChart" height="80"></canvas>
                        </div>
                        <div>
                            <h4 class="text-md font-semibold mb-2">Doanh thu theo nhân viên</h4>
                            <canvas id="revenueByEmployeeChart" height="80"></canvas>
                        </div>
                    </div>
                </section>
                <section class="mb-6 border-b pb-4">
                    <h3 class="text-lg font-bold mb-2">Số liệu doanh thu theo nhân viên</h3>
                    <p id="revenueByEmployeeNote" class="text-sm text-gray-600 mb-2"></p>
                    <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                        <thead class="bg-blue-100 text-blue-800">
                            <tr>
                                <th class="border p-2">Nhân viên</th>
                                <th class="border p-2">Doanh thu (VNĐ)</th>
                                <th class="border p-2">Sản phẩm bán được</th>
                                <th class="border p-2">Bảo hành hoàn thành</th>
                                <th class="border p-2">Bảo hành chưa hoàn thành</th>
                                <th class="border p-2">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="revenueByEmployeeTable"></tbody>
                    </table>
                </section>
                <section class="mb-6 border-b pb-4">
                    <h3 class="text-lg font-bold mb-2">Hàng tồn kho</h3>
                    <p id="inventoryNote" class="text-sm text-gray-600 mb-2"></p>
                    <p>Tổng số lượng tồn kho: <span id="totalInventory">0</span> sản phẩm</p>
                    <p>Tổng giá trị tồn kho: <span id="totalInventoryValue">0 VNĐ</span></p>
                    <button class="bg-blue-500 text-white p-2 rounded mb-4" onclick="showInventoryDetailsModal()">Xem chi tiết</button>
                </section>
                <section class="mb-6 border-b pb-4">
                    <h3 class="text-lg font-bold mb-2">Công nợ khách hàng</h3>
                    <p id="debtNote" class="text-sm text-gray-600 mb-2"></p>
                    <button class="bg-blue-500 text-white p-2 rounded mb-4" onclick="showDebtDetailsModal()">Xem chi tiết</button>
                    <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                        <thead class="bg-blue-100 text-blue-800">
                            <tr>
                                <th class="border p-2">Khách hàng</th>
                                <th class="border p-2">Tổng nợ (VNĐ)</th>
                                <th class="border p-2">Hóa đơn nợ</th>
                            </tr>
                        </thead>
                        <tbody id="debtReportTable"></tbody>
                    </table>
                </section>
                <section class="mb-6 border-b pb-4">
                    <h3 class="text-lg font-bold mb-2">Thống kê bảo hành</h3>
                    <p id="warrantyStatsNote" class="text-sm text-gray-600 mb-2"></p>
                    <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                        <thead class="bg-blue-100 text-blue-800">
                            <tr>
                                <th class="border p-2">Trạng thái</th>
                                <th class="border p-2">Số lượng</th>
                                <th class="border p-2">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="warrantyStatsTable"></tbody>
                    </table>
                </section>
                <section class="mb-6">
                    <h3 class="text-lg font-bold mb-2">Thống kê bán hàng</h3>
                    <p id="salesStatsNote" class="text-sm text-gray-600 mb-2"></p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm font-medium">Tổng doanh thu</p>
                            <p id="totalRevenue" class="text-xl font-bold text-blue-600">0 VNĐ</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm font-medium">Tổng hóa đơn</p>
                            <p id="totalSales" class="text-xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm font-medium">Tổng công nợ</p>
                            <p id="totalDebt" class="text-xl font-bold text-yellow-600">0 VNĐ</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <p class="text-sm font-medium">Tổng lợi nhuận</p>
                            <p id="totalProfit" class="text-xl font-bold text-purple-600">0 VNĐ</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        <!-- Tab Cấu hình -->
        <div id="config" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Cấu hình thông tin công ty</h2>
            <div class="bg-white p-4 rounded-lg shadow-md space-y-4">
                <!-- Thông tin công ty -->
                <div>
                    <h3 class="text-lg font-semibold mb-2">Thông tin công ty</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
                        <div>
                            <label class="block text-sm font-medium mb-1">Tên công ty:</label>
                            <input id="companyName" class="border p-1 w-full rounded text-sm" type="text">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Địa chỉ:</label>
                            <input id="companyAddress" class="border p-1 w-full rounded text-sm" type="text">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Số điện thoại:</label>
                            <input id="companyPhone" class="border p-1 w-full rounded text-sm" type="text">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email:</label>
                            <input id="companyEmail" class="border p-1 w-full rounded text-sm" type="text">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Mã số thuế:</label>
                            <input id="companyTaxCode" class="border p-1 w-full rounded text-sm" type="text">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Logo (hình ảnh):</label>
                            <input id="companyLogo" class="border p-1 w-full rounded text-sm" type="file" accept="image/*">
                            <img id="logoPreview" class="mt-1 w-16 h-16 object-cover" src="" alt="Preview" style="display: none;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Chữ ký điện tử:</label>
                            <input id="companySignature" class="border p-1 w-full rounded text-sm" type="text" placeholder="Chữ ký (text)">
                        </div>
                    </div>
                </div>
                <!-- Thông tin ngân hàng -->
                <div>
                    <h3 class="text-lg font-semibold mb-2">Thông tin ngân hàng</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <div>
                            <label class="block text-sm font-medium mb-1">Ngân hàng:</label>
                            <input id="companyBank" class="border p-1 w-full rounded text-sm" type="text">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Số tài khoản:</label>
                            <input id="companyAccountNumber" class="border p-1 w-full rounded text-sm" type="text">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Chủ tài khoản:</label>
                            <input id="companyAccountHolder" class="border p-1 w-full rounded text-sm" type="text">
                        </div>
                    </div>
                </div>
                <!-- Cài đặt hóa đơn -->
                <div>
                    <h3 class="text-lg font-semibold mb-2">Cài đặt hóa đơn</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium mb-1">Tên hóa đơn:</label>
                            <input id="invoiceTitle" class="border p-1 w-full rounded text-sm" type="text" value="HÓA ĐƠN BÁN HÀNG">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Kích thước hóa đơn:</label>
                            <select id="invoiceSize" class="border p-1 w-full rounded text-sm">
                                <option value="a4">A4</option>
                                <option value="a5">A5</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-1">Ghi chú mặc định hóa đơn:</label>
                            <textarea id="defaultInvoiceNote" class="border p-1 w-full rounded text-sm" rows="2"></textarea>
                        </div>
                        <div class="flex items-center">
                            <input id="showEmployeeName" type="checkbox" checked class="mr-2">
                            <label class="text-sm font-medium">Hiển thị tên nhân viên bán hàng</label>
                        </div>
                        <div class="flex items-center">
                            <input id="enableVat" type="checkbox" checked class="mr-2">
                            <label class="text-sm font-medium">Tính thuế VAT</label>
                        </div>
                        <div class="flex items-center">
                            <input id="showBankInfo" type="checkbox" checked class="mr-2">
                            <label class="text-sm font-medium">Hiển thị thông tin tài khoản ngân hàng</label>
                        </div>
                        <div class="flex items-center">
                            <input id="showPaymentQR" type="checkbox" class="mr-2">
                            <label class="text-sm font-medium">Hiển thị QR thanh toán</label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Định dạng nội dung chuyển khoản:</label>
                            <input id="transferContentFormat" class="border p-1 w-full rounded text-sm" type="text" value="CK [invoice_number]">
                        </div>
                    </div>
                </div>
                <!-- Điều khoản bảo hành -->
                <div>
                    <h3 class="text-lg font-semibold mb-2">Điều khoản bảo hành</h3>
                    <textarea id="warrantyTerms" class="border p-1 w-full rounded text-sm" rows="4"></textarea>
                </div>
                <!-- Chi phí phát sinh mặc định -->
                <div>
                    <h3 class="text-lg font-semibold mb-2">Chi phí phát sinh mặc định</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium mb-1">Phí ship mặc định (VNĐ):</label>
                            <input id="defaultShippingCost" class="border p-1 w-full rounded text-sm" type="number" step="0.01">
                        </div>
                    </div>
                    <div id="defaultCostFields" class="mt-2 space-y-2">
                        <div class="flex gap-2">
                            <input class="defaultCostDescription border p-1 w-[120px] rounded" type="text" placeholder="Mô tả chi phí 1">
                            <input class="defaultCostValue border p-1 w-[120px] rounded" type="number" step="0.01" placeholder="VNĐ">
                        </div>
                        <div class="flex gap-2">
                            <input class="defaultCostDescription border p-1 w-[120px] rounded" type="text" placeholder="Mô tả chi phí 2">
                            <input class="defaultCostValue border p-1 w-[120px] rounded" type="number" step="0.01" placeholder="VNĐ">
                        </div>
                        <div class="flex gap-2">
                            <input class="defaultCostDescription border p-1 w-[120px] rounded" type="text" placeholder="Mô tả chi phí 3">
                            <input class="defaultCostValue border p-1 w-[120px] rounded" type="number" step="0.01" placeholder="VNĐ">
                        </div>
                        <div class="flex gap-2">
                            <input class="defaultCostDescription border p-1 w-[120px] rounded" type="text" placeholder="Mô tả chi phí 4">
                            <input class="defaultCostValue border p-1 w-[120px] rounded" type="number" step="0.01" placeholder="VNĐ">
                        </div>
                    </div>
                </div>
                <!-- Xuất/nhập dữ liệu -->
                <div class="mt-4 flex gap-2">
                    <button class="bg-green-500 text-white p-2 rounded hover:bg-green-600 text-sm" onclick="exportData()">Xuất dữ liệu</button>
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="border p-1 rounded text-sm">
                </div>
                <!-- Nút hành động -->
                <div class="flex gap-2 justify-end">
                    <button class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 text-sm" onclick="saveCompanyInfo()">Lưu cấu hình</button>
                    <button class="bg-red-500 text-white p-2 rounded hover:bg-red-600 text-sm" onclick="resetConfigForm()">Reset</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for Debt Details -->
    <div id="debtDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">Chi tiết công nợ</h3>
            <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                <thead class="bg-blue-100 text-blue-800">
                    <tr>
                        <th class="border p-2">Khách hàng</th>
                        <th class="border p-2">Hóa đơn ID</th>
                        <th class="border p-2">Ngày</th>
                        <th class="border p-2">Nợ (VNĐ)</th>
                    </tr>
                </thead>
                <tbody id="debtDetailsTable"></tbody>
            </table>
            <div class="flex justify-end mt-4">
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeDebtDetailsModal()">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal for Invoice -->
    <div id="invoiceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div id="invoiceContent"></div>
            <div class="flex justify-end mt-4 gap-2">
                <button class="bg-green-500 text-white p-2 rounded" onclick="exportToPDFModal()">Xuất PDF</button>
                <button class="bg-blue-500 text-white p-2 rounded" onclick="printInvoiceModal()">In hóa đơn</button>
                <button class="bg-yellow-500 text-white p-2 rounded" onclick="sendInvoiceEmail()">Gửi Email</button>
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeInvoiceModal()">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal for Add Customer -->
    <div id="addCustomerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h3 class="text-lg font-bold mb-4">Thêm khách hàng mới</h3>
            <input id="newCustomerName" class="border p-2 w-full mb-2" type="text" placeholder="Tên khách hàng">
            <input id="newCustomerPhone" class="border p-2 w-full mb-2" type="text" placeholder="Số điện thoại">
            <input id="newCustomerAddress" class="border p-2 w-full mb-2" type="text" placeholder="Địa chỉ">
            <input id="newCustomerFacebook" class="border p-2 w-full mb-2" type="text" placeholder="Facebook">
            <input id="newCustomerNote" class="border p-2 w-full mb-2" type="text" placeholder="Ghi chú">
            <div class="flex justify-end gap-2">
                <button class="bg-blue-500 text-white p-2 rounded" onclick="saveNewCustomer()">Thêm</button>
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeAddCustomerModal()">Hủy</button>
            </div>
        </div>
    </div>
    <!-- Modal for Customer Orders -->
    <div id="customerOrdersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4" id="customerOrdersTitle">Đơn hàng của khách hàng</h3>
            <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                <thead class="bg-blue-100 text-blue-800">
                    <tr>
                        <th class="border p-2">Ngày bán</th>
                        <th class="border p-2">Số SP</th>
                        <th class="border p-2">Tổng tiền</th>
                        <th class="border p-2">Trạng thái</th>
                        <th class="border p-2">Hành động</th>
                    </tr>
                </thead>
                <tbody id="customerOrdersTable"></tbody>
            </table>
            <div class="flex justify-end mt-4">
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeCustomerOrdersModal()">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal for Warranty History -->
    <div id="warrantyHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4" id="warrantyHistoryTitle">Lịch sử bảo hành</h3>
            <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                <thead class="bg-blue-100 text-blue-800">
                    <tr>
                        <th class="border p-2">Ngày</th>
                        <th class="border p-2">Vấn đề</th>
                        <th class="border p-2">Tác vụ</th>
                        <th class="border p-2">Chi phí</th>
                        <th class="border p-2">Nhân viên</th>
                        <th class="border p-2">Ghi chú</th>
                        <th class="border p-2">Tình trạng</th>
                        <th class="border p-2">Tình trạng máy</th>
                        <th class="border p-2">Phương án sửa</th>
                        <th class="border p-2">Thời gian hẹn</th>
                        <th class="border p-2">SĐT người giao</th>
                        <th class="border p-2">Người giao</th>
                        <th class="border p-2">Hành động</th>
                    </tr>
                </thead>
                <tbody id="warrantyHistoryTable"></tbody>
            </table>
            <div class="flex justify-end mt-4">
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeWarrantyHistoryModal()">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal for Warranty Ticket -->
    <div id="warrantyTicketModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div id="warrantyTicketContent"></div>
            <div class="flex justify-end mt-4 gap-2">
                <button class="bg-green-500 text-white p-2 rounded" onclick="exportWarrantyTicketToPDF()">Xuất PDF</button>
                <button class="bg-blue-500 text-white p-2 rounded" onclick="printWarrantyTicket()">In phiếu</button>
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeWarrantyTicketModal()">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal for Receipt Ticket (Biên bản nhận máy) -->
    <div id="receiptTicketModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div id="receiptTicketContent"></div>
            <div class="flex justify-end mt-4 gap-2">
                <button class="bg-green-500 text-white p-2 rounded" onclick="exportReceiptTicketToPDF()">Xuất PDF</button>
                <button class="bg-blue-500 text-white p-2 rounded" onclick="printReceiptTicket()">In biên bản</button>
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeReceiptTicketModal()">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal for Inventory Details -->
    <div id="inventoryDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">Chi tiết hàng tồn kho</h3>
            <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                <thead class="bg-blue-100 text-blue-800">
                    <tr>
                        <th class="border p-2">Sản phẩm</th>
                        <th class="border p-2">Tồn kho</th>
                        <th class="border p-2">Giá trị (VNĐ)</th>
                    </tr>
                </thead>
                <tbody id="inventoryDetailsTable"></tbody>
            </table>
            <div class="flex justify-end mt-4">
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeInventoryDetailsModal()">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal for Employee Sales Details -->
    <div id="employeeSalesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4" id="employeeSalesTitle">Hóa đơn của nhân viên</h3>
            <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                <thead class="bg-blue-100 text-blue-800">
                    <tr>
                        <th class="border p-2">Ngày bán</th>
                        <th class="border p-2">Khách hàng</th>
                        <th class="border p-2">Tổng tiền</th>
                        <th class="border p-2">Hành động</th>
                    </tr>
                </thead>
                <tbody id="employeeSalesTable"></tbody>
            </table>
            <div class="flex justify-end mt-4">
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeEmployeeSalesModal()">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal for Employee Warranties Details -->
    <div id="employeeWarrantiesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4" id="employeeWarrantiesTitle">Bảo hành của nhân viên</h3>
            <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                <thead class="bg-blue-100 text-blue-800">
                    <tr>
                        <th class="border p-2">Ngày</th>
                        <th class="border p-2">Sản phẩm</th>
                        <th class="border p-2">Vấn đề</th>
                        <th class="border p-2">Trạng thái</th>
                        <th class="border p-2">Hành động</th>
                    </tr>
                </thead>
                <tbody id="employeeWarrantiesTable"></tbody>
            </table>
            <div class="flex justify-end mt-4">
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeEmployeeWarrantiesModal()">Đóng</button>
            </div>
        </div>
    </div>
    <!-- Modal for In Progress Warranty Details -->
    <div id="inProgressWarrantyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">Chi tiết trường hợp đang sửa chữa</h3>
            <table class="w-full border-collapse border rounded-lg overflow-hidden table-auto">
                <thead class="bg-blue-100 text-blue-800">
                    <tr>
                        <th class="border p-2">Sản phẩm</th>
                        <th class="border p-2">Khách hàng</th>
                        <th class="border p-2">Ngày nhận</th>
                        <th class="border p-2">Vấn đề</th>
                        <th class="border p-2">Hành động</th>
                    </tr>
                </thead>
                <tbody id="inProgressWarrantyTable"></tbody>
            </table>
            <div class="flex justify-end mt-4">
                <button class="bg-gray-500 text-white p-2 rounded" onclick="closeInProgressWarrantyModal()">Đóng</button>
            </div>
        </div>
    </div>
    <script>
        let selectedBarcodeProducts = [];
        let currentUser = null;
        // Dữ liệu mẫu ban đầu
        let usdExchangeRate = 25000;
        let parentCategories = [
            { id: 1, name: 'Máy tính', attributes: ['CPU', 'RAM', 'Storage'] },
            { id: 2, name: 'Laptop', attributes: ['CPU', 'RAM', 'Storage', 'Screen', 'Resolution', 'GPU'] }
        ];
        let categories = [
            { id: 1, name: 'Dell XPS 13', parentId: 2, details: { CPU: 'Intel Core i7', RAM: '16GB', Storage: '1TB SSD', Screen: '13.4 inch', Resolution: '1920x1200', GPU: 'Intel Iris Xe' } },
            { id: 2, name: 'PC', parentId: 1, details: { CPU: 'AMD Ryzen 5', RAM: '16GB', Storage: '1TB HDD' } }
        ];
        let suppliers = [{ id: 1, name: 'Công ty ABC', address: 'Hà Nội', phone: '0123456789', email: 'abc@example.com' }];
        let products = [
            {
                id: 1,
                serialNumber: 1,
                name: 'Dell XPS 13',
                attributes: { CPU: 'Intel Core i7', RAM: '16GB', Storage: '1TB SSD', Screen: '13.4 inch', Resolution: '1920x1200', GPU: 'Intel Iris Xe' },
                condition: 'Mới',
                categoryId: 1,
                barcode: '1-35.00-23456',
                trackingCode: 'TRK123456',
                webPrice: 1200.00,
                shippingCost: 850000,
                additionalCosts: [
                    { description: 'Thuế nhập khẩu', cost: 1000000 },
                    { description: 'Phí xử lý', cost: 200000 },
                    { description: '', cost: 0 },
                    { description: '', cost: 0 }
                ],
                costPrice: 1200.00 * 25000 + 850000 + 1000000 + 200000,
                sellingPrice: (1200.00 * 25000 + 850000 + 1000000 + 200000) * 1.3,
                supplierId: 1,
                warrantyPeriod: 6,
                stockQuantity: 10,
                image: '',
                expiration: '',
                createdAt: new Date().toISOString() // Thêm trường createdAt để sắp xếp
            }
        ];
        let customers = [{ id: 1, name: 'Nguyễn Văn A', phone: '0987654321', address: 'Hà Nội', facebook: 'facebook.com/nguyenvana', note: '', createdAt: new Date().toISOString() }];
        let sales = [];
        let saleDetails = [];
        let employees = [{ id: 1, name: 'Admin', position: 'admin', phone: '0912345678', username: 'admin', password: 'admin', rights: {readOnly: false, manageProducts: true, manageInvoices: true, manageEmployees: true, manageCustomers: true, manageSales: true, viewCostPrice: true, viewAdminInvoices: true}, createdAt: new Date().toISOString() }];
        let warrantyRecords = [];
        let previousAdditionalCosts = [];
        let stockHistory = [];
        let companyInfo = {
            name: 'CÔNG TY ABC',
            address: '123 Đường Láng Hạ, Quận Đống Đa, Hà Nội',
            phone: '(024) 1234 5678',
            email: 'contact@abc.com',
            taxCode: '0123456789',
            bank: 'Vietcombank',
            accountNumber: '1234567890',
            accountHolder: 'Công ty ABC',
            logo: '',
            signature: '',
            invoiceTitle: 'HÓA ĐƠN BÁN HÀNG',
            showEmployeeName: true,
            enableVat: true,
            invoiceSize: 'a4',
            defaultInvoiceNote: 'Cập nhật trong tab cấu hình',
            warrantyTerms: 'Cập nhật điều khoản trong tab Cấu hình',
            showBankInfo: true,
            showPaymentQR: false,
            transferContentFormat: 'CK [invoice_number]'
        };
        const currentDate = new Date('2025-10-30'); // Ngày hiện tại
        // Phân trang và lọc
        let rowsPerPageMap = {};
        let currentPages = {};
        function getRowsPerPage(tableId) {
            return rowsPerPageMap[tableId] || 10;
        }
        function setRowsPerPage(tableId, value) {
            rowsPerPageMap[tableId] = value;
        }
        function paginateTable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
            const rowsPerPage = getRowsPerPage(tableId);
            const pageCount = Math.ceil(rows.length / rowsPerPage);
            currentPages[tableId] = currentPages[tableId] || 1;
            // Cập nhật trạng thái nút
            const prevBtn = document.getElementById(`prev${tableId.charAt(0).toUpperCase() + tableId.slice(1)}`);
            const nextBtn = document.getElementById(`next${tableId.charAt(0).toUpperCase() + tableId.slice(1)}`);
            if (prevBtn) prevBtn.disabled = currentPages[tableId] <= 1;
            if (nextBtn) nextBtn.disabled = currentPages[tableId] >= pageCount || pageCount === 0;
            const start = (currentPages[tableId] - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            rows.forEach((row, index) => {
                row.style.display = (index >= start && index < end) ? '' : 'none';
            });
            const pageInfo = document.getElementById(`pageInfo${tableId.charAt(0).toUpperCase() + tableId.slice(1)}`);
            if (pageInfo) {
                pageInfo.textContent = pageCount > 0 ? `Trang ${currentPages[tableId]} / ${pageCount}` : 'Không có dữ liệu';
            }
        }
        function nextPage(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
            const rowsPerPage = getRowsPerPage(tableId);
            const pageCount = Math.ceil(rows.length / rowsPerPage);
            if (currentPages[tableId] < pageCount && pageCount > 0) {
                currentPages[tableId]++;
                paginateTable(tableId);
            }
        }
        function prevPage(tableId) {
            if (currentPages[tableId] > 1) {
                currentPages[tableId]--;
                paginateTable(tableId);
            }
        }
        function filterTable(tableId, searchTerm) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const rows = Array.from(table.querySelectorAll('tr'));
            const lowerTerm = searchTerm.toLowerCase();
            rows.forEach(row => {
                if (row.querySelector('th')) return; // Skip header row
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(lowerTerm) ? '' : 'none';
            });
            currentPages[tableId] = 1;
            paginateTable(tableId);
        }
        // Lọc bảng sản phẩm mới theo tên hoặc thuộc tính
        function filterNewProductsTable(searchTerm) {
            const table = document.getElementById('newProductTable');
            if (!table) return;
            const rows = Array.from(table.querySelectorAll('tr'));
            const lowerTerm = searchTerm.toLowerCase();
            rows.forEach(row => {
                if (row.querySelector('th')) return; // Skip header row
                const nameCell = row.cells[0].textContent.toLowerCase();
                const attributesCell = row.cells[2].textContent.toLowerCase();
                const matches = nameCell.includes(lowerTerm) || attributesCell.includes(lowerTerm);
                row.style.display = matches ? '' : 'none';
            });
            currentPages['newProductTable'] = 1;
            paginateTable('newProductTable');
        }
        // Lọc bảng sản phẩm với hỗ trợ tìm theo thuộc tính (e.g., CPU:i7)
        function filterProductTable(searchTerm) {
            const table = document.getElementById('productTable');
            if (!table) return;
            const rows = Array.from(table.querySelectorAll('tr'));
            const lowerTerm = searchTerm.toLowerCase();
            const showInStockOnly = document.getElementById('showInStockOnly').checked;
            rows.forEach(row => {
                if (row.querySelector('th')) return; // Skip header
                const name = row.cells[3].textContent.toLowerCase();
                const attributes = row.cells[4].textContent.toLowerCase();
                const stock = parseInt(row.cells[15].textContent) || 0;
                let matches = name.includes(lowerTerm) || attributes.includes(lowerTerm);
                if (searchTerm.includes(':')) {
                    const [key, value] = searchTerm.split(':').map(s => s.trim().toLowerCase());
                    matches = attributes.includes(`${key}:${value}`);
                }
                if (showInStockOnly && stock <= 0) matches = false;
                row.style.display = matches ? '' : 'none';
            });
            currentPages['productTable'] = 1;
            paginateTable('productTable');
        }
        // Hàm sắp xếp bảng
        function sortTable(tableId, sortType) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            // Giả định cột ngày là cột đầu tiên (có thể điều chỉnh tùy bảng)
            const dateColumnIndex = 0; // Thay đổi tùy theo bảng (ví dụ: saleTable là cells[0] là ngày)
            rows.sort((a, b) => {
                const dateA = new Date(a.cells[dateColumnIndex].textContent);
                const dateB = new Date(b.cells[dateColumnIndex].textContent);
                if (sortType === 'newest') {
                    return dateB - dateA;
                } else if (sortType === 'oldest') {
                    return dateA - dateB;
                }
                return 0;
            });
            rows.forEach(row => tbody.appendChild(row));
            currentPages[tableId] = 1;
            paginateTable(tableId);
        }
        // An toàn để parse JSON từ localStorage
        function safeJsonParse(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                if (item === null) return defaultValue;
                return JSON.parse(item);
            } catch (e) {
                console.warn(`Error parsing ${key} from localStorage:`, e);
                localStorage.removeItem(key);
                return defaultValue;
            }
        }
        // Khởi tạo Choices.js cho trường tên sản phẩm
        let productNameChoices;
        function initProductNameChoices() {
            const productNameSelect = document.getElementById('productName');
            if (!productNameSelect) return;
            productNameChoices = new Choices(productNameSelect, {
                searchEnabled: true,
                searchPlaceholderValue: 'Gõ để tìm kiếm tên sản phẩm',
                placeholderValue: 'Chọn tên sản phẩm',
                shouldSort: false,
                itemSelectText: '',
                choices: categories.map(cat => ({ value: cat.id.toString(), label: cat.name }))
            });
            productNameSelect.addEventListener('change', function() {
                updateBarcode();
                loadProductAttributes(this.value);
            });
        }
        // Khởi tạo Choices.js cho khách hàng
        let customerChoices;
        function initCustomerChoices() {
            const saleCustomerSelect = document.getElementById('saleCustomer');
            if (!saleCustomerSelect) return;
            customerChoices = new Choices(saleCustomerSelect, {
                searchEnabled: true,
                searchPlaceholderValue: 'Gõ để tìm kiếm theo tên hoặc số điện thoại',
                placeholderValue: 'Chọn khách hàng',
                shouldSort: false,
                itemSelectText: '',
                choices: customers.map(cust => ({ value: cust.id.toString(), label: `${cust.name} (${cust.phone})` }))
            });
            saleCustomerSelect.addEventListener('change', displayCustomerDetails);
        }
        // Hiển thị chi tiết khách hàng
        function displayCustomerDetails() {
            const customerId = parseInt(document.getElementById('saleCustomer').value);
            const customer = customers.find(c => c.id === customerId);
            document.getElementById('customerPhoneDisplay').textContent = customer ? `Số điện thoại: ${customer.phone}` : '';
            document.getElementById('customerAddressDisplay').textContent = customer ? `Địa chỉ: ${customer.address}` : '';
        }
        // Hiển thị thuộc tính của sản phẩm trong tab sản phẩm
        function loadProductAttributes(categoryId) {
            const category = categories.find(c => c.id == categoryId);
            const attributesDiv = document.getElementById('productAttributes');
            if (attributesDiv && category) {
                const attributesText = Object.entries(category.details)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join('\n');
                attributesDiv.textContent = attributesText;
            } else if (attributesDiv) {
                attributesDiv.textContent = '';
            }
        }
        // Hiển thị loading spinner
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }
        // Ẩn loading spinner
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        // Lưu trữ vào localStorage
        async function saveData() {
            showLoading();
            try {
                localStorage.setItem('usdExchangeRate', usdExchangeRate.toString());
                localStorage.setItem('parentCategories', JSON.stringify(parentCategories));
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('customers', JSON.stringify(customers));
                localStorage.setItem('sales', JSON.stringify(sales));
                localStorage.setItem('saleDetails', JSON.stringify(saleDetails));
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('stockHistory', JSON.stringify(stockHistory));
                localStorage.setItem('warrantyRecords', JSON.stringify(warrantyRecords));
                localStorage.setItem('companyInfo', JSON.stringify(companyInfo));
                localStorage.setItem('previousAdditionalCosts', JSON.stringify(previousAdditionalCosts));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                Swal.fire('Lỗi', 'Không thể lưu dữ liệu vào localStorage. Vui lòng thử lại.', 'error');
            } finally {
                hideLoading();
                // Cập nhật báo cáo thời gian thực nếu tab reports đang mở
                if (!document.getElementById('reports').classList.contains('hidden')) {
                    generateReports();
                }
            }
        }
        // Tải dữ liệu từ localStorage
        async function loadData() {
            showLoading();
            try {
                console.log('Bắt đầu tải dữ liệu...');
                usdExchangeRate = parseFloat(localStorage.getItem('usdExchangeRate')) || 25000;
                parentCategories = safeJsonParse('parentCategories', [
                    { id: 1, name: 'Máy tính', attributes: ['CPU', 'RAM', 'Storage'] },
                    { id: 2, name: 'Laptop', attributes: ['CPU', 'RAM', 'Storage', 'Screen', 'Resolution', 'GPU'] }
                ]);
                categories = safeJsonParse('categories', [
                    { id: 1, name: 'Dell XPS 13', parentId: 2, details: { CPU: 'Intel Core i7', RAM: '16GB', Storage: '1TB SSD', Screen: '13.4 inch', Resolution: '1920x1200', GPU: 'Intel Iris Xe' } },
                    { id: 2, name: 'PC', parentId: 1, details: { CPU: 'AMD Ryzen 5', RAM: '16GB', Storage: '1TB HDD' } }
                ]);
                suppliers = safeJsonParse('suppliers', [{ id: 1, name: 'Công ty ABC', address: 'Hà Nội', phone: '0123456789', email: 'abc@example.com' }]);
                products = safeJsonParse('products', [
                    {
                        id: 1,
                        serialNumber: 1,
                        name: 'Dell XPS 13',
                        attributes: { CPU: 'Intel Core i7', RAM: '16GB', Storage: '1TB SSD', Screen: '13.4 inch', Resolution: '1920x1200', GPU: 'Intel Iris Xe' },
                        condition: 'Mới',
                        categoryId: 1,
                        barcode: '1-35.00-23456',
                        trackingCode: 'TRK123456',
                        webPrice: 1200.00,
                        shippingCost: 850000,
                        additionalCosts: [
                            { description: 'Thuế nhập khẩu', cost: 1000000 },
                            { description: 'Phí xử lý', cost: 200000 },
                            { description: '', cost: 0 },
                            { description: '', cost: 0 }
                        ],
                        costPrice: 1200.00 * 25000 + 850000 + 1000000 + 200000,
                        sellingPrice: (1200.00 * 25000 + 850000 + 1000000 + 200000) * 1.3,
                        supplierId: 1,
                        warrantyPeriod: 6,
                        stockQuantity: 10,
                        image: '',
                        expiration: '',
                        createdAt: new Date().toISOString()
                    }
                ]);
                customers = safeJsonParse('customers', [{ id: 1, name: 'Nguyễn Văn A', phone: '0987654321', address: 'Hà Nội', facebook: 'facebook.com/nguyenvana', note: '', createdAt: new Date().toISOString() }]);
                sales = safeJsonParse('sales', []);
                saleDetails = safeJsonParse('saleDetails', []);
                employees = safeJsonParse('employees', [{ id: 1, name: 'Admin', position: 'admin', phone: '0912345678', username: 'admin', password: 'admin', rights: {readOnly: false, manageProducts: true, manageInvoices: true, manageEmployees: true, manageCustomers: true, manageSales: true, viewCostPrice: true, viewAdminInvoices: true}, createdAt: new Date().toISOString() }]);
                stockHistory = safeJsonParse('stockHistory', []);
                warrantyRecords = safeJsonParse('warrantyRecords', []);
                companyInfo = safeJsonParse('companyInfo', {
                    name: 'CÔNG TY ABC',
                    address: '123 Đường Láng Hạ, Quận Đống Đa, Hà Nội',
                    phone: '(024) 1234 5678',
                    email: 'contact@abc.com',
                    taxCode: '0123456789',
                    bank: 'Vietcombank',
                    accountNumber: '1234567890',
                    accountHolder: 'Công ty ABC',
                    logo: '',
                    signature: '',
                    invoiceTitle: 'HÓA ĐƠN BÁN HÀNG',
                    showEmployeeName: true,
                    enableVat: true,
                    invoiceSize: 'a4',
                    defaultInvoiceNote: 'Cập nhật trong tab cấu hình',
                    warrantyTerms: 'Cập nhật điều khoản trong tab Cấu hình',
                    showBankInfo: true,
                    showPaymentQR: false,
                    transferContentFormat: 'CK [invoice_number]'
                });
                previousAdditionalCosts = safeJsonParse('previousAdditionalCosts', []);
                // Restore form states
                const forms = [
                    {
                        id: 'parentCategoryForm',
                        fields: ['parentCategoryName', 'parentCategoryId']
                    },
                    {
                        id: 'newProductForm',
                        fields: ['newProductName', 'parentCategory']
                    },
                    {
                        id: 'productForm',
                        fields: ['usdExchangeRate', 'productSerialNumber', 'productCostPrice', 'productSellingPrice', 'productBarcode', 'productName', 'productTrackingCode', 'currencyType', 'productWebPrice', 'productSupplier', 'productWarranty', 'productInitialStock', 'entryType', 'productExpiration', 'productImage']
                    },
                    {
                        id: 'supplierForm',
                        fields: ['supplierName', 'supplierAddress', 'supplierPhone', 'supplierEmail', 'supplierId']
                    },
                    {
                        id: 'customerForm',
                        fields: ['customerName', 'customerPhone', 'customerAddress', 'customerFacebook', 'customerNote', 'customerId']
                    },
                    {
                        id: 'employeeForm',
                        fields: ['employeeName', 'employeePosition', 'employeePhone', 'employeeUsername', 'employeePassword', 'employeeId', 'readOnly', 'manageProducts', 'manageInvoices', 'manageEmployees', 'manageCustomers', 'manageSales', 'viewCostPrice', 'viewAdminInvoices']
                    },
                    {
                        id: 'inventoryForm',
                        fields: ['inventoryProduct', 'inventoryQuantity', 'inventoryReason']
                    },
                    {
                        id: 'saleForm',
                        fields: ['saleCustomer', 'saleEmployee', 'paymentMethod', 'promotion', 'paidAmount', 'globalDiscount', 'saleNote']
                    },
                    {
                        id: 'warrantyForm',
                        fields: ['warrantySaleDetail', 'warrantyDate', 'warrantyIssue', 'warrantyAction', 'warrantyCost', 'warrantyEmployee', 'warrantyNote', 'machineCondition', 'repairPlan', 'estimatedTime', 'delivererPhone', 'delivererName', 'warrantyStatus', 'warrantyRecordId']
                    },
                    {
                        id: 'configForm',
                        fields: ['companyName', 'companyAddress', 'companyPhone', 'companyEmail', 'companyTaxCode', 'companyBank', 'companyAccountNumber', 'companyAccountHolder', 'companySignature', 'invoiceTitle', 'defaultInvoiceNote', 'warrantyTerms', 'defaultShippingCost', 'showEmployeeName', 'enableVat', 'invoiceSize', 'showBankInfo', 'showPaymentQR', 'transferContentFormat']
                    }
                ];
                forms.forEach(form => {
                    const formState = safeJsonParse(`formState_${form.id}`, {});
                    Object.entries(formState).forEach(([field, value]) => {
                        const element = document.getElementById(field);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = value;
                            } else {
                                element.value = value;
                            }
                        }
                    });
                });
                // Restore additional costs for product form
                const productCosts = safeJsonParse('productAdditionalCosts', { descriptions: [], values: [] });
                const costDescs = document.querySelectorAll('.costDescription');
                const costValues = document.querySelectorAll('.costValue');
                productCosts.descriptions.forEach((desc, i) => {
                    if (costDescs[i]) costDescs[i].value = desc;
                    if (costValues[i]) costValues[i].value = productCosts.values[i] || 0;
                });
                // Restore default costs for config form
                const configCosts = safeJsonParse('configDefaultCosts', { descriptions: [], values: [] });
                const defaultCostDescs = document.querySelectorAll('.defaultCostDescription');
                const defaultCostValues = document.querySelectorAll('.defaultCostValue');
                configCosts.descriptions.forEach((desc, i) => {
                    if (defaultCostDescs[i]) defaultCostDescs[i].value = desc;
                    if (defaultCostValues[i]) defaultCostValues[i].value = configCosts.values[i] || 0;
                });
                // Restore parent category custom fields
                const parentCustomFields = safeJsonParse('parentCustomFields', []);
                const parentCustomFieldsDiv = document.getElementById('parentCustomFields');
                if (parentCustomFieldsDiv && parentCustomFields.length > 0) {
                    parentCustomFieldsDiv.innerHTML = parentCustomFields.map(key => `
                        <div class="flex mb-2">
                            <input class="parentCustomFieldKey border p-2 mr-2" type="text" value="${key}">
                            <button class="bg-red-500 text-white p-2 rounded" onclick="this.parentElement.remove()">Xóa</button>
                        </div>
                    `).join('') + `
                        <div class="flex mb-2">
                            <input class="parentCustomFieldKey border p-2 mr-2" type="text" placeholder="Tên thuộc tính mới">
                            <button class="bg-green-500 text-white p-2 rounded" onclick="addParentCustomField()">Thêm thuộc tính</button>
                        </div>
                    `;
                }
                // Restore barcode options
                const barcodeOptions = safeJsonParse('barcodeOptions', {});
                if (Object.keys(barcodeOptions).length > 0) {
                    Object.entries(barcodeOptions).forEach(([key, value]) => {
                        const element = document.getElementById(key);
                        if (element) {
                            if (element.type === 'checkbox') element.checked = value;
                            else element.value = value;
                        }
                    });
                    document.getElementById('customSizeDiv').classList.toggle('hidden', barcodeOptions.barcodePaperSize !== 'custom');
                    document.getElementById('customLayoutDiv').classList.toggle('hidden', barcodeOptions.barcodesPerPage !== 'custom');
                }
                // Restore search values
                ['searchParentCategory', 'searchNewProduct', 'searchProduct', 'searchSupplier', 'searchCustomer', 'searchEmployee', 'searchInventory', 'searchSale', 'searchWarranty'].forEach(id => {
                    const value = localStorage.getItem(id);
                    if (value) document.getElementById(id).value = value;
                });
                // Restore sale filters
                const saleReportPeriod = localStorage.getItem('saleReportPeriod');
                const filterFromDate = localStorage.getItem('filterFromDate');
                const filterToDate = localStorage.getItem('filterToDate');
                const filterPayment = localStorage.getItem('filterPayment');
                const filterDebtStatus = localStorage.getItem('filterDebtStatus');
                if (saleReportPeriod) document.getElementById('saleReportPeriod').value = saleReportPeriod;
                if (filterFromDate) document.getElementById('filterFromDate').value = filterFromDate;
                if (filterToDate) document.getElementById('filterToDate').value = filterToDate;
                if (filterPayment) document.getElementById('filterPayment').value = filterPayment;
                if (filterDebtStatus) document.getElementById('filterDebtStatus').value = filterDebtStatus;
                // Restore warranty filters
                const filterWarrantyFromDate = localStorage.getItem('filterWarrantyFromDate');
                const filterWarrantyToDate = localStorage.getItem('filterWarrantyToDate');
                const filterWarrantyStatus = localStorage.getItem('filterWarrantyStatus');
                if (filterWarrantyFromDate) document.getElementById('filterWarrantyFromDate').value = filterWarrantyFromDate;
                if (filterWarrantyToDate) document.getElementById('filterWarrantyToDate').value = filterWarrantyToDate;
                if (filterWarrantyStatus) document.getElementById('filterWarrantyStatus').value = filterWarrantyStatus;
                // Restore pagination settings
                ['parentCategoryTable', 'newProductTable', 'productTable', 'supplierTable', 'customerTable', 'employeeTable', 'inventoryTable', 'saleTable', 'warrantyTable'].forEach(tableId => {
                    const rows = localStorage.getItem(`rowsPerPage_${tableId}`);
                    if (rows) {
                        rowsPerPageMap[tableId] = parseInt(rows);
                        const select = document.querySelector(`.rowsPerPageSelect[data-table="${tableId}"]`);
                        if (select) select.value = rows;
                    }
                    const page = localStorage.getItem(`currentPage_${tableId}`);
                    if (page) currentPages[tableId] = parseInt(page);
                });
                // Restore report filters
                loadReportFilters();
                // Tải cấu hình
                const savedFontSize = localStorage.getItem('fontSize');
                if (savedFontSize) {
                    document.getElementById('fontSizeSelect').value = savedFontSize;
                    changeFontSize(savedFontSize);
                }
                const savedTab = localStorage.getItem('currentTab');
                if (savedTab) showTab(savedTab);
                // Cập nhật UI sau khi tải dữ liệu thành công
                updateUI();
                document.getElementById('usdExchangeRate').value = usdExchangeRate.toFixed(2);
                setNextSerialNumber();
                loadCompanyInfoForm();
                updateEmployeeOptionsForReport();
                console.log('Dữ liệu đã được tải thành công từ localStorage');
            } catch (e) {
                console.error('Critical error loading data:', e);
                Swal.fire('Lỗi nghiêm trọng', 'Không thể tải dữ liệu. Đang sử dụng dữ liệu mặc định và xóa localStorage.', 'warning');
                localStorage.clear();
                // Tải dữ liệu mặc định
                usdExchangeRate = 25000;
                parentCategories = [
                    { id: 1, name: 'Máy tính', attributes: ['CPU', 'RAM', 'Storage'] },
                    { id: 2, name: 'Laptop', attributes: ['CPU', 'RAM', 'Storage', 'Screen', 'Resolution', 'GPU'] }
                ];
                categories = [
                    { id: 1, name: 'Dell XPS 13', parentId: 2, details: { CPU: 'Intel Core i7', RAM: '16GB', Storage: '1TB SSD', Screen: '13.4 inch', Resolution: '1920x1200', GPU: 'Intel Iris Xe' } },
                    { id: 2, name: 'PC', parentId: 1, details: { CPU: 'AMD Ryzen 5', RAM: '16GB', Storage: '1TB HDD' } }
                ];
                suppliers = [{ id: 1, name: 'Công ty ABC', address: 'Hà Nội', phone: '0123456789', email: 'abc@example.com' }];
                products = [
                    {
                        id: 1,
                        serialNumber: 1,
                        name: 'Dell XPS 13',
                        attributes: { CPU: 'Intel Core i7', RAM: '16GB', Storage: '1TB SSD', Screen: '13.4 inch', Resolution: '1920x1200', GPU: 'Intel Iris Xe' },
                        condition: 'Mới',
                        categoryId: 1,
                        barcode: '1-35.00-23456',
                        trackingCode: 'TRK123456',
                        webPrice: 1200.00,
                        shippingCost: 850000,
                        additionalCosts: [
                            { description: 'Thuế nhập khẩu', cost: 1000000 },
                            { description: 'Phí xử lý', cost: 200000 },
                            { description: '', cost: 0 },
                            { description: '', cost: 0 }
                        ],
                        costPrice: 1200.00 * 25000 + 850000 + 1000000 + 200000,
                        sellingPrice: (1200.00 * 25000 + 850000 + 1000000 + 200000) * 1.3,
                        supplierId: 1,
                        warrantyPeriod: 6,
                        stockQuantity: 10,
                        image: '',
                        expiration: '',
                        createdAt: new Date().toISOString()
                    }
                ];
                customers = [{ id: 1, name: 'Nguyễn Văn A', phone: '0987654321', address: 'Hà Nội', facebook: 'facebook.com/nguyenvana', note: '', createdAt: new Date().toISOString() }];
                sales = [];
                saleDetails = [];
                employees = [{ id: 1, name: 'Admin', position: 'admin', phone: '0912345678', username: 'admin', password: 'admin', rights: {readOnly: false, manageProducts: true, manageInvoices: true, manageEmployees: true, manageCustomers: true, manageSales: true, viewCostPrice: true, viewAdminInvoices: true}, createdAt: new Date().toISOString() }];
                stockHistory = [];
                warrantyRecords = [];
                companyInfo = {
                    name: 'CÔNG TY ABC',
                    address: '123 Đường Láng Hạ, Quận Đống Đa, Hà Nội',
                    phone: '(024) 1234 5678',
                    email: 'contact@abc.com',
                    taxCode: '0123456789',
                    bank: 'Vietcombank',
                    accountNumber: '1234567890',
                    accountHolder: 'Công ty ABC',
                    logo: '',
                    signature: '',
                    invoiceTitle: 'HÓA ĐƠN BÁN HÀNG',
                    showEmployeeName: true,
                    enableVat: true,
                    invoiceSize: 'a4',
                    defaultInvoiceNote: 'Cập nhật trong tab cấu hình',
                    warrantyTerms: 'Cập nhật điều khoản trong tab Cấu hình',
                    showBankInfo: true,
                    showPaymentQR: false,
                    transferContentFormat: 'CK [invoice_number]'
                };
                previousAdditionalCosts = [];
                saveData(); // Lưu dữ liệu mặc định
                updateUI();
            } finally {
                hideLoading();
            }
        }
        // Lưu search values
        function saveSearchValues() {
            ['searchParentCategory', 'searchNewProduct', 'searchProduct', 'searchSupplier', 'searchCustomer', 'searchEmployee', 'searchInventory', 'searchSale', 'searchWarranty'].forEach(id => {
                const element = document.getElementById(id);
                if (element) localStorage.setItem(id, element.value);
            });
        }
        // Cập nhật form thông tin công ty
        function loadCompanyInfoForm() {
            const fields = ['companyName', 'companyAddress', 'companyPhone', 'companyEmail', 'companyTaxCode', 'companyBank', 'companyAccountNumber', 'companyAccountHolder', 'invoiceTitle', 'defaultInvoiceNote', 'warrantyTerms'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element && companyInfo[field.replace('company', '').toLowerCase()]) {
                    element.value = companyInfo[field.replace('company', '').toLowerCase()] || '';
                }
            });
            const companySignature = document.getElementById('companySignature');
            if (companySignature) companySignature.value = companyInfo.signature || '';
            document.getElementById('showEmployeeName').checked = companyInfo.showEmployeeName;
            document.getElementById('enableVat').checked = companyInfo.enableVat;
            document.getElementById('invoiceSize').value = companyInfo.invoiceSize;
            const logoPreview = document.getElementById('logoPreview');
            if (logoPreview && companyInfo.logo) {
                logoPreview.src = companyInfo.logo;
                logoPreview.style.display = 'block';
            }
            document.getElementById('defaultShippingCost').value = companyInfo.defaultShippingCost || 0;
            const defaultCosts = companyInfo.defaultCosts || [];
            const defaultCostDescs = document.querySelectorAll('.defaultCostDescription');
            const defaultCostValues = document.querySelectorAll('.defaultCostValue');
            for (let i = 0; i < 4; i++) {
                defaultCostDescs[i].value = defaultCosts[i]?.description || '';
                defaultCostValues[i].value = defaultCosts[i]?.cost || 0;
            }
            document.getElementById('showBankInfo').checked = companyInfo.showBankInfo !== false;
            document.getElementById('showPaymentQR').checked = companyInfo.showPaymentQR || false;
            document.getElementById('transferContentFormat').value = companyInfo.transferContentFormat || 'CK [invoice_number]';
        }
        // Lưu thông tin công ty
        function saveCompanyInfo() {
            const fields = {
                'companyName': 'name',
                'companyAddress': 'address',
                'companyPhone': 'phone',
                'companyEmail': 'email',
                'companyTaxCode': 'taxCode',
                'companyBank': 'bank',
                'companyAccountNumber': 'accountNumber',
                'companyAccountHolder': 'accountHolder',
                'companySignature': 'signature',
                'invoiceTitle': 'invoiceTitle',
                'defaultInvoiceNote': 'defaultInvoiceNote',
                'warrantyTerms': 'warrantyTerms'
            };
            Object.entries(fields).forEach(([elementId, property]) => {
                const element = document.getElementById(elementId);
                if (element) {
                    companyInfo[property] = element.value.trim();
                }
            });
            companyInfo.showEmployeeName = document.getElementById('showEmployeeName').checked;
            companyInfo.enableVat = document.getElementById('enableVat').checked;
            companyInfo.invoiceSize = document.getElementById('invoiceSize').value;
            companyInfo.defaultShippingCost = parseFloat(document.getElementById('defaultShippingCost').value) || 0;
            companyInfo.defaultCosts = [];
            const defaultCostDescs = document.querySelectorAll('.defaultCostDescription');
            const defaultCostValues = document.querySelectorAll('.defaultCostValue');
            for (let i = 0; i < 4; i++) {
                const desc = defaultCostDescs[i]?.value.trim() || '';
                const value = parseFloat(defaultCostValues[i]?.value) || 0;
                if (desc || value > 0) {
                    companyInfo.defaultCosts.push({ description: desc, cost: value });
                }
            }
            companyInfo.showBankInfo = document.getElementById('showBankInfo').checked;
            companyInfo.showPaymentQR = document.getElementById('showPaymentQR').checked;
            companyInfo.transferContentFormat = document.getElementById('transferContentFormat').value.trim();
            const logoInput = document.getElementById('companyLogo');
            if (logoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    companyInfo.logo = e.target.result;
                    saveData();
                };
                reader.readAsDataURL(logoInput.files[0]);
            } else {
                saveData();
            }
            Swal.fire('Thành công', 'Thông tin công ty đã được lưu.', 'success');
        }
        // Reset form cấu hình
        function resetConfigForm() {
            const fields = ['companyName', 'companyAddress', 'companyPhone', 'companyEmail', 'companyTaxCode', 'companyBank', 'companyAccountNumber', 'companyAccountHolder', 'companySignature', 'invoiceTitle', 'defaultInvoiceNote', 'warrantyTerms'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });
            document.getElementById('companyLogo').value = '';
            document.getElementById('logoPreview').style.display = 'none';
            document.getElementById('showEmployeeName').checked = true;
            document.getElementById('enableVat').checked = true;
            document.getElementById('invoiceSize').value = 'a4';
            document.getElementById('defaultShippingCost').value = 0;
            const defaultCostDescs = document.querySelectorAll('.defaultCostDescription');
            const defaultCostValues = document.querySelectorAll('.defaultCostValue');
            for (let i = 0; i < 4; i++) {
                defaultCostDescs[i].value = '';
                defaultCostValues[i].value = 0;
            }
            document.getElementById('showBankInfo').checked = true;
            document.getElementById('showPaymentQR').checked = false;
            document.getElementById('transferContentFormat').value = 'CK [invoice_number]';
        }
        // Tính số thứ tự tiếp theo
        function getNextSerialNumber() {
            return products.reduce((max, p) => Math.max(max, p.serialNumber || 0), 0) + 1;
        }
        // Đặt số thứ tự tiếp theo
        function setNextSerialNumber() {
            const element = document.getElementById('productSerialNumber');
            if (element) {
                element.value = getNextSerialNumber();
            }
        }
        // Tạo mã vạch (hỗ trợ suffix cho nhiều item)
        function generateBarcode(serialNumber, productName, costPrice, trackingCode, suffix = '') {
            if (serialNumber && costPrice > 0 && trackingCode) {
                const costDigits = ((costPrice / 1000000) + 1).toFixed(1);
                const last6Tracking = trackingCode.slice(-6);
                return `${serialNumber}-${costDigits}-${last6Tracking}${suffix ? '-' + suffix : ''}`;
            }
            return '';
        }
        // Cập nhật mã vạch tự động vào input và preview
        function updateBarcode() {
            const serialNumber = parseInt(document.getElementById('productSerialNumber')?.value) || 0;
            const productNameSelect = document.getElementById('productName');
            const categoryId = parseInt(productNameSelect?.value) || 0;
            const category = categories.find(c => c.id === categoryId);
            const name = category ? category.name : '';
            const costPrice = parseFloat(document.getElementById('productCostPrice')?.value) || 0;
            const trackingCode = document.getElementById('productTrackingCode')?.value.trim() || '';
            const barcode = generateBarcode(serialNumber, name, costPrice, trackingCode);
            document.getElementById('productBarcode').value = barcode;
            // Đã bỏ preview
        }
        // Tính giá gốc và giá bán
        function calculateCostPrice() {
            const usdElement = document.getElementById('usdExchangeRate');
            const webPriceElement = document.getElementById('productWebPrice');
            const shippingElement = document.getElementById('productShippingCost');
            const costPriceElement = document.getElementById('productCostPrice');
            const sellingPriceElement = document.getElementById('productSellingPrice');
            const currencyType = document.getElementById('currencyType')?.value || 'USD';
            if (!usdElement || !webPriceElement || !shippingElement || !costPriceElement || !sellingPriceElement) return;
            usdExchangeRate = parseFloat(usdElement.value) || 0;
            const webPrice = parseFloat(webPriceElement.value) || 0;
            const shippingCost = parseFloat(shippingElement.value) || 0;
            const costValues = Array.from(document.querySelectorAll('.costValue'), input => parseFloat(input?.value) || 0);
            const totalAdditionalCost = costValues.reduce((sum, cost) => sum + cost, 0);
            let convertedWebPrice = webPrice;
            if (currencyType === 'USD') {
                convertedWebPrice = webPrice * usdExchangeRate;
            }
            const costprice = convertedWebPrice + shippingCost + totalAdditionalCost;
            costPriceElement.value = costprice.toFixed(2);
            sellingPriceElement.value = (costprice * 1.3).toFixed(2);
            updateBarcode();
            saveData();
        }
        // Cập nhật label giá web dựa trên currency
        function updateWebPriceLabel() {
            const currencyType = document.getElementById('currencyType')?.value || 'USD';
            const label = document.querySelector('label[for="productWebPrice"]');
            if (label) {
                label.textContent = `Giá web (${currencyType}):`;
            }
        }
        // Cập nhật giao diện
        function updateUI() {
            updateCategoryOptions();
            updateSupplierOptions();
            updateProductOptions();
            updateCustomerOptions();
            updateEmployeeOptions();
            updateInventoryOptions();
            updateWarrantyOptions();
            updateParentCategoryTable();
            updateNewProductTable();
            updateSupplierTable();
            updateCustomerTable();
            updateEmployeeTable();
            updateInventoryTable();
            updateTables();
            updateWarrantyTable();
            if (productNameChoices) {
                productNameChoices.setChoices(categories.map(cat => ({ value: cat.id.toString(), label: cat.name })), 'value', 'label', true);
            }
            if (customerChoices) {
                customerChoices.setChoices(customers.map(cust => ({ value: cust.id.toString(), label: `${cust.name} (${cust.phone})` })), 'value', 'label', true);
            }
            if (productSearchChoices) {
                productSearchChoices.setChoices(products.filter(prod => prod.stockQuantity > 0).map(prod => ({ value: prod.id.toString(), label: `${prod.name} - Mã vạch: ${prod.barcode}` })), 'value', 'label', true);
            }
            applyPermissions();
            // Khởi tạo phân trang sau khi cập nhật bảng
            setTimeout(() => {
                ['parentCategoryTable', 'newProductTable', 'productTable', 'supplierTable', 'customerTable', 'employeeTable', 'inventoryTable', 'saleTable', 'warrantyTable'].forEach(tableId => {
                    paginateTable(tableId);
                });
                if (document.getElementById('reports').classList.contains('hidden') === false) {
                    generateReports();
                }
            }, 100);
        }
        // Áp dụng quyền và ẩn/hiện tab
        function applyPermissions() {
            if (!currentUser) return;
            const isAdmin = currentUser.position === 'admin';
            const rights = currentUser.rights || {readOnly: false, manageProducts: true, manageInvoices: true, manageEmployees: true, manageCustomers: true, manageSales: true, viewCostPrice: true, viewAdminInvoices: true};
            if (rights.readOnly) {
                // Ẩn tất cả nút thêm/sửa/xóa
                document.querySelectorAll('button[onclick*="add"], button[onclick*="edit"], button[onclick*="delete"]').forEach(btn => btn.style.display = 'none');
            }
            // Ẩn giá gốc nếu không có quyền
            const costPriceDiv = document.getElementById('costPriceDiv');
            const costPriceHeader = document.getElementById('costPriceHeader');
            if (!rights.viewCostPrice && !isAdmin) {
                costPriceDiv.style.display = 'none';
                costPriceHeader.style.display = 'none';
            } else {
                costPriceDiv.style.display = 'block';
                costPriceHeader.style.display = 'table-cell';
            }
            // Lọc hóa đơn nếu không có quyền xem của admin
            if (!rights.viewAdminInvoices && !isAdmin) {
                sales = sales.filter(sale => sale.employeeId !== 1); // Giả định admin id = 1
            }
            // Các quyền khác: Sửa/xóa sản phẩm, hóa đơn, thêm nhân viên, khách hàng, bán hàng
            if (!rights.manageProducts && !isAdmin) {
                document.querySelectorAll('button[onclick*="editProduct"], button[onclick*="deleteProduct"], button[onclick*="addOrUpdateProduct"]').forEach(btn => btn.style.display = 'none');
            }
            if (!rights.manageInvoices && !isAdmin) {
                document.querySelectorAll('button[onclick*="editSale"], button[onclick*="deleteSale"]').forEach(btn => btn.style.display = 'none');
            }
            if (!rights.manageEmployees && !isAdmin) {
                document.querySelectorAll('button[onclick*="addOrUpdateEmployee"], button[onclick*="editEmployee"], button[onclick*="deleteEmployee"]').forEach(btn => btn.style.display = 'none');
            }
            if (!rights.manageCustomers && !isAdmin) {
                document.querySelectorAll('button[onclick*="addOrUpdateCustomer"], button[onclick*="editCustomer"], button[onclick*="deleteCustomer"], button[onclick*="openAddCustomerModal"]').forEach(btn => btn.style.display = 'none');
            }
            if (!rights.manageSales && !isAdmin) {
                document.getElementById('sales').style.display = 'none';
            }
            // Chỉ hiển thị tab Quản lý nhân viên và Quản lý kho cho admin
            const employeesTabButton = document.getElementById('employeesTabButton');
            const inventoryTabButton = document.getElementById('inventoryTabButton');
            const employeesTab = document.getElementById('employees');
            const inventoryTab = document.getElementById('inventory');
            if (isAdmin) {
                employeesTabButton.style.display = 'block';
                inventoryTabButton.style.display = 'block';
                employeesTab.style.display = '';
                inventoryTab.style.display = '';
            } else {
                employeesTabButton.style.display = 'none';
                inventoryTabButton.style.display = 'none';
                employeesTab.style.display = 'none';
                inventoryTab.style.display = 'none';
            }
        }
        // Đăng nhập
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const user = employees.find(emp => emp.username === username && emp.password === password);
            if (!user) return Swal.fire('Lỗi', 'Tài khoản hoặc mật khẩu sai.', 'error');
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('currentUserName').textContent = `Đăng nhập: ${user.name}`;
            document.getElementById('currentUserName').style.display = 'block';
            applyPermissions();
            updateUI();
        }
        // Đăng xuất
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('currentUserName').style.display = 'none';
            Swal.fire('Thành công', 'Bạn đã đăng xuất.', 'success');
        }
        // Kiểm tra đăng nhập khi load
        function checkLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('currentUserName').textContent = `Đăng nhập: ${currentUser.name}`;
                document.getElementById('currentUserName').style.display = 'block';
                applyPermissions();
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        }
        // Cập nhật bảng nhân viên
        function updateEmployeeTable() {
            const employeeTable = document.getElementById('employeeTable');
            if (!employeeTable) return;
            let filteredEmployees = employees;
            if (currentUser.position !== 'admin') {
                filteredEmployees = employees.filter(emp => emp.id === currentUser.id);
            }
            employeeTable.innerHTML = filteredEmployees.map(emp => `
                <tr data-created="${emp.createdAt || new Date().toISOString()}">
                    <td class="border p-2">${emp.name}</td>
                    <td class="border p-2">${emp.position}</td>
                    <td class="border p-2">${emp.phone}</td>
                    <td class="border p-2">${emp.username}</td>
                    <td class="border p-2">${emp.password}</td>
                    <td class="border p-2">${emp.rights.readOnly ? 'Chỉ xem' : Object.keys(emp.rights).filter(key => emp.rights[key] && key !== 'readOnly').join(', ')}</td>
                    <td class="border p-2">
                        <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="editEmployee(${emp.id})">Sửa</button>
                        <button class="bg-red-500 text-white px-2 py-1 rounded text-sm" onclick="deleteEmployee(${emp.id})">Xóa</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('employeeSummary').textContent = filteredEmployees.length;
        }
        // Thêm hoặc cập nhật nhân viên
        function addOrUpdateEmployee() {
            const employeeId = parseInt(document.getElementById('employeeId')?.value) || 0;
            const name = document.getElementById('employeeName')?.value.trim();
            const position = document.getElementById('employeePosition')?.value.trim();
            const phone = document.getElementById('employeePhone')?.value.trim();
            const username = document.getElementById('employeeUsername')?.value.trim();
            const password = document.getElementById('employeePassword')?.value.trim();
            const readOnly = document.getElementById('readOnly').checked;
            const manageProducts = document.getElementById('manageProducts').checked;
            const manageInvoices = document.getElementById('manageInvoices').checked;
            const manageEmployees = document.getElementById('manageEmployees').checked;
            const manageCustomers = document.getElementById('manageCustomers').checked;
            const manageSales = document.getElementById('manageSales').checked;
            const viewCostPrice = document.getElementById('viewCostPrice').checked;
            const viewAdminInvoices = document.getElementById('viewAdminInvoices').checked;
            if (!name) return Swal.fire('Lỗi', 'Vui lòng nhập tên nhân viên.', 'error');
            if (!position) return Swal.fire('Lỗi', 'Vui lòng chọn chức vụ.', 'error');
            if (!username) return Swal.fire('Lỗi', 'Vui lòng nhập tài khoản đăng nhập.', 'error');
            if (!password) return Swal.fire('Lỗi', 'Vui lòng nhập mật khẩu.', 'error');
            const rights = {readOnly, manageProducts, manageInvoices, manageEmployees, manageCustomers, manageSales, viewCostPrice, viewAdminInvoices};
            if (employeeId) {
                const employee = employees.find(emp => emp.id === employeeId);
                if (employee) {
                    employee.name = name;
                    employee.position = position;
                    employee.phone = phone;
                    employee.username = username;
                    employee.password = password;
                    employee.rights = rights;
                    employee.createdAt = new Date().toISOString();
                }
            } else {
                employees.push({ id: employees.length + 1, name, position, phone, username, password, rights, createdAt: new Date().toISOString() });
            }
            saveData();
            resetEmployeeForm();
            updateUI();
            Swal.fire('Thành công', 'Nhân viên đã được thêm/cập nhật.', 'success');
        }
        // Reset form nhân viên
        function resetEmployeeForm() {
            const fields = ['employeeName', 'employeePosition', 'employeePhone', 'employeeUsername', 'employeePassword', 'employeeId'];
            fields.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
            document.getElementById('readOnly').checked = false;
            ['manageProducts', 'manageInvoices', 'manageEmployees', 'manageCustomers', 'manageSales', 'viewCostPrice', 'viewAdminInvoices'].forEach(id => {
                document.getElementById(id).checked = true;
            });
            toggleRights();
        }
        // Toggle các quyền khi chọn chỉ xem
        function toggleRights() {
            const readOnly = document.getElementById('readOnly').checked;
            const rightsGroups = document.querySelectorAll('.rights-group');
            rightsGroups.forEach(group => {
                group.style.display = readOnly ? 'none' : 'flex';
            });
        }
        // Sửa nhân viên
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            if (currentUser.position !== 'admin' && currentUser.id !== id) return Swal.fire('Lỗi', 'Bạn không có quyền sửa nhân viên này.', 'error');
            document.getElementById('employeeId').value = employee.id;
            document.getElementById('employeeName').value = employee.name;
            document.getElementById('employeePosition').value = employee.position;
            document.getElementById('employeePhone').value = employee.phone;
            document.getElementById('employeeUsername').value = employee.username;
            document.getElementById('employeePassword').value = employee.password;
            document.getElementById('readOnly').checked = employee.rights.readOnly;
            document.getElementById('manageProducts').checked = employee.rights.manageProducts;
            document.getElementById('manageInvoices').checked = employee.rights.manageInvoices;
            document.getElementById('manageEmployees').checked = employee.rights.manageEmployees;
            document.getElementById('manageCustomers').checked = employee.rights.manageCustomers;
            document.getElementById('manageSales').checked = employee.rights.manageSales;
            document.getElementById('viewCostPrice').checked = employee.rights.viewCostPrice;
            document.getElementById('viewAdminInvoices').checked = employee.rights.viewAdminInvoices;
            toggleRights();
        }
        // Xóa nhân viên
        function deleteEmployee(id) {
            if (currentUser.position !== 'admin' && currentUser.id !== id) return Swal.fire('Lỗi', 'Bạn không có quyền xóa nhân viên này.', 'error');
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: 'Bạn có chắc chắn muốn xóa nhân viên này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, xóa!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    employees = employees.filter(emp => emp.id !== id);
                    saveData();
                    updateUI();
                    Swal.fire('Đã xóa', 'Nhân viên đã được xóa.', 'success');
                }
            });
        }
        // Cập nhật danh sách danh mục
        function updateCategoryOptions() {
            const parentCategory = document.getElementById('parentCategory');
            if (!parentCategory) return;
            parentCategory.innerHTML = '<option value="">Không có danh mục cha</option>' +
                parentCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        }
        // Thêm thuộc tính tùy chỉnh cho danh mục cha
        function addParentCustomField() {
            const parentCustomFieldsDiv = document.getElementById('parentCustomFields');
            if (!parentCustomFieldsDiv) return;
            const newField = document.createElement('div');
            newField.className = 'flex mb-2';
            newField.innerHTML = `
                <input class="parentCustomFieldKey border p-2 mr-2" type="text" placeholder="Tên thuộc tính (VD: CPU)">
                <button class="bg-red-500 text-white p-2 rounded" onclick="this.parentElement.remove()">Xóa</button>
            `;
            parentCustomFieldsDiv.appendChild(newField);
        }
        // Thêm hoặc cập nhật danh mục cha
        function addOrUpdateParentCategory() {
            const parentCategoryId = parseInt(document.getElementById('parentCategoryId')?.value) || 0;
            const name = document.getElementById('parentCategoryName')?.value.trim();
            const parentCustomFields = document.querySelectorAll('#parentCustomFields .parentCustomFieldKey');
            if (!parentCustomFields || !name) {
                return Swal.fire('Lỗi', 'Vui lòng nhập tên danh mục cha.', 'error');
            }
            const attributes = Array.from(parentCustomFields).map(input => input.value.trim()).filter(key => key);
            const uniqueAttributes = [...new Set(attributes)];
            if (attributes.length !== uniqueAttributes.length) {
                return Swal.fire('Lỗi', 'Thuộc tính bị trùng lặp.', 'error');
            }
            if (!name) return Swal.fire('Lỗi', 'Vui lòng nhập tên danh mục cha.', 'error');
            const existing = parentCategories.find(cat => cat.name.toLowerCase() === name.toLowerCase() && cat.id !== parentCategoryId);
            if (existing) return Swal.fire('Lỗi', 'Danh mục cha với tên này đã tồn tại.', 'error');
            if (parentCategoryId) {
                const category = parentCategories.find(cat => cat.id === parentCategoryId);
                if (category) {
                    category.name = name;
                    category.attributes = uniqueAttributes;
                }
            } else {
                parentCategories.push({ id: parentCategories.length + 1, name, attributes: uniqueAttributes });
            }
            saveData();
            resetParentCategoryForm();
            updateUI();
            Swal.fire('Thành công', 'Danh mục cha đã được thêm/cập nhật.', 'success');
        }
        // Reset form danh mục cha
        function resetParentCategoryForm() {
            const parentCategoryName = document.getElementById('parentCategoryName');
            const parentCategoryId = document.getElementById('parentCategoryId');
            const parentCustomFields = document.getElementById('parentCustomFields');
            const addParentCategoryButton = document.getElementById('addParentCategoryButton');
            if (parentCategoryName) parentCategoryName.value = '';
            if (parentCategoryId) parentCategoryId.value = '';
            if (parentCustomFields) {
                parentCustomFields.innerHTML = `
                    <div class="flex mb-2">
                        <input class="parentCustomFieldKey border p-2 mr-2" type="text" placeholder="Tên thuộc tính (VD: CPU)">
                        <button class="bg-green-500 text-white p-2 rounded" onclick="addParentCustomField()">Thêm thuộc tính</button>
                    </div>
                `;
            }
            if (addParentCategoryButton) addParentCategoryButton.textContent = 'Thêm danh mục cha';
        }
        // Cập nhật bảng danh mục cha
        function updateParentCategoryTable() {
            const parentCategoryTable = document.getElementById('parentCategoryTable');
            if (!parentCategoryTable) return;
            parentCategoryTable.innerHTML = parentCategories.map(cat => `
                <tr data-created="${cat.createdAt || new Date().toISOString()}">
                    <td class="border p-2">${cat.name}</td>
                    <td class="border p-2">${cat.attributes.join(', ') || 'Không có'}</td>
                    <td class="border p-2">
                        <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="editParentCategory(${cat.id})">Sửa</button>
                        <button class="bg-red-500 text-white px-2 py-1 rounded text-sm" onclick="deleteParentCategory(${cat.id})">Xóa</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('parentCategorySummary').textContent = parentCategories.length;
        }
        // Sửa danh mục cha
        function editParentCategory(id) {
            const category = parentCategories.find(cat => cat.id === id);
            if (!category) return;
            const parentCategoryName = document.getElementById('parentCategoryName');
            const parentCategoryId = document.getElementById('parentCategoryId');
            const parentCustomFieldsDiv = document.getElementById('parentCustomFields');
            const addParentCategoryButton = document.getElementById('addParentCategoryButton');
            if (parentCategoryName) parentCategoryName.value = category.name;
            if (parentCategoryId) parentCategoryId.value = category.id;
            if (parentCustomFieldsDiv) {
                parentCustomFieldsDiv.innerHTML = category.attributes.map(key => `
                    <div class="flex mb-2">
                        <input class="parentCustomFieldKey border p-2 mr-2" type="text" value="${key}">
                        <button class="bg-red-500 text-white p-2 rounded" onclick="this.parentElement.remove()">Xóa</button>
                    </div>
                `).join('') + `
                    <div class="flex mb-2">
                        <input class="parentCustomFieldKey border p-2 mr-2" type="text" placeholder="Tên thuộc tính mới">
                        <button class="bg-green-500 text-white p-2 rounded" onclick="addParentCustomField()">Thêm thuộc tính</button>
                    </div>
                `;
            }
            if (addParentCategoryButton) addParentCategoryButton.textContent = 'Cập nhật danh mục cha';
        }
        // Xóa danh mục cha
        function deleteParentCategory(id) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: 'Bạn có chắc chắn muốn xóa danh mục cha này? Các sản phẩm liên quan sẽ bị ảnh hưởng.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, xóa!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (categories.some(cat => cat.parentId === id)) {
                        return Swal.fire('Lỗi', 'Không thể xóa danh mục cha vì có sản phẩm liên quan.', 'error');
                    }
                    if (products.some(prod => {
                        const cat = categories.find(c => c.id === prod.categoryId);
                        return cat && cat.parentId === id;
                    })) {
                        return Swal.fire('Lỗi', 'Không thể xóa danh mục cha vì có sản phẩm liên quan.', 'error');
                    }
                    parentCategories = parentCategories.filter(cat => cat.id !== id);
                    saveData();
                    updateUI();
                    Swal.fire('Đã xóa', 'Danh mục cha đã được xóa.', 'success');
                }
            });
        }
        // Tải thuộc tính của danh mục cha khi chọn
        function loadParentCategoryAttributes() {
            const parentId = parseInt(document.getElementById('parentCategory').value) || 0;
            const parent = parentCategories.find(cat => cat.id === parentId);
            const container = document.getElementById('attributesContainer');
            if (!container) return;
            if (parent && parent.attributes.length > 0) {
                container.innerHTML = parent.attributes.map(attr => `
                    <div class="flex gap-2 items-center">
                        <label class="w-32 font-medium">${attr}:</label>
                        <input class="border p-2 flex-1 attributeValue" data-key="${attr}" type="text" placeholder="Giá trị cho ${attr}">
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-gray-600">Không có thuộc tính nào cho danh mục cha này.</p>';
            }
        }
        // Thêm sản phẩm mới
        function addNewProduct() {
            const newProductName = document.getElementById('newProductName').value.trim();
            const parentId = parseInt(document.getElementById('parentCategory').value) || null;
            const attributeValues = Array.from(document.querySelectorAll('.attributeValue')).map(input => ({
                key: input.dataset.key,
                value: input.value.trim()
            })).filter(field => field.value);
            if (!newProductName) return Swal.fire('Lỗi', 'Vui lòng nhập tên sản phẩm mới.', 'error');
            const details = attributeValues.reduce((acc, field) => {
                acc[field.key] = field.value;
                return acc;
            }, {});
            const existing = categories.find(cat => cat.name.toLowerCase() === newProductName.toLowerCase() && JSON.stringify(cat.details) === JSON.stringify(details));
            if (existing) return Swal.fire('Lỗi', 'Sản phẩm với tên và thuộc tính này đã tồn tại.', 'error');
            categories.push({
                id: categories.length + 1,
                name: newProductName,
                parentId,
                details,
                createdAt: new Date().toISOString()
            });
            saveData();
            resetNewProductForm();
            updateUI();
            Swal.fire('Thành công', 'Sản phẩm mới đã được thêm.', 'success');
        }
        // Reset form sản phẩm mới
        function resetNewProductForm() {
            document.getElementById('newProductName').value = '';
            document.getElementById('parentCategory').value = '';
            document.getElementById('attributesContainer').innerHTML = '';
        }
        // Cập nhật bảng sản phẩm mới
        function updateNewProductTable() {
            const newProductTable = document.getElementById('newProductTable');
            if (!newProductTable) return;
            newProductTable.innerHTML = categories.map(cat => {
                const parent = parentCategories.find(p => p.id === cat.parentId);
                const details = Object.entries(cat.details).map(([key, value]) => `${key}: ${value}`).join(', ');
                return `
                    <tr data-created="${cat.createdAt || new Date().toISOString()}">
                        <td class="border p-2">${cat.name}</td>
                        <td class="border p-2">${parent ? parent.name : 'Không có'}</td>
                        <td class="border p-2">${details || 'Không có'}</td>
                        <td class="border p-2">
                            <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="editCategory(${cat.id})">Sửa</button>
                            <button class="bg-red-500 text-white px-2 py-1 rounded text-sm" onclick="deleteCategory(${cat.id})">Xóa</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('newProductSummary').textContent = categories.length;
        }
        // Sửa sản phẩm mới
        function editCategory(id) {
            const category = categories.find(cat => cat.id === id);
            if (!category) return;
            const parent = parentCategories.find(p => p.id === category.parentId);
            // Tạo modal để chỉnh sửa thuộc tính
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg max-w-md w-full max-h-screen overflow-y-auto">
                    <h3 class="text-lg font-semibold mb-4">Sửa thuộc tính sản phẩm: ${category.name}</h3>
                    <div id="editAttributesContainer" class="space-y-2 mb-4">
                        ${parent.attributes.map(attr => `
                            <div class="flex gap-2 items-center">
                                <label class="w-32 font-medium">${attr}:</label>
                                <input class="border p-2 flex-1 editAttributeValue" data-key="${attr}" type="text" value="${category.details[attr] || ''}" placeholder="Giá trị cho ${attr}">
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button class="bg-gray-500 text-white px-4 py-2 rounded" onclick="this.closest('.fixed').remove()">Hủy</button>
                        <button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="saveEditedCategory(${id})">Lưu</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        // Lưu chỉnh sửa category
        function saveEditedCategory(id) {
            const category = categories.find(cat => cat.id === id);
            if (!category) return;
            const editAttributesContainer = document.getElementById('editAttributesContainer');
            const attributeValues = Array.from(editAttributesContainer.querySelectorAll('.editAttributeValue')).map(input => {
                const [key, value] = [input.dataset.key, input.value.trim()];
                return { key, value };
            }).reduce((acc, field) => {
                if (field.value) acc[field.key] = field.value;
                return acc;
            }, {});
            category.details = attributeValues;
            category.createdAt = new Date().toISOString(); // Cập nhật thời gian
            saveData();
            updateUI();
            document.querySelector('.fixed').remove();
            Swal.fire('Thành công', 'Thuộc tính sản phẩm đã được cập nhật.', 'success');
        }
        // Xóa sản phẩm mới
        function deleteCategory(id) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: 'Bạn có chắc chắn muốn xóa sản phẩm mới này? Dữ liệu liên quan sẽ bị ảnh hưởng.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, xóa!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (products.some(prod => prod.categoryId === id)) return Swal.fire('Lỗi', 'Không thể xóa sản phẩm mới vì có dữ liệu liên quan.', 'error');
                    categories = categories.filter(cat => cat.id !== id);
                    saveData();
                    updateUI();
                    Swal.fire('Đã xóa', 'Sản phẩm mới đã được xóa.', 'success');
                }
            });
        }
        // Cập nhật danh sách nhà cung cấp
        function updateSupplierOptions() {
            const productSupplier = document.getElementById('productSupplier');
            if (!productSupplier) return;
            productSupplier.innerHTML = suppliers.map(sup => `<option value="${sup.id}">${sup.name}</option>`).join('');
        }
        // Cập nhật bảng nhà cung cấp
        function updateSupplierTable() {
            const supplierTable = document.getElementById('supplierTable');
            if (!supplierTable) return;
            supplierTable.innerHTML = suppliers.map(sup => `
                <tr data-created="${sup.createdAt || new Date().toISOString()}">
                    <td class="border p-2">${sup.name}</td>
                    <td class="border p-2">${sup.address}</td>
                    <td class="border p-2">${sup.phone}</td>
                    <td class="border p-2">${sup.email}</td>
                    <td class="border p-2">
                        <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="editSupplier(${sup.id})">Sửa</button>
                        <button class="bg-red-500 text-white px-2 py-1 rounded text-sm" onclick="deleteSupplier(${sup.id})">Xóa</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('supplierSummary').textContent = suppliers.length;
        }
        // Thêm hoặc cập nhật nhà cung cấp
        function addOrUpdateSupplier() {
            const supplierId = parseInt(document.getElementById('supplierId')?.value) || 0;
            const name = document.getElementById('supplierName')?.value.trim();
            const address = document.getElementById('supplierAddress')?.value.trim();
            const phone = document.getElementById('supplierPhone')?.value.trim();
            const email = document.getElementById('supplierEmail')?.value.trim();
            if (!name) return Swal.fire('Lỗi', 'Vui lòng nhập tên nhà cung cấp.', 'error');
            if (supplierId) {
                const supplier = suppliers.find(sup => sup.id === supplierId);
                if (supplier) {
                    supplier.name = name;
                    supplier.address = address;
                    supplier.phone = phone;
                    supplier.email = email;
                    supplier.createdAt = new Date().toISOString();
                }
            } else {
                suppliers.push({ id: suppliers.length + 1, name, address, phone, email, createdAt: new Date().toISOString() });
            }
            saveData();
            resetSupplierForm();
            updateUI();
            Swal.fire('Thành công', 'Nhà cung cấp đã được thêm/cập nhật.', 'success');
        }
        // Reset form nhà cung cấp
        function resetSupplierForm() {
            const fields = ['supplierName', 'supplierAddress', 'supplierPhone', 'supplierEmail', 'supplierId'];
            fields.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
        }
        // Sửa nhà cung cấp
        function editSupplier(id) {
            const supplier = suppliers.find(sup => sup.id === id);
            if (!supplier) return;
            document.getElementById('supplierId').value = supplier.id;
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierAddress').value = supplier.address;
            document.getElementById('supplierPhone').value = supplier.phone;
            document.getElementById('supplierEmail').value = supplier.email;
        }
        // Xóa nhà cung cấp
        function deleteSupplier(id) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: 'Bạn có chắc chắn muốn xóa nhà cung cấp này? Các sản phẩm liên quan sẽ bị ảnh hưởng.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, xóa!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (products.some(prod => prod.supplierId === id)) return Swal.fire('Lỗi', 'Không thể xóa nhà cung cấp vì có sản phẩm liên quan.', 'error');
                    suppliers = suppliers.filter(sup => sup.id !== id);
                    saveData();
                    updateUI();
                    Swal.fire('Đã xóa', 'Nhà cung cấp đã được xóa.', 'success');
                }
            });
        }
        // Cập nhật danh sách sản phẩm
        function updateProductOptions() {
            const saleProducts = document.querySelectorAll('.saleProduct');
            const inventoryProduct = document.getElementById('inventoryProduct');
            const optionsHtml = products.map(prod => `<option value="${prod.id}">${prod.name}</option>`).join('');
            saleProducts.forEach(sp => sp.innerHTML = optionsHtml);
            if (inventoryProduct) inventoryProduct.innerHTML = optionsHtml;
        }
        // Cập nhật danh sách khách hàng
        function updateCustomerOptions() {
            if (customerChoices) {
                customerChoices.setChoices(customers.map(cust => ({ value: cust.id.toString(), label: `${cust.name} (${cust.phone})` })), 'value', 'label', true);
            }
        }
        // Cập nhật bảng khách hàng
        function updateCustomerTable() {
            const customerTable = document.getElementById('customerTable');
            if (!customerTable) return;
            let totalPurchases = 0;
            customerTable.innerHTML = customers.map(cust => {
                const purchaseCount = saleDetails.filter(detail => sales.find(s => s.id === detail.saleId)?.customerId === cust.id).reduce((sum, detail) => sum + detail.quantity, 0);
                totalPurchases += purchaseCount;
                return `
                    <tr data-created="${cust.createdAt || new Date().toISOString()}">
                        <td class="border p-2">${cust.name}</td>
                        <td class="border p-2">${cust.phone}</td>
                        <td class="border p-2">${cust.address}</td>
                        <td class="border p-2">${cust.facebook}</td>
                        <td class="border p-2">${cust.note}</td>
                        <td class="border p-2">${purchaseCount}</td>
                        <td class="border p-2">
                            <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="editCustomer(${cust.id})">Sửa</button>
                            <button class="bg-red-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="deleteCustomer(${cust.id})">Xóa</button>
                            <button class="bg-green-500 text-white px-2 py-1 rounded text-sm" onclick="showCustomerOrders(${cust.id}, '${cust.name}')">Đơn hàng</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('customerSummary').textContent = customers.length;
            document.getElementById('customerPurchaseSummary').textContent = totalPurchases;
        }
        // Mở modal đơn hàng của khách
        function showCustomerOrders(customerId, customerName) {
            const filteredSales = sales.filter(sale => sale.customerId === customerId);
            const customerOrdersTable = document.getElementById('customerOrdersTable');
            const customerOrdersTitle = document.getElementById('customerOrdersTitle');
            customerOrdersTitle.textContent = `Đơn hàng của khách hàng: ${customerName}`;
            customerOrdersTable.innerHTML = filteredSales.map(sale => {
                const itemCount = saleDetails.filter(d => d.saleId === sale.id).reduce((sum, d) => sum + d.quantity, 0);
                const status = sale.debt > 0 ? 'Nợ' : 'Đã thanh toán';
                return `
                    <tr>
                        <td class="border p-2">${sale.saleDate}</td>
                        <td class="border p-2">${itemCount}</td>
                        <td class="border p-2">${sale.totalAmount.toFixed(2)}</td>
                        <td class="border p-2">${status}</td>
                        <td class="border p-2">
                            <button class="bg-blue-500 text-white px-2 py-1 rounded text-sm" onclick="viewSale(${sale.id})">Xem</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('customerOrdersModal').classList.remove('hidden');
        }
        // Đóng modal đơn hàng của khách
        function closeCustomerOrdersModal() {
            document.getElementById('customerOrdersModal').classList.add('hidden');
        }
        // Thêm hoặc cập nhật khách hàng
        function addOrUpdateCustomer() {
            const customerId = parseInt(document.getElementById('customerId')?.value) || 0;
            const name = document.getElementById('customerName')?.value.trim();
            const phone = document.getElementById('customerPhone')?.value.trim();
            const address = document.getElementById('customerAddress')?.value.trim();
            const facebook = document.getElementById('customerFacebook')?.value.trim();
            const note = document.getElementById('customerNote')?.value.trim();
            if (!name) return Swal.fire('Lỗi', 'Vui lòng nhập tên khách hàng.', 'error');
            if (customerId) {
                const customer = customers.find(cust => cust.id === customerId);
                if (customer) {
                    customer.name = name;
                    customer.phone = phone;
                    customer.address = address;
                    customer.facebook = facebook;
                    customer.note = note;
                    customer.createdAt = new Date().toISOString();
                }
            } else {
                customers.push({ id: customers.length + 1, name, phone, address, facebook, note, createdAt: new Date().toISOString() });
            }
            saveData();
            resetCustomerForm();
            updateUI();
            Swal.fire('Thành công', 'Khách hàng đã được thêm/cập nhật.', 'success');
        }
        // Sửa khách hàng
        function editCustomer(id) {
            const customer = customers.find(cust => cust.id === id);
            if (!customer) return;
            document.getElementById('customerId').value = customer.id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerAddress').value = customer.address;
            document.getElementById('customerFacebook').value = customer.facebook;
            document.getElementById('customerNote').value = customer.note;
        }
        // Xóa khách hàng
        function deleteCustomer(id) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: 'Bạn có chắc chắn muốn xóa khách hàng này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, xóa!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    customers = customers.filter(cust => cust.id !== id);
                    saveData();
                    updateUI();
                    Swal.fire('Đã xóa', 'Khách hàng đã được xóa.', 'success');
                }
            });
        }
        // Reset form khách hàng
        function resetCustomerForm() {
            const fields = ['customerName', 'customerPhone', 'customerAddress', 'customerFacebook', 'customerNote', 'customerId'];
            fields.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = '';
            });
        }
        // Mở modal thêm khách hàng
        function openAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.remove('hidden');
        }
        // Đóng modal thêm khách hàng
        function closeAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('hidden');
        }
        // Lưu khách hàng mới
        function saveNewCustomer() {
            const name = document.getElementById('newCustomerName').value.trim();
            const phone = document.getElementById('newCustomerPhone').value.trim();
            const address = document.getElementById('newCustomerAddress').value.trim();
            const facebook = document.getElementById('newCustomerFacebook').value.trim();
            const note = document.getElementById('newCustomerNote').value.trim();
            if (!name) return Swal.fire('Lỗi', 'Vui lòng nhập tên khách hàng.', 'error');
            const newId = customers.length + 1;
            customers.push({ id: newId, name, phone, address, facebook, note, createdAt: new Date().toISOString() });
            saveData();
            updateCustomerOptions();
            customerChoices.setChoiceByValue(newId.toString());
            closeAddCustomerModal();
            Swal.fire('Thành công', 'Khách hàng mới đã được thêm.', 'success');
        }
        // Cập nhật danh sách nhân viên
        function updateEmployeeOptions() {
            const saleEmployee = document.getElementById('saleEmployee');
            const warrantyEmployee = document.getElementById('warrantyEmployee');
            if (saleEmployee) {
                saleEmployee.innerHTML = employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
                saleEmployee.value = currentUser.id; // Mặc định chọn nhân viên đang đăng nhập
            }
            if (warrantyEmployee) {
                warrantyEmployee.innerHTML = employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
                warrantyEmployee.value = currentUser.id; // Mặc định chọn nhân viên đang đăng nhập
            }
        }
        // Cập nhật select nhân viên cho báo cáo
        function updateEmployeeOptionsForReport() {
            const reportEmployee = document.getElementById('reportEmployee');
            if (reportEmployee) {
                reportEmployee.innerHTML = '<option value="">Tất cả</option>' + employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
            }
        }
        // Cập nhật options sản phẩm cho quản lý kho
        function updateInventoryOptions() {
            const inventoryProduct = document.getElementById('inventoryProduct');
            if (!inventoryProduct) return;
            inventoryProduct.innerHTML = products.map(prod => `<option value="${prod.id}">${prod.name}</option>`).join('');
        }
        // Cập nhật bảng lịch sử tồn kho
        function updateInventoryTable() {
            const inventoryTable = document.getElementById('inventoryTable');
            if (!inventoryTable) return;
            inventoryTable.innerHTML = stockHistory.filter(entry => entry.reason === 'Nhập kho' || entry.reason === 'Bán hàng').map(entry => {
                const product = products.find(p => p.id === entry.productId);
                return `
                    <tr data-created="${entry.date}">
                        <td class="border p-2">${entry.date}</td>
                        <td class="border p-2">${product ? product.name : ''}</td>
                        <td class="border p-2">${entry.quantityChange > 0 ? '+' + entry.quantityChange : entry.quantityChange}</td>
                        <td class="border p-2">${entry.reason || 'Không có'}</td>
                    </tr>
                `;
            }).join('');
            document.getElementById('inventorySummary').textContent = stockHistory.filter(entry => entry.reason === 'Nhập kho' || entry.reason === 'Bán hàng').length;
        }
        // Thêm nhập kho
        function addInventoryEntry() {
            const inventoryProduct = document.getElementById('inventoryProduct');
            const inventoryQuantity = document.getElementById('inventoryQuantity');
            const inventoryReason = document.getElementById('inventoryReason');
            if (!inventoryProduct || !inventoryQuantity) return;
            const productId = parseInt(inventoryProduct.value);
            const quantity = parseInt(inventoryQuantity.value);
            const reason = inventoryReason.value.trim();
            if (!productId || quantity <= 0) return Swal.fire('Lỗi', 'Vui lòng chọn sản phẩm và nhập số lượng > 0.', 'error');
            const product = products.find(p => p.id === productId);
            if (!product) return;
            product.stockQuantity += quantity;
            stockHistory.push({
                id: stockHistory.length + 1,
                productId,
                date: new Date().toISOString().split('T')[0],
                quantityChange: quantity,
                reason
            });
            saveData();
            updateUI();
            resetInventoryForm();
            Swal.fire('Thành công', 'Đã nhập kho thành công.', 'success');
        }
        // Reset form quản lý kho
        function resetInventoryForm() {
            document.getElementById('inventoryProduct').value = '';
            document.getElementById('inventoryQuantity').value = '';
            document.getElementById('inventoryReason').value = '';
        }
        // Cập nhật bảng sản phẩm và hóa đơn
        function updateTables() {
            const productTable = document.getElementById('productTable');
            if (productTable) {
                let totalProducts = 0;
                let totalValue = 0;
                productTable.innerHTML = products.map(prod => {
                    const sup = suppliers.find(s => s.id === prod.supplierId);
                    const attributesSummary = Object.entries(prod.attributes || {}).map(([key, value]) => `${key}: ${value}`).join(', ');
                    const additionalCostsSummary = prod.additionalCosts.filter(cost => cost.description && cost.cost > 0).map(cost => `${cost.description}: ${cost.cost}`).join(', ');
                    const stockText = prod.stockQuantity > 0 ? prod.stockQuantity : 'Hết hàng';
                    const sellButton = prod.stockQuantity > 0 ? `<button class="bg-green-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="addToCart(${prod.id}); showTab('sales');">Bán</button>` : '';
                    totalProducts++;
                    totalValue += prod.stockQuantity * prod.costPrice;
                    return `
                        <tr data-id="${prod.id}" data-created="${prod.createdAt || new Date().toISOString()}">
                            <td class="border p-1"><input type="checkbox" class="productCheckbox" onchange="updateSelectedCount()"></td>
                            <td class="border p-1"><img src="${prod.image || ''}" alt="Image" class="w-10 h-10 object-cover" style="display: ${prod.image ? 'block' : 'none'};"></td>
                            <td class="border p-1">${prod.serialNumber}</td>
                            <td class="border p-1">${prod.name}</td>
                            <td class="border p-1">${attributesSummary}</td>
                            <td class="border p-1">${prod.condition}</td>
                            <td class="border p-1">${prod.barcode}</td>
                            <td class="border p-1">${prod.trackingCode}</td>
                            <td class="border p-1">${prod.webPrice.toFixed(2)}</td>
                            <td class="border p-1">${prod.shippingCost.toFixed(2)}</td>
                            <td class="border p-1">${additionalCostsSummary}</td>
                            <td class="border p-1">${prod.costPrice.toFixed(2)}</td>
                            <td class="border p-1">${prod.sellingPrice.toFixed(2)}</td>
                            <td class="border p-1">${sup ? sup.name : ''}</td>
                            <td class="border p-1">${prod.warrantyPeriod}</td>
                            <td class="border p-1">${stockText}</td>
                            <td class="border p-1">
                                <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="editProduct(${prod.id})">Sửa</button>
                                <button class="bg-red-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="deleteProduct(${prod.id})">Xóa</button>
                                ${sellButton}
                            </td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('productSummary').textContent = totalProducts;
                document.getElementById('productValueSummary').textContent = totalValue.toFixed(2) + ' VNĐ';
            }
            const saleTable = document.getElementById('saleTable');
            if (saleTable) {
                updateSaleTable();
            }
        }
        // Khởi tạo Choices.js cho tìm kiếm sản phẩm
        let productSearchChoices;
        function initProductSearchChoices() {
            const productSearchSelect = document.getElementById('productSearch');
            if (!productSearchSelect) return;
            productSearchChoices = new Choices(productSearchSelect, {
                searchEnabled: true,
                searchPlaceholderValue: 'Gõ để tìm kiếm tên sản phẩm',
                placeholderValue: 'Chọn sản phẩm',
                shouldSort: false,
                itemSelectText: '',
                choices: products.filter(prod => prod.stockQuantity > 0).map(prod => ({ value: prod.id.toString(), label: `${prod.name} - Mã vạch: ${prod.barcode}` }))
            });
            productSearchSelect.addEventListener('addItem', function(event) {
                addToCart(parseInt(event.detail.value));
                productSearchChoices.clearInput();
            });
        }
        // Thêm sản phẩm vào giỏ hàng
        let saleItems = [];
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            if (product.stockQuantity <= 0) return Swal.fire('Lỗi', 'Sản phẩm hết hàng.', 'error');
            const existingItem = saleItems.find(item => item.productId === productId);
            if (existingItem) {
                if (product.stockQuantity < existingItem.quantity + 1) return Swal.fire('Lỗi', 'Số lượng tồn kho không đủ.', 'error');
                existingItem.quantity += 1;
            } else {
                saleItems.push({ productId, quantity: 1, warrantyMonths: product.warrantyPeriod, discount: 0 });
            }
            updateCartTable();
        }
        // Cập nhật bảng giỏ hàng
        function updateCartTable() {
            const cartTableBody = document.getElementById('cartTableBody');
            if (!cartTableBody) return;
            cartTableBody.innerHTML = '';
            let total = 0;
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            saleItems.forEach((item, index) => {
                const product = products.find(p => p.id === item.productId);
                if (!product) return;
                const category = categories.find(cat => cat.id === product.categoryId);
                const attributes = category ? Object.entries(category.details).map(([k, v]) => `${k}: ${v}`).join(', ') : '';
                let subtotal = product.sellingPrice * item.quantity;
                subtotal -= subtotal * (item.discount / 100);
                total += subtotal;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100';
                row.innerHTML = `
                    <td class="border p-2"><img src="${product.image || ''}" alt="Image" class="w-10 h-10 object-cover" style="display: ${product.image ? 'block' : 'none'};"></td>
                    <td class="border p-2">${product.name}</td>
                    <td class="border p-2">${attributes}</td>
                    <td class="border p-2">
                        <input type="number" min="1" value="${item.warrantyMonths}" class="border p-1 w-16 rounded" onchange="updateItemWarranty(${index}, this.value)">
                    </td>
                    <td class="border p-2">
                        <input type="number" min="1" max="${product.stockQuantity}" value="${item.quantity}" class="border p-1 w-16 rounded" onchange="updateItemQuantity(${index}, this.value)">
                    </td>
                    <td class="border p-2">
                        <input type="number" min="0" max="100" value="${item.discount}" class="border p-1 w-16 rounded" onchange="updateItemDiscount(${index}, this.value)">
                    </td>
                    <td class="border p-2">${subtotal.toFixed(2)}</td>
                    <td class="border p-2">
                        <button class="bg-red-500 text-white px-2 py-1 rounded text-sm" onclick="removeFromCart(${index})">Xóa</button>
                    </td>
                `;
                cartTableBody.appendChild(row);
            });
            total -= total * (globalDiscount / 100);
            document.getElementById('cartTotal').textContent = `Tổng: ${total.toFixed(2)} VNĐ`;
        }
        // Cập nhật số lượng item trong giỏ
        function updateItemQuantity(index, value) {
            const quantity = parseInt(value);
            if (quantity < 1) return;
            const item = saleItems[index];
            const product = products.find(p => p.id === item.productId);
            if (product.stockQuantity < quantity) {
                Swal.fire('Lỗi', 'Số lượng tồn kho không đủ.', 'error');
                return;
            }
            item.quantity = quantity;
            updateCartTable();
        }
        // Cập nhật bảo hành item trong giỏ
        function updateItemWarranty(index, value) {
            const months = parseInt(value);
            if (months < 0) return;
            saleItems[index].warrantyMonths = months;
            updateCartTable();
        }
        // Cập nhật giảm giá item trong giỏ
        function updateItemDiscount(index, value) {
            const discount = parseFloat(value);
            if (discount < 0 || discount > 100) return;
            saleItems[index].discount = discount;
            updateCartTable();
        }
        // Xóa item khỏi giỏ
        function removeFromCart(index) {
            Swal.fire({
                title: 'Xác nhận',
                text: 'Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Có',
                cancelButtonText: 'Không'
            }).then((result) => {
                if (result.isConfirmed) {
                    saleItems.splice(index, 1);
                    updateCartTable();
                }
            });
        }
        // Toggle input số tiền trả
        function togglePaidInput() {
            const payment = document.getElementById('paymentMethod').value;
            const paidDiv = document.getElementById('paidAmountDiv');
            if (payment === 'trả nợ') {
                paidDiv.classList.remove('hidden');
            } else {
                paidDiv.classList.add('hidden');
            }
        }
        // Tạo hóa đơn
        function createSale() {
            const saleCustomer = document.getElementById('saleCustomer');
            const saleEmployee = document.getElementById('saleEmployee');
            const paymentMethod = document.getElementById('paymentMethod');
            const promotion = document.getElementById('promotion');
            const paidAmountInput = document.getElementById('paidAmount');
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            const saleNote = document.getElementById('saleNote').value.trim();
            if (!saleCustomer || !saleEmployee || !paymentMethod || !promotion) return;
            const customerId = parseInt(saleCustomer.value);
            const employeeId = parseInt(saleEmployee.value);
            const payment = paymentMethod.value;
            const promo = promotion.value.trim();
            let paidAmount = 0;
            if (payment === 'trả nợ') {
                paidAmount = parseFloat(paidAmountInput.value) || 0;
            }
            if (!customerId) return Swal.fire('Lỗi', 'Vui lòng chọn khách hàng.', 'error');
            if (saleItems.length === 0) return Swal.fire('Lỗi', 'Vui lòng thêm ít nhất một sản phẩm vào giỏ hàng.', 'error');
            const saleDate = new Date().toISOString().split('T')[0];
            let totalAmount = 0;
            saleItems.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    let subtotal = product.sellingPrice * item.quantity;
                    subtotal -= subtotal * (item.discount / 100);
                    totalAmount += subtotal;
                    product.stockQuantity -= item.quantity;
                    stockHistory.push({
                        id: stockHistory.length + 1,
                        productId: item.productId,
                        date: saleDate,
                        quantityChange: -item.quantity,
                        reason: 'Bán hàng'
                    });
                }
            });
            totalAmount -= totalAmount * (globalDiscount / 100);
            const debt = (payment === 'trả nợ') ? totalAmount - paidAmount : 0;
            const saleId = sales.length + 1;
            sales.push({ id: saleId, saleDate, customerId, employeeId, totalAmount, paymentMethod: payment, promotion: promo, debt, note: saleNote, createdAt: new Date().toISOString() });
            saleDetails.push(...saleItems.map(item => ({
                id: saleDetails.length + 1,
                saleId,
                productId: item.productId,
                quantity: item.quantity,
                sellingPriceAtSale: products.find(p => p.id === item.productId).sellingPrice,
                warrantyPeriod: item.warrantyMonths,
                discount: item.discount
            })));
            saleItems = [];
            updateCartTable();
            saveData();
            updateUI();
            showInvoiceModal(saleId);
            Swal.fire('Thành công', 'Hóa đơn đã được tạo thành công!', 'success');
        }
        // Reset form bán hàng
        function resetSaleForm() {
            if (customerChoices) customerChoices.setChoiceByValue('');
            document.getElementById('saleEmployee').value = currentUser.id; // Mặc định theo nhân viên đang đăng nhập
            document.getElementById('paymentMethod').value = 'tiền mặt';
            document.getElementById('promotion').value = '';
            document.getElementById('globalDiscount').value = '0';
            document.getElementById('saleNote').value = '';
            saleItems = [];
            updateCartTable();
            document.getElementById('customerPhoneDisplay').textContent = '';
            document.getElementById('customerAddressDisplay').textContent = '';
            togglePaidInput();
            const createButton = document.getElementById('createSaleButton');
            if (createButton) {
                createButton.textContent = 'Tạo hóa đơn';
                createButton.onclick = createSale;
            }
        }
        // Cập nhật bảng hóa đơn
        function updateSaleTable() {
            const saleTable = document.getElementById('saleTable');
            if (!saleTable) return;
            let totalSales = 0;
            let totalRevenue = 0;
            saleTable.innerHTML = sales.map(sale => {
                const cust = customers.find(c => c.id === sale.customerId) || { name: 'N/A', address: 'N/A' };
                const emp = employees.find(e => e.id === sale.employeeId) || { name: 'N/A' };
                const itemCount = saleDetails.filter(d => d.saleId === sale.id).reduce((sum, d) => sum + d.quantity, 0);
                const attributesSummary = saleDetails.filter(d => d.saleId === sale.id).map(d => {
                    const product = products.find(p => p.id === d.productId) || { categoryId: null };
                    const category = categories.find(cat => cat.id === product.categoryId) || { details: {} };
                    return Object.entries(category.details).map(([k, v]) => `${k}: ${v}`).join(', ');
                }).join('; ');
                const status = sale.debt > 0 ? 'Nợ' : 'Đã thanh toán';
                totalSales++;
                totalRevenue += sale.totalAmount;
                return `
                    <tr data-created="${sale.saleDate}">
                        <td class="border p-2">${sale.saleDate}</td>
                        <td class="border p-2">${cust.name}</td>
                        <td class="border p-2">${cust.address}</td>
                        <td class="border p-2">${emp.name}</td>
                        <td class="border p-2">${itemCount}</td>
                        <td class="border p-2 text-xs">${attributesSummary}</td>
                        <td class="border p-2">${sale.totalAmount.toFixed(2)}</td>
                        <td class="border p-2">${status}</td>
                        <td class="border p-2">
                            <button class="bg-blue-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="showInvoiceModal(${sale.id})">Xem</button>
                            <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="editSale(${sale.id})">Sửa</button>
                            <button class="bg-red-500 text-white px-2 py-1 rounded text-sm" onclick="deleteSale(${sale.id})">Hủy/Trả hàng</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('saleSummary').textContent = totalSales;
            document.getElementById('saleRevenueSummary').textContent = totalRevenue.toFixed(2) + ' VNĐ';
            filterSalesTable();
        }
        // Lọc bảng hóa đơn
        function filterSalesTable() {
            const fromDate = document.getElementById('filterFromDate').value;
            const toDate = document.getElementById('filterToDate').value;
            const paymentFilter = document.getElementById('filterPayment').value;
            const debtStatus = document.getElementById('filterDebtStatus').value;
            const searchTerm = document.getElementById('searchSale').value.toLowerCase();
            const table = document.getElementById('saleTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            rows.forEach((row, index) => {
                if (index === 0) return; // Skip header
                const cells = row.cells;
                const date = cells[0].textContent;
                const payment = sales.find(s => s.saleDate === date)?.paymentMethod || '';
                const debt = sales.find(s => s.saleDate === date)?.debt > 0 ? 'debt' : 'paid';
                const text = row.textContent.toLowerCase();
                let show = true;
                if (fromDate && date < fromDate) show = false;
                if (toDate && date > toDate) show = false;
                if (paymentFilter && payment !== paymentFilter) show = false;
                if (debtStatus && debt !== debtStatus) show = false;
                if (searchTerm && !text.includes(searchTerm)) show = false;
                row.style.display = show ? '' : 'none';
            });
            currentPages['saleTable'] = 1;
            paginateTable('saleTable');
        }
        // Cập nhật ngày lọc cho báo cáo hóa đơn
        function updateSaleDateFilters() {
            const period = document.getElementById('saleReportPeriod').value;
            const fromInput = document.getElementById('filterFromDate');
            const toInput = document.getElementById('filterToDate');
            const today = new Date(currentDate);
            let fromDate, toDate;
            if (period === 'today') {
                fromDate = today.toISOString().split('T')[0];
                toDate = fromDate;
            } else if (period === 'thisWeek') {
                const firstDay = new Date(today);
                firstDay.setDate(today.getDate() - today.getDay() + 1); // Thứ 2 tuần này
                fromDate = firstDay.toISOString().split('T')[0];
                toDate = today.toISOString().split('T')[0];
            } else if (period === 'thisMonth') {
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                fromDate = firstDay.toISOString().split('T')[0];
                toDate = today.toISOString().split('T')[0];
            } else if (period === 'thisYear') {
                const firstDay = new Date(today.getFullYear(), 0, 1);
                fromDate = firstDay.toISOString().split('T')[0];
                toDate = today.toISOString().split('T')[0];
            } else if (period === 'custom') {
                return;
            }
            fromInput.value = fromDate;
            toInput.value = toDate;
            filterSalesTable();
        }
        // Xem hóa đơn
        function viewSale(id) {
            showInvoiceModal(id);
        }
        // Sửa hóa đơn
        function editSale(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;
            if (customerChoices) customerChoices.setChoiceByValue(sale.customerId.toString());
            document.getElementById('saleEmployee').value = sale.employeeId;
            document.getElementById('paymentMethod').value = sale.paymentMethod;
            document.getElementById('promotion').value = sale.promotion;
            document.getElementById('saleNote').value = sale.note || '';
            displayCustomerDetails();
            const details = saleDetails.filter(d => d.saleId === id);
            saleItems = details.map(d => ({ productId: d.productId, quantity: d.quantity, warrantyMonths: d.warrantyPeriod, discount: d.discount || 0 }));
            updateCartTable();
            const createButton = document.getElementById('createSaleButton');
            if (createButton) {
                createButton.textContent = 'Cập nhật hóa đơn';
                createButton.onclick = () => updateSale(id);
            }
            if (sale.paymentMethod === 'trả nợ') {
                document.getElementById('paidAmount').value = (sale.totalAmount - sale.debt).toFixed(2);
            }
            togglePaidInput();
        }
        // Cập nhật hóa đơn
        function updateSale(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;
            const customerId = parseInt(document.getElementById('saleCustomer').value);
            const employeeId = parseInt(document.getElementById('saleEmployee').value);
            const payment = document.getElementById('paymentMethod').value;
            const promo = document.getElementById('promotion').value.trim();
            const paidAmountInput = document.getElementById('paidAmount');
            const globalDiscount = parseFloat(document.getElementById('globalDiscount').value) || 0;
            const saleNote = document.getElementById('saleNote').value.trim();
            let paidAmount = 0;
            if (payment === 'trả nợ') {
                paidAmount = parseFloat(paidAmountInput.value) || 0;
            }
            if (!customerId) return Swal.fire('Lỗi', 'Vui lòng chọn khách hàng.', 'error');
            if (saleItems.length === 0) return Swal.fire('Lỗi', 'Vui lòng thêm ít nhất một sản phẩm vào giỏ hàng.', 'error');
            // Hoàn tồn kho cũ
            const oldDetails = saleDetails.filter(d => d.saleId === id);
            oldDetails.forEach(detail => {
                const product = products.find(p => p.id === detail.productId);
                if (product) product.stockQuantity += detail.quantity;
                stockHistory.push({
                    id: stockHistory.length + 1,
                    productId: detail.productId,
                    date: new Date().toISOString().split('T')[0],
                    quantityChange: detail.quantity,
                    reason: 'Sửa hóa đơn'
                });
            });
            // Trừ tồn kho mới
            let totalAmount = 0;
            let error = false;
            saleItems.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    if (product.stockQuantity < item.quantity) {
                        error = true;
                        Swal.fire('Lỗi', 'Số lượng tồn kho không đủ cho sản phẩm ' + product.name, 'error');
                        return;
                    }
                    let subtotal = product.sellingPrice * item.quantity;
                    subtotal -= subtotal * (item.discount / 100);
                    totalAmount += subtotal;
                    product.stockQuantity -= item.quantity;
                    stockHistory.push({
                        id: stockHistory.length + 1,
                        productId: item.productId,
                        date: new Date().toISOString().split('T')[0],
                        quantityChange: -item.quantity,
                        reason: 'Sửa hóa đơn'
                    });
                }
            });
            if (error) return;
            totalAmount -= totalAmount * (globalDiscount / 100);
            const debt = (payment === 'trả nợ') ? totalAmount - paidAmount : 0;
            sale.customerId = customerId;
            sale.employeeId = employeeId;
            sale.totalAmount = totalAmount;
            sale.paymentMethod = payment;
            sale.promotion = promo;
            sale.debt = debt;
            sale.note = saleNote;
            sale.createdAt = new Date().toISOString();
            saleDetails = saleDetails.filter(d => d.saleId !== id);
            saleDetails.push(...saleItems.map(item => ({
                id: saleDetails.length + 1,
                saleId: id,
                productId: item.productId,
                quantity: item.quantity,
                sellingPriceAtSale: products.find(p => p.id === item.productId).sellingPrice,
                warrantyPeriod: item.warrantyMonths,
                discount: item.discount
            })));
            saleItems = [];
            updateCartTable();
            saveData();
            updateUI();
            showInvoiceModal(id);
            const createButton = document.getElementById('createSaleButton');
            if (createButton) {
                createButton.textContent = 'Tạo hóa đơn';
                createButton.onclick = createSale;
            }
            Swal.fire('Thành công', 'Hóa đơn đã được cập nhật thành công!', 'success');
        }
        // Hủy/Trả hàng hóa đơn
        function deleteSale(id) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: 'Bạn có chắc chắn muốn hủy/trả hàng hóa đơn này? Tồn kho sẽ được hoàn lại.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, hủy!',
                cancelButtonText: 'Không'
            }).then((result) => {
                if (result.isConfirmed) {
                    const details = saleDetails.filter(d => d.saleId === id);
                    details.forEach(detail => {
                        const product = products.find(p => p.id === detail.productId);
                        if (product) product.stockQuantity += detail.quantity;
                        stockHistory.push({
                            id: stockHistory.length + 1,
                            productId: detail.productId,
                            date: new Date().toISOString().split('T')[0],
                            quantityChange: detail.quantity,
                            reason: 'Hủy/Trả hàng hóa đơn'
                        });
                    });
                    sales = sales.filter(s => s.id !== id);
                    saleDetails = saleDetails.filter(d => d.saleId !== id);
                    warrantyRecords = warrantyRecords.filter(w => !details.some(d => d.id === w.saleDetailId));
                    saveData();
                    updateUI();
                    closeInvoiceModal();
                    Swal.fire('Đã hủy', 'Hóa đơn đã được hủy/trả hàng.', 'success');
                }
            });
        }
        // Hiển thị modal hóa đơn
        function showInvoiceModal(saleId, isQuote = false) {
            const sale = isQuote ? {
                saleDate: new Date().toISOString().split('T')[0],
                customerId: parseInt(document.getElementById('saleCustomer').value),
                employeeId: currentUser.id,
                totalAmount: parseFloat(document.getElementById('cartTotal').textContent.replace('Tổng: ', '').replace(' VNĐ', '')),
                promotion: document.getElementById('promotion').value.trim(),
                note: document.getElementById('saleNote').value.trim(),
                debt: 0
            } : sales.find(s => s.id === saleId);
            if (!sale) {
                Swal.fire('Lỗi', 'Không tìm thấy hóa đơn.', 'error');
                return;
            }
            const cust = customers.find(c => c.id === sale.customerId) || { name: 'N/A', address: 'N/A', phone: 'N/A' };
            const emp = employees.find(e => e.id === sale.employeeId) || { name: 'N/A' };
            const details = isQuote ? saleItems : saleDetails.filter(d => d.saleId === saleId);
            if (details.length === 0) {
                Swal.fire('Lỗi', 'Không có chi tiết hóa đơn.', 'error');
                return;
            }
            const isA5 = companyInfo.invoiceSize === 'a5';
            const invoiceNumber = `HD${sale.saleDate.replace(/-/g, '')}-${saleId.toString().padStart(3, '0')}`;
            const formattedContent = companyInfo.transferContentFormat.replace('[invoice_number]', invoiceNumber);
            let invoiceHtml = `
                <div class="${isA5 ? 'text-xs' : 'text-sm'} p-2 ${isA5 ? 'max-w-[14.8cm]' : 'max-w-[21cm]'} mx-auto bg-white" style="font-family: 'DejaVu Sans', sans-serif;">
                    <div class="flex items-start mb-2">
                        <img src="${companyInfo.logo || ''}" alt="Logo" class="w-20 h-20 mr-4" style="display: ${companyInfo.logo ? 'block' : 'none'};">
                        <div>
                            <h3 class="font-bold text-${isA5 ? 'md' : 'xl'}">${companyInfo.name || 'Công ty ABC'}</h3>
                            <p>Địa chỉ: ${companyInfo.address || 'N/A'}</p>
                            <p>Điện thoại: ${companyInfo.phone || 'N/A'} | Email: ${companyInfo.email || 'N/A'}</p>
                            <p>Mã số thuế: ${companyInfo.taxCode || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="text-center mb-2">
                        <h3 class="font-bold text-${isA5 ? 'lg' : 'xl'}">${isQuote ? 'BÁO GIÁ' : companyInfo.invoiceTitle || 'HÓA ĐƠN BÁN HÀNG'}</h3>
                        <p>Số hóa đơn: ${invoiceNumber}</p>
                        <p>Ngày: ${sale.saleDate}</p>
                        <p>${companyInfo.showEmployeeName ? `Nhân viên: ${emp.name}` : ''}</p>
                    </div>
                    <div class="mb-2">
                        <h4 class="font-semibold">Thông tin khách hàng:</h4>
                        <p>Tên: ${cust.name}</p>
                        <p>Địa chỉ: ${cust.address}</p>
                        <p>Điện thoại: ${cust.phone}</p>
                    </div>
                    <table class="w-full border-collapse border mb-2 text-xs">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="border p-1 text-left">Tên hàng hóa</th>
                                <th class="border p-1 text-left">Thuộc tính</th>
                                <th class="border p-1 text-left">SL</th>
                                <th class="border p-1 text-left">Đơn giá</th>
                                <th class="border p-1 text-left">GG (%)</th>
                                <th class="border p-1 text-left">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            details.forEach(detail => {
                const product = products.find(p => p.id === detail.productId);
                const category = categories.find(cat => cat.id === product.categoryId);
                const attributesSummary = category ? Object.entries(category.details).map(([k, v]) => `${k}: ${v}`).join(', ') : 'N/A';
                const warrantyEnd = new Date(sale.saleDate);
                warrantyEnd.setMonth(warrantyEnd.getMonth() + detail.warrantyPeriod);
                let subtotal = detail.sellingPriceAtSale * detail.quantity;
                subtotal -= subtotal * (detail.discount / 100);
                invoiceHtml += `
                    <tr>
                        <td class="border p-1">${product.name}</td>
                        <td class="border p-1">${attributesSummary}</td>
                        <td class="border p-1">${detail.quantity}</td>
                        <td class="border p-1">${detail.sellingPriceAtSale.toFixed(0)}</td>
                        <td class="border p-1">${detail.discount || 0}</td>
                        <td class="border p-1">${subtotal.toFixed(0)}</td>
                    </tr>
                    <tr>
                        <td class="border p-1 italic text-gray-600" colspan="6">Bảo hành: ${detail.warrantyPeriod} tháng, Hết hạn: ${warrantyEnd.toISOString().split('T')[0]}</td>
                    </tr>
                `;
            });
            const vat = companyInfo.enableVat ? sale.totalAmount * 0.1 : 0;
            const totalWithVat = sale.totalAmount + vat;
            const debt = sale.debt || 0;
            invoiceHtml += `
                        </tbody>
                    </table>
                    <div class="mb-2">
                        <p>Tổng cộng (chưa VAT): ${sale.totalAmount.toFixed(0)} VNĐ</p>
                        ${companyInfo.enableVat ? `<p>VAT (10%): ${vat.toFixed(0)} VNĐ</p>` : ''}
                        <p class="font-bold">Tổng cộng${companyInfo.enableVat ? ' (bao gồm VAT)' : ''}: ${totalWithVat.toFixed(0)} VNĐ</p>
                        <p>Nợ: ${debt.toFixed(0)} VNĐ</p>
                        <p class="italic">Số tiền bằng chữ: ${numberToWords(totalWithVat)}</p>
                        <p>Ghi chú: ${sale.note || companyInfo.defaultInvoiceNote || 'N/A'}</p>
                    </div>
            `;
            if (companyInfo.showBankInfo) {
                invoiceHtml += `
                    <div class="mb-2">
                        <h4 class="font-semibold">Thông tin chuyển khoản:</h4>
                        <p>Ngân hàng: ${companyInfo.bank || 'N/A'}</p>
                        <p>Số tài khoản: ${companyInfo.accountNumber || 'N/A'}</p>
                        <p>Chủ tài khoản: ${companyInfo.accountHolder || 'N/A'}</p>
                        <p>Nội dung: ${formattedContent}</p>
                    </div>
                `;
            }
            if (companyInfo.showPaymentQR) {
                try {
                    const qrText = `Ngân hàng: ${companyInfo.bank || 'N/A'} | STK: ${companyInfo.accountNumber || 'N/A'} | Chủ TK: ${companyInfo.accountHolder || 'N/A'} | Số tiền: ${totalWithVat.toFixed(0)} | Nội dung: ${formattedContent}`;
                    const qrCanvas = document.createElement('canvas');
                    QRCode.toCanvas(qrCanvas, qrText, { width: 100, errorCorrectionLevel: 'H' }, function (error) {
                        if (error) {
                            console.error('QR Code generation error:', error);
                            invoiceHtml += `<div class="mb-2 text-center"><p class="text-red-500">Không thể tạo mã QR</p></div>`;
                        } else {
                            invoiceHtml += `
                                <div class="mb-2 text-center">
                                    <h4 class="font-semibold">QR Thanh toán</h4>
                                    <img src="${qrCanvas.toDataURL()}" alt="QR Payment" class="mx-auto">
                                </div>
                            `;
                        }
                        // Update modal content after QR code generation
                        document.getElementById('invoiceContent').innerHTML = invoiceHtml;
                        document.getElementById('invoiceModal').classList.remove('hidden');
                    });
                } catch (error) {
                    console.error('Error generating QR code:', error);
                    invoiceHtml += `<div class="mb-2 text-center"><p class="text-red-500">Không thể tạo mã QR</p></div>`;
                    document.getElementById('invoiceContent').innerHTML = invoiceHtml;
                    document.getElementById('invoiceModal').classList.remove('hidden');
                }
            } else {
                document.getElementById('invoiceContent').innerHTML = invoiceHtml;
                document.getElementById('invoiceModal').classList.remove('hidden');
            }
            invoiceHtml += `
                    <div class="mb-2">
                        <h4 class="font-semibold">Ghi chú:</h4>
                        <p>- Hóa đơn được lập thành 2 bản, mỗi bên giữ 1 bản.</p>
                        <p>- Thanh toán bằng chuyển khoản hoặc tiền mặt trong vòng 7 ngày kể từ ngày lập hóa đơn.</p>
                    </div>
                    <div class="flex justify-between">
                        <div>
                            <h4 class="font-semibold">Người lập hóa đơn</h4>
                            <p>(Ký, ghi rõ họ tên)</p>
                            <p class="mt-4">___________________</p>
                            <p>${companyInfo.signature || ''}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold">Khách hàng</h4>
                            <p>(Ký, ghi rõ họ tên)</p>
                            <p class="mt-4">___________________</p>
                        </div>
                    </div>
                </div>
            `;
        }
        // Đóng modal hóa đơn
        function closeInvoiceModal() {
            document.getElementById('invoiceModal').classList.add('hidden');
        }
        // Xuất PDF từ modal
        function exportToPDFModal() {
            const element = document.getElementById('invoiceContent');
            if (!element) return;
            const opt = {
                margin: 0.5,
                filename: 'hoa_don.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: companyInfo.invoiceSize, orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
        // In từ modal
        function printInvoiceModal() {
            const element = document.getElementById('invoiceContent');
            if (!element) return;
            const printWindow = window.open('', '', 'height=500, width=800');
            printWindow.document.write('<html><head><title>In hóa đơn</title>');
            printWindow.document.write('<style>body { font-family: sans-serif; font-size: 12px; } table { border-collapse: collapse; } th, td { border: 1px solid black; padding: 4px; }</style>');
            printWindow.document.write('</head><body >');
            printWindow.document.write(element.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        // Gửi email hóa đơn
        function sendInvoiceEmail() {
            const invoiceContent = document.getElementById('invoiceContent').innerHTML;
            const custEmail = prompt('Nhập email khách hàng:');
            if (!custEmail) return;
            emailjs.init("YOUR_EMAILJS_USER_ID"); // Thay bằng user ID của bạn
            emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
                to_email: custEmail,
                message: invoiceContent
            }).then(() => {
                Swal.fire('Thành công', 'Email đã được gửi.', 'success');
            }, (error) => {
                Swal.fire('Lỗi', 'Không thể gửi email: ' + JSON.stringify(error), 'error');
            });
        }
        // Hàm chuyển số thành chữ
        function numberToWords(num) {
            if (num === 0) return 'không đồng';
            const units = ['', 'nghìn', 'triệu', 'tỷ'];
            const ones = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            const teens = ['mười', 'mười một', 'mười hai', 'mười ba', 'mười bốn', 'mười lăm', 'mười sáu', 'mười bảy', 'mười tám', 'mười chín'];
            const tens = ['', '', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
            function readThreeDigits(n) {
                let result = '';
                const hundred = Math.floor(n / 100);
                const ten = n % 100;
                if (hundred > 0) result += ones[hundred] + ' trăm ';
                if (ten > 0) {
                    if (ten < 10) result += 'linh ' + ones[ten];
                    else if (ten < 20) result += teens[ten - 10];
                    else result += tens[Math.floor(ten / 10)] + ' ' + (ten % 10 > 0 ? ones[ten % 10] : '');
                }
                return result.trim();
            }
            let result = '';
            let unitIndex = 0;
            while (num > 0) {
                const part = num % 1000;
                if (part > 0) {
                    result = readThreeDigits(part) + (unitIndex > 0 ? ' ' + units[unitIndex] : '') + ' ' +result;
                }
                num = Math.floor(num / 1000);
                unitIndex++;
            }
            return result.trim() + ' đồng';
        }
        // Cập nhật ngày lọc dựa trên khoảng thời gian
        function updateDateFilters() {
            const period = document.getElementById('reportPeriod').value;
            const fromInput = document.getElementById('reportFromDate');
            const toInput = document.getElementById('reportToDate');
            const today = new Date(currentDate);
            let fromDate, toDate;
            if (period === 'today') {
                fromDate = today.toISOString().split('T')[0];
                toDate = fromDate;
            } else if (period === 'thisWeek') {
                const firstDay = new Date(today);
                firstDay.setDate(today.getDate() - today.getDay() + 1); // Thứ 2 tuần này
                fromDate = firstDay.toISOString().split('T')[0];
                toDate = today.toISOString().split('T')[0];
            } else if (period === 'thisMonth') {
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                fromDate = firstDay.toISOString().split('T')[0];
                toDate = today.toISOString().split('T')[0];
            } else if (period === 'thisYear') {
                const firstDay = new Date(today.getFullYear(), 0, 1);
                fromDate = firstDay.toISOString().split('T')[0];
                toDate = today.toISOString().split('T')[0];
            } else if (period === 'custom') {
                // Giữ nguyên giá trị hiện tại
                return;
            }
            fromInput.value = fromDate;
            toInput.value = toDate;
            saveReportFilters();
        }
        // Lưu bộ lọc báo cáo vào localStorage
        function saveReportFilters() {
            localStorage.setItem('reportPeriod', document.getElementById('reportPeriod').value);
            localStorage.setItem('reportFromDate', document.getElementById('reportFromDate').value);
            localStorage.setItem('reportToDate', document.getElementById('reportToDate').value);
            localStorage.setItem('reportEmployee', document.getElementById('reportEmployee').value);
        }
        // Tải bộ lọc báo cáo từ localStorage
        function loadReportFilters() {
            const period = localStorage.getItem('reportPeriod');
            const fromDate = localStorage.getItem('reportFromDate');
            const toDate = localStorage.getItem('reportToDate');
            const employee = localStorage.getItem('reportEmployee');
            if (period) document.getElementById('reportPeriod').value = period;
            if (fromDate) document.getElementById('reportFromDate').value = fromDate;
            if (toDate) document.getElementById('reportToDate').value = toDate;
            if (employee) document.getElementById('reportEmployee').value = employee;
            updateDateFilters();
        }
        // Tạo báo cáo
        function generateReports() {
            const fromDate = document.getElementById('reportFromDate').value || '1900-01-01';
            const toDate = document.getElementById('reportToDate').value || new Date().toISOString().split('T')[0];
            const employeeFilter = document.getElementById('reportEmployee').value;
            const filteredSales = sales.filter(sale => {
                let match = sale.saleDate >= fromDate && sale.saleDate <= toDate;
                if (employeeFilter) match &= sale.employeeId == employeeFilter;
                return match;
            });
            // Doanh thu theo ngày
            const dailyRevenue = {};
            filteredSales.forEach(sale => {
                dailyRevenue[sale.saleDate] = (dailyRevenue[sale.saleDate] || 0) + sale.totalAmount;
            });
            const dailyLabels = Object.keys(dailyRevenue).sort();
            const dailyValues = dailyLabels.map(date => dailyRevenue[date]);
            const dailyRevenueCtx = document.getElementById('dailyRevenueChart').getContext('2d');
            new Chart(dailyRevenueCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Doanh thu theo ngày',
                        data: dailyValues,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
            // Doanh thu theo tháng
            const monthlyRevenue = {};
            filteredSales.forEach(sale => {
                const month = sale.saleDate.slice(0, 7);
                monthlyRevenue[month] = (monthlyRevenue[month] || 0) + sale.totalAmount;
            });
            const monthlyLabels = Object.keys(monthlyRevenue).sort();
            const monthlyValues = monthlyLabels.map(month => monthlyRevenue[month]);
            const monthlyRevenueCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
            new Chart(monthlyRevenueCtx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Doanh thu theo tháng',
                        data: monthlyValues,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        fill: true
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            // Doanh thu theo nhân viên
            const revenueByEmployee = {};
            filteredSales.forEach(sale => {
                const emp = employees.find(e => e.id === sale.employeeId);
                const empName = emp ? emp.name : 'Không xác định';
                if (!revenueByEmployee[empName]) {
                    revenueByEmployee[empName] = { revenue: 0, sold: 0, warranties: 0, unfinished: 0, empId: sale.employeeId };
                }
                revenueByEmployee[empName].revenue += sale.totalAmount;
                const details = saleDetails.filter(d => d.saleId === sale.id);
                details.forEach(d => {
                    revenueByEmployee[empName].sold += d.quantity;
                });
            });
            const filteredWarrantiesCompleted = warrantyRecords.filter(w => w.date >= fromDate && w.date <= toDate && w.status === 'completed');
            filteredWarrantiesCompleted.forEach(w => {
                const emp = employees.find(e => e.id === w.employeeId);
                const empName = emp ? emp.name : 'Không xác định';
                if (!revenueByEmployee[empName]) {
                    revenueByEmployee[empName] = { revenue: 0, sold: 0, warranties: 0, unfinished: 0, empId: w.employeeId };
                }
                revenueByEmployee[empName].warranties += 1;
            });
            const filteredWarrantiesUnfinished = warrantyRecords.filter(w => w.date >= fromDate && w.date <= toDate && w.status !== 'completed');
            filteredWarrantiesUnfinished.forEach(w => {
                const emp = employees.find(e => e.id === w.employeeId);
                const empName = emp ? emp.name : 'Không xác định';
                if (!revenueByEmployee[empName]) {
                    revenueByEmployee[empName] = { revenue: 0, sold: 0, warranties: 0, unfinished: 0, empId: w.employeeId };
                }
                revenueByEmployee[empName].unfinished += 1;
            });
            const employeeLabels = Object.keys(revenueByEmployee);
            const employeeValues = employeeLabels.map(name => revenueByEmployee[name].revenue);
            const revenueByEmployeeCtx = document.getElementById('revenueByEmployeeChart').getContext('2d');
            new Chart(revenueByEmployeeCtx, {
                type: 'bar',
                data: {
                    labels: employeeLabels,
                    datasets: [{
                        data: employeeValues,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                    }]
                },
                options: {
                    responsive: true
                }
            });
            const revenueByEmployeeTable = document.getElementById('revenueByEmployeeTable');
            revenueByEmployeeTable.innerHTML = Object.entries(revenueByEmployee).map(([name, data]) => `
                <tr>
                    <td class="border p-2">${name}</td>
                    <td class="border p-2">${data.revenue.toFixed(2)}</td>
                    <td class="border p-2">${data.sold}</td>
                    <td class="border p-2">${data.warranties}</td>
                    <td class="border p-2 ${data.unfinished > 0 ? 'text-red-600 font-bold' : ''}">${data.unfinished}</td>
                    <td class="border p-2">
                        <button class="bg-blue-500 text-white px-2 py-1 rounded text-sm" onclick="showEmployeeSales('${name}')">Chi tiết HĐ</button>
                        <button class="bg-green-500 text-white px-2 py-1 rounded text-sm ml-2" onclick="showEmployeeWarranties('${name}')">Chi tiết BH</button>
                    </td>
                </tr>
            `).join('');
            // Tổng tồn kho
            let totalInventory = 0;
            let totalInventoryValue = 0;
            products.forEach(prod => {
                totalInventory += prod.stockQuantity;
                totalInventoryValue += prod.stockQuantity * prod.costPrice;
            });
            document.getElementById('totalInventory').textContent = totalInventory;
            document.getElementById('totalInventoryValue').textContent = totalInventoryValue.toFixed(2) + ' VNĐ';
            // Công nợ khách hàng
            const debtReportTable = document.getElementById('debtReportTable');
            const debtByCustomer = {};
            filteredSales.filter(s => s.debt > 0).forEach(sale => {
                const cust = customers.find(c => c.id === sale.customerId);
                const custName = cust ? cust.name : 'Không xác định';
                debtByCustomer[custName] = (debtByCustomer[custName] || {debt: 0, invoices: []});
                debtByCustomer[custName].debt += sale.debt;
                debtByCustomer[custName].invoices.push(sale.id);
            });
            debtReportTable.innerHTML = Object.entries(debtByCustomer).map(([name, data]) => `
                <tr>
                    <td class="border p-2">${name}</td>
                    <td class="border p-2">${data.debt.toFixed(2)}</td>
                    <td class="border p-2">${data.invoices.join(', ')}</td>
                </tr>
            `).join('');
            // Thống kê bảo hành
            const warrantyStatsTable = document.getElementById('warrantyStatsTable');
            let activeCount = 0;
            let expiredCount = 0;
            let inProgressCount = 0;
            saleDetails.forEach(detail => {
                const sale = sales.find(s => s.id === detail.saleId);
                const warrantyEnd = new Date(sale.saleDate);
                warrantyEnd.setMonth(warrantyEnd.getMonth() + detail.warrantyPeriod);
                const history = warrantyRecords.filter(w => w.saleDetailId === detail.id);
                const unfinished = history.some(w => w.status !== 'completed');
                if (unfinished) inProgressCount++;
                else if (warrantyEnd > currentDate) activeCount++;
                else expiredCount++;
            });
            warrantyStatsTable.innerHTML = `
                <tr><td class="border p-2">Còn bảo hành</td><td class="border p-2">${activeCount}</td><td class="border p-2"></td></tr>
                <tr><td class="border p-2">Hết bảo hành</td><td class="border p-2">${expiredCount}</td><td class="border p-2"></td></tr>
                <tr><td class="border p-2">Đang sửa chữa</td><td class="border p-2">${inProgressCount}</td><td class="border p-2"><button class="bg-blue-500 text-white px-2 py-1 rounded text-sm" onclick="showInProgressWarrantyDetails()">Chi tiết</button></td></tr>
            `;
            // Thống kê tổng
            let totalRevenue = 0;
            let totalSalesCount = filteredSales.length;
            let totalDebt = 0;
            let totalProfit = 0;
            let totalCost = 0;
            filteredSales.forEach(sale => {
                totalRevenue += sale.totalAmount;
                totalDebt += sale.debt || 0;
                const details = saleDetails.filter(d => d.saleId === sale.id);
                details.forEach(detail => {
                    const product = products.find(p => p.id === detail.productId);
                    if (product) totalCost += product.costPrice * detail.quantity;
                });
            });
            totalProfit = totalRevenue - totalCost;
            document.getElementById('totalRevenue').textContent = `${totalRevenue.toFixed(2)} VNĐ`;
            document.getElementById('totalSales').textContent = totalSalesCount;
            document.getElementById('totalDebt').textContent = `${totalDebt.toFixed(2)} VNĐ`;
            document.getElementById('totalProfit').textContent = `${totalProfit.toFixed(2)} VNĐ`;
            // Khởi tạo chú thích
            const employeeName = employeeFilter ? employees.find(e => e.id == employeeFilter)?.name : 'toàn bộ nhân viên';
            const dateRange = `từ ${fromDate} đến ${toDate}`;
            document.getElementById('revenueChartsNote').textContent = `Biểu đồ doanh thu theo ngày/tháng/nhân viên ${dateRange} của ${employeeName}`;
            document.getElementById('revenueByEmployeeNote').textContent = `Số liệu doanh thu theo nhân viên ${dateRange}`;
            document.getElementById('inventoryNote').textContent = `Hàng tồn kho hiện tại (không phụ thuộc lọc thời gian)`;
            document.getElementById('debtNote').textContent = `Công nợ khách hàng ${dateRange} của ${employeeName}`;
            document.getElementById('warrantyStatsNote').textContent = `Thống kê bảo hành ${dateRange}`;
            document.getElementById('salesStatsNote').textContent = `Thống kê bán hàng ${dateRange} của ${employeeName}`;
        }
        // Nút cập nhật toàn bộ và reload data
        function reloadAndGenerateReports() {
            loadData();
            updateUI();
            generateReports();
        }
        // Hiển thị modal chi tiết hóa đơn nhân viên
        function showEmployeeSales(employeeName) {
            const employee = employees.find(emp => emp.name === employeeName);
            if (!employee) return;
            const filteredSales = sales.filter(sale => sale.employeeId === employee.id);
            const employeeSalesTable = document.getElementById('employeeSalesTable');
            const employeeSalesTitle = document.getElementById('employeeSalesTitle');
            employeeSalesTitle.textContent = `Hóa đơn của nhân viên: ${employeeName}`;
            employeeSalesTable.innerHTML = filteredSales.map(sale => {
                const cust = customers.find(c => c.id === sale.customerId);
                return `
                    <tr>
                        <td class="border p-2">${sale.saleDate}</td>
                        <td class="border p-2">${cust ? cust.name : ''}</td>
                        <td class="border p-2">${sale.totalAmount.toFixed(2)}</td>
                        <td class="border p-2">
                            <button class="bg-blue-500 text-white px-2 py-1 rounded text-sm" onclick="viewSale(${sale.id})">Xem</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('employeeSalesModal').classList.remove('hidden');
        }
        // Đóng modal chi tiết hóa đơn nhân viên
        function closeEmployeeSalesModal() {
            document.getElementById('employeeSalesModal').classList.add('hidden');
        }
        // Hiển thị modal chi tiết bảo hành nhân viên
        function showEmployeeWarranties(employeeName) {
            const employee = employees.find(emp => emp.name === employeeName);
            if (!employee) return;
            const filteredRecords = warrantyRecords.filter(w => w.employeeId === employee.id);
            const employeeWarrantiesTable = document.getElementById('employeeWarrantiesTable');
            const employeeWarrantiesTitle = document.getElementById('employeeWarrantiesTitle');
            employeeWarrantiesTitle.textContent = `Bảo hành của nhân viên: ${employeeName}`;
            employeeWarrantiesTable.innerHTML = filteredRecords.map(record => {
                const detail = saleDetails.find(d => d.id === record.saleDetailId);
                const product = products.find(p => p.id === detail.productId);
                return `
                    <tr>
                        <td class="border p-2">${record.date}</td>
                        <td class="border p-2">${product.name}</td>
                        <td class="border p-2">${record.issue}</td>
                        <td class="border p-2">${record.status}</td>
                        <td class="border p-2">
                            <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm" onclick="editWarrantyRecord(${record.id})">Cập nhật</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('employeeWarrantiesModal').classList.remove('hidden');
        }
        // Đóng modal chi tiết bảo hành nhân viên
        function closeEmployeeWarrantiesModal() {
            document.getElementById('employeeWarrantiesModal').classList.add('hidden');
        }
        // Cập nhật options cho bảo hành (các sản phẩm đã bán)
        function updateWarrantyOptions() {
            const warrantySaleDetail = document.getElementById('warrantySaleDetail');
            if (!warrantySaleDetail) return;
            const options = saleDetails.map(detail => {
                const product = products.find(p => p.id === detail.productId);
                const sale = sales.find(s => s.id === detail.saleId);
                const cust = customers.find(c => c.id === sale.customerId);
                return `<option value="${detail.id}">${product.name} - Khách: ${cust.name} - Hóa đơn: ${sale.id}</option>`;
            }).join('');
            warrantySaleDetail.innerHTML = options;
        }
        // Tải chi tiết sản phẩm bảo hành
        function loadWarrantyProductDetails() {
            const warrantySaleDetail = document.getElementById('warrantySaleDetail');
            const detailId = parseInt(warrantySaleDetail.value);
            const detail = saleDetails.find(d => d.id === detailId);
            if (detail) {
                // Có thể hiển thị thêm info nếu cần
            }
        }
        // Thêm tác vụ bảo hành
        function addWarrantyRecord() {
            const warrantySaleDetail = document.getElementById('warrantySaleDetail');
            const warrantyDate = document.getElementById('warrantyDate');
            const warrantyIssue = document.getElementById('warrantyIssue');
            const warrantyAction = document.getElementById('warrantyAction');
            const warrantyCost = document.getElementById('warrantyCost');
            const warrantyEmployee = document.getElementById('warrantyEmployee');
            const warrantyNote = document.getElementById('warrantyNote');
            const machineCondition = document.getElementById('machineCondition');
            const repairPlan = document.getElementById('repairPlan');
            const estimatedTime = document.getElementById('estimatedTime');
            const delivererPhone = document.getElementById('delivererPhone');
            const delivererName = document.getElementById('delivererName');
            const warrantyStatus = document.getElementById('warrantyStatus');
            const warrantyRecordId = parseInt(document.getElementById('warrantyRecordId').value) || 0;
            const saleDetailId = parseInt(warrantySaleDetail.value);
            const date = warrantyDate.value;
            const issue = warrantyIssue.value.trim();
            const action = warrantyAction.value.trim();
            const cost = parseFloat(warrantyCost.value) || 0;
            const employeeId = parseInt(warrantyEmployee.value);
            const note = warrantyNote.value.trim();
            const condition = machineCondition.value.trim();
            const plan = repairPlan.value.trim();
            const estTime = estimatedTime.value;
            const phone = delivererPhone.value.trim();
            const deliverer = delivererName.value.trim();
            const status = warrantyStatus.value;
            if (!saleDetailId || !date || !issue || !action || !employeeId || !condition || !plan || !estTime) {
                return Swal.fire('Lỗi', 'Vui lòng điền đầy đủ thông tin bắt buộc.', 'error');
            }
            if (warrantyRecordId) {
                const record = warrantyRecords.find(w => w.id === warrantyRecordId);
                if (record) {
                    record.date = date;
                    record.issue = issue;
                    record.action = action;
                    record.cost = cost;
                    record.employeeId = employeeId;
                    record.note = note;
                    record.machineCondition = condition;
                    record.repairPlan = plan;
                    record.estimatedTime = estTime;
                    record.phone = phone;
                    record.deliverer = deliverer;
                    record.status = status;
                }
            } else {
                warrantyRecords.push({
                    id: warrantyRecords.length + 1,
                    saleDetailId,
                    date,
                    issue,
                    action,
                    cost,
                    employeeId,
                    note,
                    machineCondition: condition,
                    repairPlan: plan,
                    estimatedTime: estTime,
                    phone,
                    deliverer,
                    status,
                    createdAt: new Date().toISOString()
                });
            }
            saveData();
            updateUI();
            resetWarrantyForm();
            Swal.fire('Thành công', 'Tác vụ bảo hành đã được thêm/cập nhật.', 'success');
        }
        // Reset form bảo hành
        function resetWarrantyForm() {
            document.getElementById('warrantySaleDetail').value = '';
            document.getElementById('warrantyDate').value = '';
            document.getElementById('warrantyIssue').value = '';
            document.getElementById('warrantyAction').value = '';
            document.getElementById('warrantyCost').value = '';
            document.getElementById('warrantyEmployee').value = currentUser.id; // Mặc định theo nhân viên đang đăng nhập
            document.getElementById('warrantyNote').value = '';
            document.getElementById('machineCondition').value = '';
            document.getElementById('repairPlan').value = '';
            document.getElementById('estimatedTime').value = '';
            document.getElementById('delivererPhone').value = '';
            document.getElementById('delivererName').value = '';
            document.getElementById('warrantyStatus').value = 'received';
            document.getElementById('warrantyRecordId').value = '';
        }
        // Cập nhật bảng bảo hành
        function updateWarrantyTable() {
            const warrantyTable = document.getElementById('warrantyTable');
            if (!warrantyTable) return;
            const warrantyItems = saleDetails.map(detail => {
                const product = products.find(p => p.id === detail.productId);
                const sale = sales.find(s => s.id === detail.saleId);
                const cust = customers.find(c => c.id === sale.customerId);
                const warrantyEnd = new Date(sale.saleDate);
                warrantyEnd.setMonth(warrantyEnd.getMonth() + detail.warrantyPeriod);
                const warrantyEndStr = warrantyEnd.toISOString().split('T')[0];
                const status = warrantyEnd > currentDate ? 'Còn bảo hành' : 'Hết bảo hành';
                const history = warrantyRecords.filter(w => w.saleDetailId === detail.id);
                const historyCount = history.length;
                const unfinished = history.some(w => w.status !== 'completed');
                const statusWithProgress = unfinished ? 'Đang bảo hành' : status;
                const category = categories.find(cat => cat.id === product.categoryId);
                const attributesSummary = category ? Object.entries(category.details).map(([k, v]) => `${k}:${v}`).join(', ') : '';
                const lastRecord = unfinished ? history.sort((a,b) => b.id - a.id)[0] : null;
                return {
                    detailId: detail.id,
                    productName: product.name,
                    attributes: attributesSummary,
                    barcode: product.barcode,
                    customerName: cust.name,
                    saleDate: sale.saleDate,
                    warrantyPeriod: detail.warrantyPeriod,
                    warrantyEnd: warrantyEndStr,
                    status: statusWithProgress,
                    historyCount,
                    unfinished,
                    saleId: detail.saleId,
                    lastRecordId: lastRecord ? lastRecord.id : 0,
                    createdAt: sale.saleDate
                };
            });
            warrantyTable.innerHTML = warrantyItems.map(item => `
                <tr data-created="${item.createdAt}">
                    <td class="border p-2">${item.productName}</td>
                    <td class="border p-2">${item.attributes}</td>
                    <td class="border p-2">${item.barcode}</td>
                    <td class="border p-2">${item.customerName}</td>
                    <td class="border p-2">${item.saleDate}</td>
                    <td class="border p-2">${item.warrantyPeriod} tháng</td>
                    <td class="border p-2">${item.warrantyEnd}</td>
                    <td class="border p-2">${item.status}</td>
                    <td class="border p-2">${item.historyCount}</td>
                    <td class="border p-2">
                        <button class="bg-blue-500 text-white px-1 py-0.5 rounded text-xs mr-1" onclick="showWarrantyHistory(${item.detailId})">Lịch sử</button>
                        <button class="bg-green-500 text-white px-1 py-0.5 rounded text-xs mr-1" onclick="showWarrantyTicketModal(${item.detailId})">Phiếu BH</button>
                        <button class="bg-purple-500 text-white px-1 py-0.5 rounded text-xs mr-1" onclick="showReceiptTicketForItem(${item.detailId})">BB bàn giao</button>
                        <button class="bg-yellow-500 text-white px-1 py-0.5 rounded text-xs mr-1" onclick="editWarrantyRecord(0, ${item.detailId})">Thêm BH</button>
                        ${item.unfinished ? `<button class="bg-orange-500 text-white px-1 py-0.5 rounded text-xs mr-1" onclick="editWarrantyRecord(${item.lastRecordId})">Cập nhật BH</button>` : ''}
                        <button class="bg-indigo-500 text-white px-1 py-0.5 rounded text-xs" onclick="viewSale(${item.saleId})">Xem hóa đơn</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('warrantySummary').textContent = warrantyItems.length;
            updateUnfinishedAlert(warrantyItems.filter(item => item.unfinished).length);
            filterWarrantyTable();
        }
        // Cập nhật cảnh báo chưa xong
        function updateUnfinishedAlert(count) {
            const alert = document.getElementById('unfinishedWarrantyAlert');
            const countSpan = document.getElementById('unfinishedCount');
            countSpan.textContent = count;
            alert.style.display = count > 0 ? 'block' : 'none';
        }
        // Lọc bảng bảo hành
        function filterWarrantyTable() {
            const fromDate = document.getElementById('filterWarrantyFromDate').value;
            const toDate = document.getElementById('filterWarrantyToDate').value;
            const statusFilter = document.getElementById('filterWarrantyStatus').value;
            const searchTerm = document.getElementById('searchWarranty').value.toLowerCase();
            const table = document.getElementById('warrantyTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            rows.forEach((row, index) => {
                if (index === 0) return; // Skip header
                const cells = row.cells;
                const saleDate = cells[4].textContent;
                const status = cells[7].textContent.toLowerCase();
                const text = row.textContent.toLowerCase();
                let show = true;
                if (fromDate && saleDate < fromDate) show = false;
                if (toDate && saleDate > toDate) show = false;
                if (statusFilter && statusFilter !== 'unfinished' && !status.includes(statusFilter)) show = false;
                if (statusFilter === 'unfinished' && !status.includes('đang bảo hành')) show = false;
                if (searchTerm && !text.includes(searchTerm)) show = false;
                row.style.display = show ? '' : 'none';
            });
            currentPages['warrantyTable'] = 1;
            paginateTable('warrantyTable');
        }
        // Lọc các trường hợp chưa xong
        function filterUnfinishedWarranties() {
            document.getElementById('filterWarrantyStatus').value = 'unfinished';
            filterWarrantyTable();
        }
        // Hiển thị lịch sử bảo hành
        function showWarrantyHistory(detailId) {
            const history = warrantyRecords.filter(w => w.saleDetailId === detailId);
            const warrantyHistoryTable = document.getElementById('warrantyHistoryTable');
            warrantyHistoryTable.innerHTML = history.map(record => {
                const emp = employees.find(e => e.id === record.employeeId);
                return `
                    <tr data-created="${record.date}">
                        <td class="border p-2">${record.date}</td>
                        <td class="border p-2">${record.issue}</td>
                        <td class="border p-2">${record.action}</td>
                        <td class="border p-2">${record.cost.toFixed(2)}</td>
                        <td class="border p-2">${emp ? emp.name : ''}</td>
                        <td class="border p-2">${record.note}</td>
                        <td class="border p-2">${record.status}</td>
                        <td class="border p-2">${record.machineCondition}</td>
                        <td class="border p-2">${record.repairPlan}</td>
                        <td class="border p-2">${record.estimatedTime}</td>
                        <td class="border p-2">${record.phone || ''}</td>
                        <td class="border p-2">${record.deliverer || ''}</td>
                        <td class="border p-2">
                            <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm mr-1" onclick="editWarrantyRecord(${record.id})">Sửa</button>
                            <button class="bg-red-500 text-white px-2 py-1 rounded text-sm" onclick="deleteWarrantyRecord(${record.id})">Xóa</button>
                            <button class="bg-green-500 text-white px-2 py-1 rounded text-sm" onclick="showReceiptTicketModal(${record.id})">Biên bản</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('warrantyHistoryModal').classList.remove('hidden');
        }
        // Đóng modal lịch sử bảo hành
        function closeWarrantyHistoryModal() {
            document.getElementById('warrantyHistoryModal').classList.add('hidden');
        }
        // Sửa tác vụ bảo hành
        function editWarrantyRecord(recordId, detailId = 0) {
            if (recordId === 0) {
                document.getElementById('warrantySaleDetail').value = detailId;
                document.getElementById('warrantyStatus').value = 'received';
            } else {
                const record = warrantyRecords.find(w => w.id === recordId);
                if (!record) return;
                document.getElementById('warrantySaleDetail').value = record.saleDetailId;
                document.getElementById('warrantyDate').value = record.date;
                document.getElementById('warrantyIssue').value = record.issue;
                document.getElementById('warrantyAction').value = record.action;
                document.getElementById('warrantyCost').value = record.cost;
                document.getElementById('warrantyEmployee').value = record.employeeId;
                document.getElementById('warrantyNote').value = record.note;
                document.getElementById('machineCondition').value = record.machineCondition;
                document.getElementById('repairPlan').value = record.repairPlan;
                document.getElementById('estimatedTime').value = record.estimatedTime;
                document.getElementById('delivererPhone').value = record.phone || '';
                document.getElementById('delivererName').value = record.deliverer || '';
                document.getElementById('warrantyStatus').value = record.status;
                document.getElementById('warrantyRecordId').value = record.id;
            }
            showTab('warranty');
        }
        // Xóa tác vụ bảo hành
        function deleteWarrantyRecord(id) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: 'Bạn có chắc chắn muốn xóa tác vụ bảo hành này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, xóa!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    warrantyRecords = warrantyRecords.filter(w => w.id !== id);
                    saveData();
                    updateUI();
                    Swal.fire('Đã xóa', 'Tác vụ bảo hành đã được xóa.', 'success');
                }
            });
        }
        // Hiển thị phiếu bảo hành
        function showWarrantyTicketModal(detailId) {
            const detail = saleDetails.find(d => d.id === detailId);
            const sale = sales.find(s => s.id === detail.saleId);
            const product = products.find(p => p.id === detail.productId);
            const cust = customers.find(c => c.id === sale.customerId);
            const category = categories.find(cat => cat.id === product.categoryId);
            const attributesSummary = category ? Object.entries(category.details).map(([k, v]) => `${k}: ${v}`).join(', ') : '';
            const warrantyEnd = new Date(sale.saleDate);
            warrantyEnd.setMonth(warrantyEnd.getMonth() + detail.warrantyPeriod);
            const warrantyEndStr = warrantyEnd.toISOString().split('T')[0];
            const isA5 = companyInfo.invoiceSize === 'a5';
            let ticketHtml = `
                <div class="${isA5 ? 'text-xs' : 'text-sm'} p-2 ${isA5 ? 'max-w-[14.8cm]' : 'max-w-[21cm]'} mx-auto bg-white" style="font-family: 'DejaVu Sans', sans-serif;">
                    <div class="flex items-start mb-2">
                        <img src="${companyInfo.logo}" alt="Logo" class="w-20 h-20 mr-4" style="display: ${companyInfo.logo ? 'block' : 'none'};">
                        <div>
                            <h3 class="font-bold text-${isA5 ? 'md' : 'xl'}">${companyInfo.name}</h3>
                            <p>Địa chỉ: ${companyInfo.address}</p>
                            <p>Điện thoại: ${companyInfo.phone} | Email: ${companyInfo.email}</p>
                        </div>
                    </div>
                    <div class="text-center mb-2">
                        <h3 class="font-bold text-${isA5 ? 'lg' : 'xl'}">PHIẾU BẢO HÀNH</h3>
                        <p>Số phiếu: BH${sale.saleDate.replace(/-/g, '')}-${detail.id.toString().padStart(3, '0')}</p>
                        <p>Ngày bán: ${sale.saleDate}</p>
                    </div>
                    <div class="mb-2">
                        <h4 class="font-semibold">Thông tin khách hàng:</h4>
                        <p>Tên: ${cust?.name || ''}</p>
                        <p>Địa chỉ: ${cust?.address || ''}</p>
                        <p>Điện thoại: ${cust?.phone || ''}</p>
                    </div>
                    <div class="mb-2">
                        <h4 class="font-semibold">Thông tin sản phẩm:</h4>
                        <p>Tên sản phẩm: ${product.name}</p>
                        <p>Thuộc tính: ${attributesSummary}</p>
                        <p>Mã vạch: ${product.barcode}</p>
                        <p>Thời gian bảo hành: ${detail.warrantyPeriod} tháng</p>
                        <p>Hết hạn: ${warrantyEndStr}</p>
                    </div>
                    <div class="mb-2">
                        <h4 class="font-semibold">Điều khoản bảo hành:</h4>
                        <p>${companyInfo.warrantyTerms.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="flex justify-between">
                        <div>
                            <h4 class="font-semibold">Người lập phiếu</h4>
                            <p>(Ký, ghi rõ họ tên)</p>
                            <p class="mt-4">___________________</p>
                            <p>${companyInfo.signature}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold">Khách hàng</h4>
                            <p>(Ký, ghi rõ họ tên)</p>
                            <p class="mt-4">___________________</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('warrantyTicketContent').innerHTML = ticketHtml;
            document.getElementById('warrantyTicketModal').classList.remove('hidden');
        }
        // Đóng modal phiếu bảo hành
        function closeWarrantyTicketModal() {
            document.getElementById('warrantyTicketModal').classList.add('hidden');
        }
        // Xuất PDF phiếu bảo hành
        function exportWarrantyTicketToPDF() {
            const element = document.getElementById('warrantyTicketContent');
            if (!element) return;
            const opt = {
                margin: 0.5,
                filename: 'phieu_bao_hanh.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: companyInfo.invoiceSize, orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
        // In phiếu bảo hành
        function printWarrantyTicket() {
            const element = document.getElementById('warrantyTicketContent');
            if (!element) return;
            const printWindow = window.open('', '', 'height=500, width=800');
            printWindow.document.write('<html><head><title>In phiếu bảo hành</title>');
            printWindow.document.write('<style>body { font-family: sans-serif; font-size: 12px; } table { border-collapse: collapse; } th, td { border: 1px solid black; padding: 4px; }</style>');
            printWindow.document.write('</head><body >');
            printWindow.document.write(element.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        // Hiển thị biên bản nhận máy cho item
        function showReceiptTicketForItem(detailId) {
            const openRecord = warrantyRecords.find(w => w.saleDetailId === detailId && w.status !== 'completed');
            if (openRecord) {
                showReceiptTicketModal(openRecord.id);
            } else {
                Swal.fire('Thông báo', 'Không có trường hợp bảo hành đang mở.', 'info');
            }
        }
        // Hiển thị biên bản nhận máy
        function showReceiptTicketModal(recordId) {
            const record = warrantyRecords.find(w => w.id === recordId);
            if (!record) return;
            const detail = saleDetails.find(d => d.id === record.saleDetailId);
            const sale = sales.find(s => s.id === detail.saleId);
            const product = products.find(p => p.id === detail.productId);
            const cust = customers.find(c => c.id === sale.customerId);
            const emp = employees.find(e => e.id === record.employeeId);
            const category = categories.find(cat => cat.id === product.categoryId);
            const attributesSummary = category ? Object.entries(category.details).map(([key, value]) => `${key}: ${value}`).join(', ') : '';
            const isA5 = companyInfo.invoiceSize === 'a5';
            let ticketHtml = `
                <div class="${isA5 ? 'text-xs' : 'text-sm'} p-2 ${isA5 ? 'max-w-[14.8cm]' : 'max-w-[21cm]'} mx-auto bg-white" style="font-family: 'DejaVu Sans', sans-serif;">
                    <div class="flex items-start mb-2">
                        <img src="${companyInfo.logo}" alt="Logo" class="w-20 h-20 mr-4" style="display: ${companyInfo.logo ? 'block' : 'none'};">
                        <div>
                            <h3 class="font-bold text-${isA5 ? 'md' : 'xl'}">${companyInfo.name}</h3>
                            <p>Địa chỉ: ${companyInfo.address}</p>
                            <p>Điện thoại: ${companyInfo.phone} | Email: ${companyInfo.email}</p>
                        </div>
                    </div>
                    <div class="text-center mb-2">
                        <h3 class="font-bold text-${isA5 ? 'lg' : 'xl'}">BIÊN BẢN NHẬN MÁY BẢO HÀNH</h3>
                        <p>Số biên bản: BB${record.date.replace(/-/g, '')}-${record.id.toString().padStart(3, '0')}</p>
                        <p>Ngày nhận: ${record.date}</p>
                    </div>
                    <div class="mb-2">
                        <h4 class="font-semibold">Thông tin khách hàng:</h4>
                        <p>Tên: ${cust?.name || ''}</p>
                        <p>Địa chỉ: ${cust?.address || ''}</p>
                        <p>Điện thoại: ${cust?.phone || ''}</p>
                    </div>
                    <div class="mb-2">
                        <h4 class="font-semibold">Thông tin sản phẩm:</h4>
                        <p>Tên sản phẩm: ${product.name}</p>
                        <p>Thuộc tính: ${attributesSummary}</p>
                        <p>Mã vạch: ${product.barcode}</p>
                    </div>
                    <div class="mb-2">
                        <h4 class="font-semibold">Thông tin bảo hành:</h4>
                        <p>Vấn đề: ${record.issue}</p>
                        <p>Tình trạng máy: ${record.machineCondition}</p>
                        <p>Phương án sửa chữa: ${record.repairPlan}</p>
                        <p>Thời gian hẹn: ${record.estimatedTime}</p>
                        <p>Số điện thoại người giao: ${record.phone || ''}</p>
                        <p>Người giao máy: ${record.deliverer || ''}</p>
                        <p>Nhân viên: ${emp.name}</p>
                    </div>
                    <div class="flex justify-between">
                        <div>
                            <h4 class="font-semibold">Nhân viên nhận máy</h4>
                            <p>(Ký, ghi rõ họ tên)</p>
                            <p class="mt-4">___________________</p>
                            <p>${emp.name}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold">Khách hàng</h4>
                            <p>(Ký, ghi rõ họ tên)</p>
                            <p class="mt-4">___________________</p>
                            <p>${cust.name}</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('receiptTicketContent').innerHTML = ticketHtml;
            document.getElementById('receiptTicketModal').classList.remove('hidden');
        }
        // Đóng modal biên bản nhận máy
        function closeReceiptTicketModal() {
            document.getElementById('receiptTicketModal').classList.add('hidden');
        }
        // Xuất PDF biên bản nhận máy
        function exportReceiptTicketToPDF() {
            const element = document.getElementById('receiptTicketContent');
            if (!element) return;
            const opt = {
                margin: 0.5,
                filename: 'bien_ban_nhan_may.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: companyInfo.invoiceSize, orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
        // In biên bản nhận máy
        function printReceiptTicket() {
            const element = document.getElementById('receiptTicketContent');
            if (!element) return;
            const printWindow = window.open('', '', 'height=500, width=800');
            printWindow.document.write('<html><head><title>In biên bản nhận máy</title>');
            printWindow.document.write('<style>body { font-family: sans-serif; font-size: 12px; } table { border-collapse: collapse; } th, td { border: 1px solid black; padding: 4px; }</style>');
            printWindow.document.write('</head><body >');
            printWindow.document.write(element.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        // Hiển thị modal chi tiết tồn kho
        function showInventoryDetailsModal() {
            const inventoryDetailsTable = document.getElementById('inventoryDetailsTable');
            inventoryDetailsTable.innerHTML = products.map(prod => {
                const value = prod.stockQuantity * prod.costPrice;
                return `
                    <tr>
                        <td class="border p-2">${prod.name}</td>
                        <td class="border p-2">${prod.stockQuantity}</td>
                        <td class="border p-2">${value.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            document.getElementById('inventoryDetailsModal').classList.remove('hidden');
        }
        // Đóng modal chi tiết tồn kho
        function closeInventoryDetailsModal() {
            document.getElementById('inventoryDetailsModal').classList.add('hidden');
        }
        // Hiển thị modal chi tiết đang sửa chữa
        function showInProgressWarrantyDetails() {
            const inProgressItems = saleDetails.filter(detail => {
                const history = warrantyRecords.filter(w => w.saleDetailId === detail.id);
                return history.some(w => w.status !== 'completed');
            }).map(detail => {
                const product = products.find(p => p.id === detail.productId);
                const sale = sales.find(s => s.id === detail.saleId);
                const cust = customers.find(c => c.id === sale.customerId);
                const history = warrantyRecords.filter(w => w.saleDetailId === detail.id);
                const openRecord = history.find(w => w.status !== 'completed');
                return {
                    productName: product.name,
                    customerName: cust.name,
                    receiveDate: openRecord.date,
                    issue: openRecord.issue,
                    detailId: detail.id,
                    recordId: openRecord.id
                };
            });
            const inProgressWarrantyTable = document.getElementById('inProgressWarrantyTable');
            inProgressWarrantyTable.innerHTML = inProgressItems.map(item => `
                <tr>
                    <td class="border p-2">${item.productName}</td>
                    <td class="border p-2">${item.customerName}</td>
                    <td class="border p-2">${item.receiveDate}</td>
                    <td class="border p-2">${item.issue}</td>
                    <td class="border p-2">
                        <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm" onclick="editWarrantyRecord(${item.recordId})">Cập nhật</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('inProgressWarrantyModal').classList.remove('hidden');
        }
        // Đóng modal chi tiết đang sửa chữa
        function closeInProgressWarrantyModal() {
            document.getElementById('inProgressWarrantyModal').classList.add('hidden');
        }
        // Quản lý tab
        function showTab(tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            const tabButtons = document.querySelectorAll('.tab-button');
            tabContents.forEach(tab => tab.classList.add('hidden'));
            const activeTab = document.getElementById(tabId);
            if (activeTab) activeTab.classList.remove('hidden');
            tabButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-300', 'text-gray-800');
            });
            const activeBtn = document.querySelector(`button[onclick="showTab('${tabId}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-300', 'text-gray-800');
                activeBtn.classList.add('bg-blue-500', 'text-white');
            }
            localStorage.setItem('currentTab', tabId);
            if (tabId === 'reports') {
                loadReportFilters();
                generateReports();
            }
            if (tabId === 'warranty') updateWarrantyTable();
            if (tabId === 'barcode') loadBarcodeTab();
        }
        // Hàm thay đổi số dòng mỗi trang
        async function changeRowsPerPage(select, newValue) {
            const tableId = select.dataset.table;
            setRowsPerPage(tableId, parseInt(newValue));
            currentPages[tableId] = 1; // Reset về trang 1
            paginateTable(tableId);
        }
        // Thay đổi size chữ
        function changeFontSize(size) {
            const body = document.body;
            body.classList.remove('text-sm', 'text-base', 'text-lg');
            if (size === 'sm') body.classList.add('text-sm');
            else if (size === 'lg') body.classList.add('text-lg');
            else body.classList.add('text-base');
            localStorage.setItem('fontSize', size);
        }
        // Chọn tất cả checkbox
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.productCheckbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }
        // Xóa sản phẩm được chọn
        function deleteSelectedProducts() {
            const selectedIds = Array.from(document.querySelectorAll('.productCheckbox:checked')).map(checkbox => parseInt(checkbox.closest('tr').dataset.id));
            if (selectedIds.length === 0) return Swal.fire('Lỗi', 'Vui lòng chọn ít nhất một sản phẩm.', 'error');
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: `Bạn có chắc chắn muốn xóa ${selectedIds.length} sản phẩm?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, xóa!',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    products = products.filter(prod => !selectedIds.includes(prod.id));
                    saveData();
                    updateUI();
                    Swal.fire('Đã xóa', 'Sản phẩm đã được xóa.', 'success');
                }
            });
        }
        // Bán sản phẩm được chọn
        function sellSelectedProducts() {
            const selectedIds = Array.from(document.querySelectorAll('.productCheckbox:checked')).map(checkbox => parseInt(checkbox.closest('tr').dataset.id));
            if (selectedIds.length === 0) return Swal.fire('Lỗi', 'Vui lòng chọn ít nhất một sản phẩm.', 'error');
            selectedIds.forEach(id => addToCart(id));
            showTab('sales');
        }
        // Chuẩn bị tab barcode với selected products
        function prepareBarcodeTab() {
            selectedBarcodeProducts = Array.from(document.querySelectorAll('.productCheckbox:checked')).map(checkbox => {
                const id = parseInt(checkbox.closest('tr').dataset.id);
                const product = products.find(p => p.id === id);
                return { id: id, name: product.name, barcode: product.barcode, quantity: 1, price: product.sellingPrice };
            });
            if (selectedBarcodeProducts.length === 0) return Swal.fire('Lỗi', 'Vui lòng chọn ít nhất một sản phẩm.', 'error');
            showTab('barcode');
        }
        // Load tab barcode
        function loadBarcodeTab() {
            const selectedTable = document.getElementById('selectedBarcodeTable');
            selectedTable.innerHTML = selectedBarcodeProducts.map(prod => `
                <tr data-id="${prod.id}">
                    <td class="border p-2">${prod.name}</td>
                    <td class="border p-2">${prod.barcode}</td>
                    <td class="border p-2">
                        <input type="number" min="1" value="${prod.quantity}" class="border p-1 w-16 rounded" onchange="updateBarcodeQuantity(${prod.id}, this.value)">
                    </td>
                    <td class="border p-2">
                        <button class="bg-red-500 text-white px-2 py-1 rounded text-sm" onclick="removeFromBarcodeList(${prod.id})">Xóa</button>
                    </td>
                </tr>
            `).join('');
            const barcodePaperSize = document.getElementById('barcodePaperSize');
            barcodePaperSize.addEventListener('change', function() {
                const customDiv = document.getElementById('customSizeDiv');
                customDiv.classList.toggle('hidden', this.value !== 'custom');
            });
            const barcodesPerPage = document.getElementById('barcodesPerPage');
            barcodesPerPage.addEventListener('change', function() {
                const customLayoutDiv = document.getElementById('customLayoutDiv');
                customLayoutDiv.classList.toggle('hidden', this.value !== 'custom');
            });
            generateBarcodePreview();
        }
        // Thêm sản phẩm vào list barcode
        function addProductToBarcodeList() {
            const productId = prompt('Nhập ID sản phẩm để thêm:');
            const id = parseInt(productId);
            const product = products.find(p => p.id === id);
            if (!product) return Swal.fire('Lỗi', 'Sản phẩm không tồn tại.', 'error');
            selectedBarcodeProducts.push({ id: product.id, name: product.name, barcode: product.barcode, quantity: 1, price: product.sellingPrice });
            loadBarcodeTab();
        }
        // Xóa sản phẩm khỏi list barcode
        function removeFromBarcodeList(id) {
            selectedBarcodeProducts = selectedBarcodeProducts.filter(p => p.id !== id);
            loadBarcodeTab();
        }
        // Tạo preview mã vạch
        function generateBarcodePreview() {
            const previewContainer = document.getElementById('barcodePreviewContainer');
            previewContainer.innerHTML = '';
            const paperSize = document.getElementById('barcodePaperSize').value;
            let width = 210, height = 297; // Default A4 in mm
            if (paperSize === 'custom') {
                width = parseFloat(document.getElementById('customWidth').value) || 210;
                height = parseFloat(document.getElementById('customHeight').value) || 297;
            } else {
                [width, height] = paperSize.split('x').map(size => parseFloat(size));
            }
            const barcodesPerPage = document.getElementById('barcodesPerPage').value;
            let columns = 1, rows = 1;
            if (barcodesPerPage === 'custom') {
                columns = parseInt(document.getElementById('customColumns').value) || 1;
                rows = parseInt(document.getElementById('customRows').value) || 1;
            } else {
                const perPage = parseInt(barcodesPerPage);
                columns = Math.min(perPage, 3); // Ví dụ: max 3 cột
                rows = Math.ceil(perPage / columns);
            }
            const marginTop = parseFloat(document.getElementById('marginTop').value) || 5;
            const marginBottom = parseFloat(document.getElementById('marginBottom').value) || 5;
            const marginLeft = parseFloat(document.getElementById('marginLeft').value) || 5;
            const marginRight = parseFloat(document.getElementById('marginRight').value) || 5;
            // Lấy tùy chọn cho từng phần
            const options = {
                storeName: {
                    show: document.getElementById('showStoreName').checked,
                    size: document.getElementById('storeNameSize').value,
                    bold: document.getElementById('storeNameBold').checked,
                    italic: document.getElementById('storeNameItalic').checked,
                    margin: parseFloat(document.getElementById('storeNameMargin').value) || 1
                },
                productName: {
                    show: document.getElementById('showProductName').checked,
                    size: document.getElementById('productNameSize').value,
                    bold: document.getElementById('productNameBold').checked,
                    italic: document.getElementById('productNameItalic').checked,
                    margin: parseFloat(document.getElementById('productNameMargin').value) || 1
                },
                barcode: {
                    show: document.getElementById('showBarcode').checked,
                    size: document.getElementById('barcodeSize').value,
                    bold: document.getElementById('barcodeBold').checked,
                    italic: document.getElementById('barcodeItalic').checked,
                    margin: parseFloat(document.getElementById('barcodeMargin').value) || 1
                },
                barcodeNumber: {
                    show: document.getElementById('showBarcodeNumber').checked,
                    size: document.getElementById('barcodeNumberSize').value,
                    bold: document.getElementById('barcodeNumberBold').checked,
                    italic: document.getElementById('barcodeNumberItalic').checked,
                    margin: parseFloat(document.getElementById('barcodeNumberMargin').value) || 1
                },
                sellingPrice: {
                    show: document.getElementById('showSellingPrice').checked,
                    size: document.getElementById('sellingPriceSize').value,
                    bold: document.getElementById('sellingPriceBold').checked,
                    italic: document.getElementById('sellingPriceItalic').checked,
                    margin: parseFloat(document.getElementById('sellingPriceMargin').value) || 1
                }
            };
            const pageDiv = document.createElement('div');
            pageDiv.style.width = `${width}mm`;
            pageDiv.style.height = `${height}mm`;
            pageDiv.style.backgroundColor = 'white';
            pageDiv.style.padding = `${marginTop}mm ${marginRight}mm ${marginBottom}mm ${marginLeft}mm`;
            pageDiv.style.display = 'grid';
            pageDiv.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
            pageDiv.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            pageDiv.style.gap = '5mm';
            pageDiv.style.border = '1px solid gray';
            pageDiv.style.marginBottom = '20px'; // Khoảng cách giữa các trang
            let barcodeIndex = 0;
            let totalBarcodes = selectedBarcodeProducts.reduce((sum, prod) => sum + prod.quantity, 0);
            selectedBarcodeProducts.forEach(prod => {
                for (let i = 0; i < prod.quantity; i++) {
                    const barcodeDiv = document.createElement('div');
                    barcodeDiv.style.textAlign = 'center';
                    barcodeDiv.style.padding = '2mm';
                    barcodeDiv.style.display = 'flex';
                    barcodeDiv.style.flexDirection = 'column';
                    barcodeDiv.style.justifyContent = 'center';
                    barcodeDiv.style.alignItems = 'center';
                    barcodeDiv.style.overflow = 'hidden';
                    // Hàm helper để tạo phần text với style
                    function createTextElement(text, optKey) {
                        if (!options[optKey].show) return;
                        const p = document.createElement('p');
                        p.textContent = text;
                        p.style.fontSize = `${options[optKey].size}px`;
                        p.style.fontWeight = options[optKey].bold ? 'bold' : 'normal';
                        p.style.fontStyle = options[optKey].italic ? 'italic' : 'normal';
                        p.style.marginBottom = `${options[optKey].margin}mm`;
                        barcodeDiv.appendChild(p);
                    }
                    createTextElement(companyInfo.name, 'storeName');
                    createTextElement(prod.name, 'productName');
                    if (options.barcode.show) {
                        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        svg.id = `preview-barcode-${barcodeIndex}`;
                        svg.style.width = '2.5cm';
                        svg.style.height = '1.5cm';
                        svg.style.marginBottom = `${options.barcode.margin}mm`;
                        barcodeDiv.appendChild(svg);
                        JsBarcode(svg, prod.barcode, {
                            format: "CODE128",
                            lineColor: "#000",
                            width: 1,
                            height: 40,
                            fontSize: 0,
                            displayValue: false
                        });
                    }
                    if (options.barcodeNumber.show) {
                        createTextElement(prod.barcode, 'barcodeNumber');
                    }
                    if (options.sellingPrice.show) {
                        createTextElement(`Giá: ${prod.price.toFixed(2)} VNĐ`, 'sellingPrice');
                    }
                    pageDiv.appendChild(barcodeDiv);
                    barcodeIndex++;
                    if (barcodeIndex % (columns * rows) === 0 && barcodeIndex < totalBarcodes) {
                        previewContainer.appendChild(pageDiv.cloneNode(true));
                        pageDiv.innerHTML = '';
                    }
                }
            });
            if (pageDiv.innerHTML !== '') {
                previewContainer.appendChild(pageDiv);
            }
        }
        // In mã vạch
        function printBarcodes() {
            const previewContainer = document.getElementById('barcodePreviewContainer');
            const printWindow = window.open('', '', 'height=500, width=800');
            printWindow.document.write('<html><head><title>In mã vạch</title>');
            printWindow.document.write('<style>.page { page-break-after: always; } .barcode { text-align: center; display: flex; flex-direction: column; justify-content: center; alignItems: center; overflow: hidden; } svg { width: 100%; height: auto; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(previewContainer.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        // Reset tùy chọn barcode
        function resetBarcodeOptions() {
            ['showStoreName', 'showProductName', 'showBarcode'].forEach(id => {
                document.getElementById(id).checked = true;
            });
            document.getElementById('showBarcodeNumber').checked = true;
            document.getElementById('showSellingPrice').checked = false;
            ['storeNameSize', 'productNameSize', 'barcodeSize', 'sellingPriceSize'].forEach(id => {
                document.getElementById(id).value = '12';
            });
            document.getElementById('barcodeNumberSize').value = '10';
            ['storeNameBold', 'productNameBold', 'barcodeBold', 'barcodeNumberBold', 'sellingPriceBold',
             'storeNameItalic', 'productNameItalic', 'barcodeItalic', 'barcodeNumberItalic', 'sellingPriceItalic'].forEach(id => {
                document.getElementById(id).checked = false;
            });
            ['storeNameMargin', 'productNameMargin', 'barcodeMargin', 'barcodeNumberMargin', 'sellingPriceMargin'].forEach(id => {
                document.getElementById(id).value = '1';
            });
            generateBarcodePreview();
        }
        // Xuất dữ liệu
        function exportData() {
            const allData = {
                usdExchangeRate,
                parentCategories,
                categories,
                suppliers,
                products,
                customers,
                sales,
                saleDetails,
                employees,
                stockHistory,
                warrantyRecords,
                companyInfo,
                previousAdditionalCosts
            };
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pos_data.json';
            a.click();
            URL.revokeObjectURL(url);
            Swal.fire('Thành công', 'Dữ liệu đã được xuất thành file JSON.', 'success');
        }
        // Nhập dữ liệu
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    usdExchangeRate = importedData.usdExchangeRate || 25000;
                    parentCategories = importedData.parentCategories || [];
                    categories = importedData.categories || [];
                    suppliers = importedData.suppliers || [];
                    products = importedData.products || [];
                    customers = importedData.customers || [];
                    sales = importedData.sales || [];
                    saleDetails = importedData.saleDetails || [];
                    employees = importedData.employees || [];
                    stockHistory = importedData.stockHistory || [];
                    warrantyRecords = importedData.warrantyRecords || [];
                    companyInfo = importedData.companyInfo || {};
                    previousAdditionalCosts = importedData.previousAdditionalCosts || [];
                    saveData(); // Lưu vào localStorage để đồng bộ
                    updateUI(); // Cập nhật giao diện
                    setNextSerialNumber();
                    Swal.fire('Thành công', 'Dữ liệu đã được nhập và khôi phục.', 'success');
                } catch (err) {
                    Swal.fire('Lỗi', 'File không hợp lệ hoặc dữ liệu bị hỏng: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        // Khởi tạo ứng dụng
        window.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            loadData();
            initProductNameChoices();
            initCustomerChoices();
            initProductSearchChoices();
            showTab(localStorage.getItem('currentTab') || 'categories');
            updateWebPriceLabel();
            // ... các khởi tạo khác ...
            togglePaidInput();
            updateCartTable();
            const barcodePaperSize = document.getElementById('barcodePaperSize');
            barcodePaperSize.addEventListener('change', function() {
                const customDiv = document.getElementById('customSizeDiv');
                customDiv.classList.toggle('hidden', this.value !== 'custom');
            });
            const barcodesPerPage = document.getElementById('barcodesPerPage');
            barcodesPerPage.addEventListener('change', function() {
                const customLayoutDiv = document.getElementById('customLayoutDiv');
                customLayoutDiv.classList.toggle('hidden', this.value !== 'custom');
            });
            // Save search on input
            ['searchParentCategory', 'searchNewProduct', 'searchProduct', 'searchSupplier', 'searchCustomer', 'searchEmployee', 'searchInventory', 'searchSale', 'searchWarranty'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.addEventListener('input', saveSearchValues);
            });
            toggleRights(); // Khởi tạo trạng thái quyền
        });
        // Save all states before the application is closed
        window.addEventListener('beforeunload', function() {
            saveSearchValues();
            saveReportFilters();
            localStorage.setItem('fontSize', document.getElementById('fontSizeSelect').value);
            localStorage.setItem('currentTab', document.querySelector('.tab-button.bg-blue-500')?.getAttribute('onclick').match(/'([^']+)'/)[1] || 'categories');
            // Save pagination settings
            Object.entries(rowsPerPageMap).forEach(([tableId, rows]) => {
                localStorage.setItem(`rowsPerPage_${tableId}`, rows);
            });
            Object.entries(currentPages).forEach(([tableId, page]) => {
                localStorage.setItem(`currentPage_${tableId}`, page);
            });
            // Save form states
            saveFormStates();
        });
        function saveFormStates() {
            // Logic lưu form states nếu cần mở rộng
        }
        // Thêm hàm printQuote
        function printQuote() {
            showInvoiceModal(0, true);
        }
    </script>
</body>
</html>
